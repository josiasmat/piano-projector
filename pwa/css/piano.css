/*
Piano Projector
Copyright (C) 2025 Josias Matschulat

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as
published by the Free Software Foundation, either version 3 of the
License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.
*/

/* Import key label font */
@import url('https://fonts.googleapis.com/css2?family=PT+Sans+Narrow:wght@400;700&display=swap');

@import url('markers.css');

:root {
    --color-highlight: #f00;
    --color-white-key: #eee;
    --color-black-key: #222;
    --color-background: black;
    --color-key-light-border: #999;
    --color-key-dark-border: #555;
    --color-white-key-light-border: #999;
    --color-white-key-dark-border:  #555;
    --color-black-key-left-bevel:   color(from #999 srgb r g b / 37%);
    --color-black-key-bottom-bevel: color(from #666 srgb r g b / 37%);
    --color-black-key-right-bevel:  color(from #444 srgb r g b / 37%);
    --color-label-white-key: black;
    --color-label-black-key: white;
    --color-label-white-key-active: white;
    --color-label-black-key-active: white;
    
    --gradient-white-key-top: color-mix(in lch, var(--color-white-key), white 10%);
    --gradient-white-key-bottom: color-mix(in lch, var(--color-white-key), black 8%);
    --gradient-black-key-top: color-mix(in lch, var(--color-black-key), white 12%);
    --gradient-black-key-bottom: color-mix(in lch, var(--color-black-key), black 10%);

    --highlight-transition-duration: 0.05s;
    --unpress-transition-duration: 0.1s;
    --stroke-width: 1.3px;
}

svg#piano {
    min-width: 100%;
    max-height: 100%;
    position: absolute;
    transform-origin: top left;
    
    &.lowperf, *.lowperf { shape-rendering: optimizeSpeed; }

    &:not(.grabbing, touch-input) {
        cursor: grab;
    }

    &.touch-input:not(.grabbing) {
        cursor: pointer;
    }

    &.grabbing {
        cursor: grabbing;
    }

    &.annotation-mode:not(.grabbing) {
        cursor: crosshair !important;
    }

    &.tonic-mode:not(.grabbing) {
        cursor: cell !important;
    }

    .key {
        transform-origin: center top 0px;

        .invisible {
            fill: none;
            stroke: none;
            visibility: hidden;
        }

        .key-touch-area {
            pointer-events: all;
        }

        :not(.key-touch-area), & {
            pointer-events: none;
        }

        &:not(.active) .key-highlight {
            opacity: 0%;
        }

        &:not(.active),
        &.active:not(.pressed) {
            .key-highlight:not(.lowperf, .notransition) {
                transition-property: opacity, d;
                transition-duration: var(--highlight-transition-duration),
                                        var(--unpress-transition-duration);
                transition-timing-function: ease-out, ease-in;
            }
        }

        &.active {
            .key-highlight {
                opacity: 100%;
            }
            &.dim .key-highlight {
                opacity: 55%;
            }
        }
    }

    .white-key {
        .key-fill {
            &.lowperf, &.nogradient { 
                fill: var(--color-white-key); 
            }
            &:not(.lowperf, .nogradient) { 
                fill: url(#white-key-gradient); 
            }
        }
        .key-highlight {
            &.lowperf, &.nogradient {
                fill: var(--color-highlight);
            }
            &:not(.lowperf, .nogradient) {
                fill: url(#pressed-white-key-highlight-gradient);
            }
        }
        &:not(.pressed):not(.lowperf, .notransition) path {
            transition: d var(--unpress-transition-duration) ease-in;
        }
        .white-key-border {
            stroke-width: var(--stroke-width);
            stroke-linecap: square;
            fill: none;
            pointer-events: stroke;
        }
        .key-light-border {
            stroke: color-mix(in srgb, var(--color-white-key-light-border) 70%, var(--color-white-key));
        }        
        .key-dark-border {
            stroke: color-mix(in srgb, var(--color-white-key-dark-border) 70%, var(--color-white-key));
        }
    }
    
    .black-key {
        .key-fill {
            &.lowperf, &.nogradient { 
                fill: var(--color-black-key); 
            }
            &:not(.lowperf, .nogradient) { 
                fill: url(#black-key-gradient); 
            }
        }
        .key-highlight {
            &.lowperf, &.nogradient {
                fill: var(--color-highlight);
            }
            &:not(.lowperf, .nogradient) {
                fill: url(#pressed-black-key-highlight-gradient);
            }
        }
        &:not(.pressed):not(.lowperf, .notransition) path {
            transition: d var(--unpress-transition-duration) ease-in;
        }
        .black-key-bevel {
            pointer-events: fill;
        }
        .key-left-bevel {
            fill: var(--color-black-key-left-bevel);
        }        
        .key-right-bevel {
            fill: var(--color-black-key-right-bevel);
        }        
        .key-bottom-bevel {
            fill: var(--color-black-key-bottom-bevel);
        }
        .key-left-round-bevel {
            fill: color-mix(in srgb, var(--color-black-key-left-bevel), var(--color-black-key-bottom-bevel) 60%);
        }
        .key-right-round-bevel {
            fill: color-mix(in srgb, var(--color-black-key-right-bevel), var(--color-black-key-bottom-bevel) 60%);
        }
    }
    
    /* Key labels */

    .key-annotation-group:not(.lowperf) {
        transform-origin: center center;
        transform-box: content-box;
    }

    .key:not(.pressed) .key-annotation-group:not(.lowperf, .notransition) {
        transition: transform var(--unpress-transition-duration) ease-in;
    }
    
    /* Key labels */

    .key-label {
        font-family: "PT Sans Narrow", "Arial Narrow", var(--sl-font-sans), sans-serif;
        font-weight: 100;
        text-anchor: middle;
        text-rendering: optimizeSpeed;
        white-space: wrap;
        opacity: 0%;
        pointer-events: none;
    }

    &.labeling-mode .key:not(.label-visible):has(.key-touch-area:hover) {
        .key-label {
            display: block ;
            opacity: 30% ;
        }
    }

    .key:not(.label-visible) .key-label { display: none; }

    .key.label-visible .key-label { opacity: 100%; }

    .key.has-temporary-label:not(.label-visible):has(.key-touch-area:not(:hover)) .key-label { 
        fill: lch(from var(--color-highlight) clamp(0, calc(calc(55 - l) * 10000), 100) 0 h / 90%);
        opacity: 0%;
        &:not(.lowperf, .notransition) {
            transition-property: opacity;
            transition-timing-function: ease-in;
            transition-duration: var(--highlight-transition-duration);
        }
    }

    .white-key-label {
        font-size: 36px;
        fill: var(--color-label-white-key);
    }

    .black-key-label {
        font-size: 25px;
        fill: var(--color-label-black-key);
        tspan { text-anchor: middle; }
    }

    .key-label.rotated {
        text-anchor: start;
        transform-box: content-box;
    }

    .white-key.active .key-label {
        fill: var(--color-label-white-key-active);
    }

    .black-key.active .key-label {
        fill: var(--color-label-black-key-active);
    }

    .white-key.has-marker {
        .key-label:not(.rotated) {
            transform: translateY(-11px);
        }
        .key-label.rotated {
            transform-origin: left center;
            transform: translateY(-13px) rotate(-90deg) translateX(-18px) scale(70%);
        }
    }

    .black-key.has-marker {
        .key-label:not(.rotated) {
            transform: translateY(-14px);
        }
        .key-label.rotated {
            transform-origin: center center;
            transform: translateY(-15px) rotate(-90deg) translateX(10px);
        }
    }

    .key:not(.has-marker) .key-label.rotated {
        &.white-key-label {
            transform-origin: left center;
            transform: translateY(-3px) rotate(-90deg) translateX(-18px) scale(70%);
        }
        &.black-key-label {
            transform-origin: center center;
            transform: translateY(-3px) rotate(-90deg) translateX(10px);
        }
    }

    /* Top red felt */

    &[top-felt-hidden] #top-felt {
        display: none;
    }

    #top-felt {
        &.lowperf { 
            fill: var(--color-felt-top); 
        }
        &:not(.lowperf) { 
            fill: url("#top-felt-gradient"); 
        }
    }

    /* Optimize animations */

    .key:not(.lowperf) {
        .key-highlight { will-change: opacity, d; }
        .key-annotation-group { will-change: fill, transform; }
        path:not(.key-highlight) { will-change: d; }
    }

    .key-highlight.lowperf { will-change: opacity; }

}
