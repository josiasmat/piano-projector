(()=>{var Po=Object.create;var zt=Object.defineProperty;var To=Object.getOwnPropertyDescriptor;var Ho=Object.getOwnPropertyNames;var Ko=Object.getPrototypeOf,No=Object.prototype.hasOwnProperty;var Do=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(t,n)=>(typeof require<"u"?require:t)[n]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});var Oo=(e,t,n,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of Ho(t))!No.call(e,i)&&i!==n&&zt(e,i,{get:()=>t[i],enumerable:!(s=To(t,i))||s.enumerable});return e};var $o=(e,t,n)=>(n=e!=null?Po(Ko(e)):{},Oo(t||!e||!e.__esModule?zt(n,"default",{value:e,enumerable:!0}):n,e));var zo=["0","1","2","3","4","5","6","7","8","9"],Cn=zo.concat(["A","a","B","b","C","c","D","d","E","e","F","f"]);function*Ge(e,t,n=t>e?1:-1){if(n>0&&e<t)for(;e<t;)yield e,e+=n;else if(n<0&&e>t)for(;e>t;)yield e,e+=n}function Ne(e,t,n){return e<t?t:e>n?n:e}function qt(e,t){let n=t.indexOf(e)+1;return n==t.length&&(n=0),t[n]}function Rt(e,t=""){return new URLSearchParams(window.parent.location.search).get(e)??t}function Gt(e){return e*(Math.PI/180)}function Vt(e,t={},n=null){let s=e.cloneNode(!0).content.children[0];for(let[i,r]of Object.entries(t))typeof r=="boolean"?s.toggleAttribute(i,r):s.setAttribute(i,r);return n!==null&&(s.children[0].innerText=n),s}function X(){return navigator.userAgentData?navigator.userAgentData.mobile:/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)}function Lt(){return/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}var At=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],St=64,Ct=66,jt=67,qo=123,A={onKeyPress:null,onKeyRelease:null,onPitchClassOn:null,onPitchClassOff:null,onControlChange:null,onSustainPedal:null,onSostenutoPedal:null,onReset:null,onConnectionChange:null,get browserHasMidiSupport(){return!!navigator.requestMIDIAccess},queryMidiAccess(e=null){return this.browserHasMidiSupport?(navigator.permissions.query({name:"midi",sysex:!1}).then(t=>{switch(t.state){case"granted":e?.("granted");break;case"prompt":e?.("prompt");break;default:e?.("denied")}}),!0):(e?.("unavailable"),!1)},requestMidiAccess(e,t=null){if(!this.browserHasMidiSupport){t?.();return}navigator.requestMIDIAccess({sysex:!1}).then(e,t)},requestInputPortList(e,t){if(!this.browserHasMidiSupport){t?.();return}navigator.requestMIDIAccess({sysex:!1}).then(n=>{let s=[];if(n.inputs.size>0)for(let i of n.inputs.values())s.push(i);e(s)},t)},connect(e,t=null,n=At){this.browserHasMidiSupport&&(this.disconnect(),e.open().then(()=>{p.dev=e,e.addEventListener("midimessage",at),t?.(e),this.onConnectionChange?.(!0,e)}),p.channels=Array.from(n))},connectByPortName(e,t=null,n=At){this.browserHasMidiSupport&&this.requestInputPortList(s=>{for(let i of s)i.name==e&&(this.disconnect(),i.open().then(r=>{p.dev=r,r.addEventListener("midimessage",at),t?.(r),this.onConnectionChange?.(!0,r)}),p.channels=Array.from(n))})},connectByPortId(e,t=null,n=At){this.browserHasMidiSupport&&this.requestInputPortList(s=>{for(let i of s)i.id==e&&(this.disconnect(),i.open().then(r=>{p.dev=r,r.addEventListener("midimessage",at),t?.(r),this.onConnectionChange?.(!0,r)}),p.channels=Array.from(n))})},disconnect(){if(!this.browserHasMidiSupport)return;let e=p.dev;e&&(p.dev.removeEventListener("midimessage",at),e.removeEventListener("statechange",Ro),p.dev.close(),p.dev=null,p.channels=[],p.reset(),this.onConnectionChange(!1,e))},getConnectedPort(){return this.browserHasMidiSupport&&p.dev?.state=="connected"?p.dev:null},isKeyPressed(e){return e<0||e>127?!1:p.keys[e]},isNoteOn(e,t="none"){if(e<0||e>127)return!1;switch(t){case"sustain":return this.isKeyPressed(e)||p.sustain[e];case"sostenuto":return this.isKeyPressed(e)||p.sostenuto[e];case"both":return this.isKeyPressed(e)||p.sustain[e]||p.sostenuto[e];default:return this.isKeyPressed(e)}},isPitchClassOn(e,t="none"){for(let n=e;n<128;n+=12)if(this.isNoteOn(n,t))return!0;return!1},getLastControlValue(e){return p.cc[e]},reset(){p.reset()},setPedalThreshold(e){p.pedals.threshold=e},get sustain_pressed(){return p.pedals.sustain},get sostenuto_pressed(){return p.pedals.sostenuto},get soft_pressed(){return p.pedals.soft},get sustain_pedal_value(){return p.cc[St]},get sostenuto_pedal_value(){return p.cc[Ct]},get soft_pedal_value(){return p.cc[jt]}};function Ro(e){e.port.state=="disconnected"&&p.dev==e.port&&(p.dev=null),A.onConnectionChange?.(e.port.state=="connected",e.port)}var p={dev:null,channels:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],cc:Array(128).fill(0),keys:Array(128).fill(null),pcs:Array(12).fill(0),sustain:Array(128).fill(!1),sostenuto:Array(128).fill(!1),pedals:{threshold:64,get sustain(){return p.cc[St]>=this.threshold},get sostenuto(){return p.cc[Ct]>=this.threshold},get soft(){return p.cc[jt]>=this.threshold}},last_event_timestamp:0,last_event_time_delta:0,reset(){this.cc=Array(128).fill(0),this.keys=Array(128).fill(!1),this.pcs=Array(12).fill(0),this.sustain=Array(128).fill(!1),this.sostenuto=Array(128).fill(!1)}};function at(e){p.last_event_time_delta=e.timeStamp-p.last_event_timestamp,p.last_event_timestamp=e.timeStamp;for(let t of p.channels)switch(e.data[0]){case 144+t:Go(e.data[1],e.data[2]);break;case 128+t:Wt(e.data[1],e.data[2]);break;case 176+t:Wo(e.data[1],e.data[2])}}function Go(e,t){let n=e%12;p.keys[e]||(p.keys[e]=Date.now(),p.pcs[n]+=1),p.pedals.sustain&&(p.sustain[e]=!0),A.onKeyPress?.(e,t),p.pcs[n]==1&&A.onPitchClassOn?.(n)}function Wt(e,t){let n=e%12,s=0;p.keys[e]&&(s=Date.now()-p.keys[e],p.keys[e]=null,p.pcs[n]-=1),A.onKeyRelease?.(e,t,s),p.pcs[n]==0&&A.onPitchClassOff?.(n)}function Vo(e){let t=e>=p.pedals.threshold;if(p.pedals.sustain!=t)if(t){for(let n=0;n<128;n++)p.sustain[n]=p.keys[n]||p.sostenuto[n];A.onSustainPedal?.(t,e)}else{for(let n=0;n<128;n++)p.sustain[n]=!1;A.onSustainPedal?.(t,e)}}function jo(e){if(!p.pedals.sostenuto&&e>=p.pedals.threshold){for(let t=0;t<128;t++)p.sostenuto[t]=p.keys[t];A.onSostenutoPedal?.(p.pedals.sostenuto,e)}else if(p.pedals.sostenuto&&e<p.pedals.threshold){for(let t=0;t<128;t++)p.sostenuto[t]=!1;A.onSostenutoPedal?.(p.pedals.sostenuto,e)}}function Wo(e,t){e==Ct&&jo(t),e==St&&Vo(t),e==qo&&Zo(),p.cc[e]=t,A.onControlChange?.(e,t)}function Zo(){for(let e=0;e<128;e++)Wt(e)}function It(e){let n={c:0,"c#":1,db:1,d:2,"d#":3,eb:3,e:4,fb:4,"e#":5,f:5,"f#":6,gb:6,g:7,"g#":8,ab:8,a:9,"a#":10,bb:10,b:11,"b#":12,cb:-1}[e.slice(0,e.length-1).toLowerCase()],s=parseInt(e.slice(e.length-1));return n+12*(s+1)}function Zt(e,t=440){return 2**((e-69)/12)*t}var Mt="http://www.w3.org/2000/svg",Fo={createElement(e,t={}){let n=document.createElementNS(Mt,e);for(let[s,i]of Object.entries(t))n.setAttribute(s,i);return n},createRootElement(e={}){let t=document.createElementNS(Mt,"svg");t.setAttribute("version","1.1"),t.setAttribute("xmlns",Mt);for(let[n,s]of Object.entries(e))t.setAttribute(n,s);return t},createGroup(e={}){return this.createElement("g",e)},makeLine(e,t,n,s,i){let r=this.createElement("line",i);return r.setAttribute("x1",e),r.setAttribute("y1",t),r.setAttribute("x2",n),r.setAttribute("y2",s),r},makeCircle(e,t,n,s={}){let i=this.createElement("circle",s);return i.setAttribute("cx",e),i.setAttribute("cy",t),i.setAttribute("r",n),i},makeRect(e,t,n=null,s=null,i=null,r=null,_={}){let m=this.createElement("rect",_);return m.setAttribute("width",e),m.setAttribute("height",t),n&&m.setAttribute("x",n),s&&m.setAttribute("y",s),i&&m.setAttribute("rx",i),r&&m.setAttribute("ry",r),m},makePolygon(e,t={}){let n=e.length,s=this.createElement("path",t),i=["M",e[0].x,e[0].y];if(n>1){for(let r=1;r<n;r++)e[r]&&i.push("L",e[r].x,e[r].y);n>2&&i.push("Z"),s.setAttribute("d",i.join(" "))}return s},makePath(e,t={},n=null,s=null){let i=this.createElement("path",t);return Array.isArray(e)&&(e=e.filter(r=>r!=null).map(r=>Array.isArray(r)?r.join(" "):r).join(" ")),i.setAttribute("d",e),n!=null&&i.setAttribute("x",n.toString()),s!=null&&i.setAttribute("y",s.toString()),i},makeSimpleArrowMarker(e,t,n={}){let s=this.makePath(["M",0,0,"L",10,5,"L",0,10,"Z"],n),i=this.createElement("marker",{id:e,viewbox:[-5,-5,15,15].join(" "),refX:5,refY:5,markerWidth:t,markerHeight:t,orient:"auto-start-reverse"});return i.appendChild(s),i}},E=Fo;var Xt=500,je=1.3,Ve=1.8,We=2.5,dt=.13,it=1.01,Xo=5,Ft=3,Ze=[,-dt,,+dt,,,-1.4*dt,,0,,1.4*dt];function Qt(e,t,n={}){let s=Xt,i=n.height_factor??1,r=n.first_key??noteToMidi("a0"),_=n.last_key??noteToMidi("c8"),m=_-r,R=(r+_)/2,P=s*i,D=P*(.14*i+.51),y=je/2,G=Ve/2,V=s*2.2/15.5,ee=s*1.4/15.5,te=V/2,me=V/3,ue=ee/2,we=V/15,_e=ee/30,Ie=2,ve=2,he={top:-4,height:7,get bottom(){return this.top+this.height}},xe=he.bottom-1,be=he.bottom-5,j=he.bottom+1,Ee=be+(j-be)/4,d={bottom_height:ee/1.8*(Math.max(i-.5,0)/2+.75),bottom_height1:0,side_width_bottom:Ft*2,side_width_top:Ft,side_width_min:0,side_width_max:0};d.side_width_min=Math.min(d.side_width_top,d.side_width_bottom),d.side_width_max=Math.max(d.side_width_top,d.side_width_bottom),d.bottom_height1=d.bottom_height/2;let Me=P-te*i,ze=Me*it,Le=D-d.bottom_height-me*i,tt=D-d.bottom_height1-me*i,He=V/4/2,qe=He+me*i,ot=qe*.8+d.bottom_height;e.innerHTML="";for(let v=0;v<128;v++)(v<r||v>_)&&(t[v]=null);let Ke=E.createGroup(),I=E.createGroup();function F(v,z,C,u,k,L){let S=C+y+G,T=C+u-y-G,Ae=S+(T-S)/2,ae=k*it,q=D+y+We,ye=q*it,de=v>r&&[2,4,7,9,11].includes(z),b=v<_&&[0,2,5,7,9].includes(z),h=C+y+(de?ue+ee*Ze[z-1]+We:G),ne=C+u-y-(b?ue-ee*Ze[z+1]+We:G),O=u*.015,Re=O*q/k,yt=h+(Ae-h)/u*Re,kt=ne-(ne-Ae)/u*Re,c={ax:h,ay:xe,bx:ne,by:xe,cx:ne,cy:q,dx:T,dy:q,ex:T,ey:k,fx:S,fy:k,gx:S,gy:q,hx:h,hy:q},a={ax:c.ax,ay:c.ay,bx:c.bx,by:c.by,cx:kt,cy:ye,dx:T-Re,dy:ye,ex:T-O,ey:ae,fx:S+O,fy:ae,gx:S+Re,gy:ye,hx:yt,hy:ye},H=L/4,Se=E.createGroup({id:`key${v}`,class:"key white-key",value:v}),wt=E.makePath(["M",c.ax,c.ay,"H",c.bx,b?["V",c.cy,"H",c.dx]:null,"V",c.ey,"H",c.fx,de?["V",c.gy,"H",c.hx]:null,"Z"],{class:"key-touch-area invisible",value:v}),vt=fe(["M",c.ax,c.ay,"H",c.bx,b?["L",c.cx,c.cy,"H",c.dx]:null,"L",c.ex,c.ey-L,"Q",c.ex-H,c.ey-H,c.ex-L,c.ey,"H",c.fx+L,"Q",c.fx+H,c.fy-H,c.fx,c.fy-L,de?["L",c.gx,c.gy,"H",c.hx]:null,"Z"],["M",a.ax,a.ay,"H",a.bx,b?["L",a.cx,a.cy,"H",a.dx]:null,"L",a.ex,a.ey-L,"Q",a.ex-H,a.ey-H,a.ex-L,a.ey,"H",a.fx+L,"Q",a.fx+H,a.fy-H,a.fx,a.fy-L,de?["L",a.gx,a.gy,"H",a.hx]:null,"Z"],{class:"key-fill"}),x=Ie,xt=fe(["M",c.ax+x,c.ay-y,"H",c.bx-x,b?["L",c.cx-x,c.cy+x,"H",c.dx-x]:null,"L",c.ex-x,c.ey-x-L+y,"Q",c.ex-H-x+y,c.ey-H-x,c.ex-L-x+y,c.ey-x,"H",c.fx+x+L-y,"Q",c.fx+H+x,c.fy-x-H+y,c.fx+x,c.fy-x-L+y,de?["L",c.gx+x,c.gy+x,"H",c.hx+x]:null,"Z"],["M",a.ax+x,a.ay-y,"H",a.bx-x,b?["L",a.cx-x,a.cy+x,"H",a.dx-x]:null,"L",a.ex-x,a.ey-x-L+y,"Q",a.ex-H-x+y,a.ey-H-x,a.ex-L-x+y,a.ey-x,"H",a.fx+x+L-y,"Q",a.fx+H+x,a.fy-x-H+y,a.fx+x,a.fy-x-L+y,de?["L",a.gx+x,a.gy+x,"H",a.hx+x]:null,"Z"],{class:"key-highlight"}),nt=fe(["M",c.ax,c.ay+y,de?["L",c.hx,c.hy,"H",c.gx]:null,"L",c.fx,c.fy-L-y,b?["M",c.cx,c.cy,"H",c.dx]:null],["M",a.ax,a.ay+y,de?["L",a.hx,a.hy,"H",a.gx]:null,"L",a.fx,a.fy-L-y,b?["M",a.cx,a.cy,"H",a.dx]:null],{class:"key-light-border white-key-border"}),st=fe(["M",c.fx,c.fy-L,"Q",c.fx+H,c.fy-H,c.fx+L,c.fy,"H",c.ex-L,"Q",c.ex-H,c.ey-H,c.ex,c.ey-L,b?["L",c.dx,c.dy,"M",c.cx,c.cy]:null,"L",c.bx,c.by+y],["M",a.fx,a.fy-L,"Q",a.fx+H,a.fy-H,a.fx+L,a.fy,"H",a.ex-L,"Q",a.ex-H,a.ey-H,a.ex,a.ey-L,b?["L",a.dx,a.dy,"M",a.cx,a.cy]:null,"L",a.bx,a.by+y],{class:"key-dark-border white-key-border"}),Co=se(v,C),Io=C+u/2,Mo=P-qe,Bo=E.makeCircle(Io,Mo,He,{class:"key-sticker white-key-sticker"}),Et=E.createGroup({class:"key-marker-group",press_transform:`translateY(${ze-Me}px)`});return Et.appendChild(Co),Et.appendChild(Bo),Se.appendChild(vt),Se.appendChild(xt),Se.appendChild(st),Se.appendChild(nt),Se.appendChild(Et),Se.appendChild(wt),Se}function $(v){return!n.perspective||Fe(v)?0:(v-R)/((88+m)/4)*d.side_width_max}function W(v,z,C,u,k,L){let S=z,T=S+C,Ae=k/2,ae=k/4,q=$(v)*1.5,ye=q/2,de=q/1.2,b=n.perspective?{left_top:Math.max(0,d.side_width_top+q),left_bottom:Math.max(0,d.side_width_bottom+q),right_top:Math.max(0,d.side_width_top-q),right_bottom:Math.max(0,d.side_width_bottom-q),left_top1:Math.max(0,d.side_width_top+de),left_bottom1:Math.max(0,d.side_width_bottom+ye),right_top1:Math.max(0,d.side_width_top-de),right_bottom1:Math.max(0,d.side_width_bottom-ye)}:{left_top:d.side_width_top,left_bottom:d.side_width_bottom,right_top:d.side_width_top,right_bottom:d.side_width_bottom,left_top1:d.side_width_top,left_bottom1:d.side_width_bottom,right_top1:d.side_width_top,right_bottom1:d.side_width_bottom},h=n.perspective?{left_top:Math.min(S,S+d.side_width_top+q),left_bottom:Math.min(S,S+d.side_width_bottom+q),right_top:Math.max(T,T-d.side_width_top+q),right_bottom:Math.max(T,T-d.side_width_bottom+q),left_top1:Math.min(S,S+d.side_width_top+de),left_bottom1:Math.min(S,S+d.side_width_bottom+ye),right_top1:Math.max(T,T-d.side_width_top+de),right_bottom1:Math.max(T,T-d.side_width_bottom+ye)}:{left_top:S,left_bottom:S,right_top:T,right_bottom:T,left_top1:S,left_bottom1:S,right_top1:T,right_bottom1:T},ne=E.createGroup({id:`key${v}`,class:"key black-key",value:v}),$t=fe(["M",h.left_top,j,"L",h.left_top+b.left_top,be,"H",h.right_top-b.right_top,"L",h.right_top,j,"L",h.right_bottom,u-d.bottom_height-k,"L",T,u,"H",S,"L",h.left_bottom,u-d.bottom_height-k,"Z"],["M",h.left_top1,j,"L",h.left_top1+b.left_top1,Ee,"H",h.right_top1-b.right_top1,"L",h.right_top1,j,"L",h.right_bottom1,u-d.bottom_height1-k,"L",T,u,"H",S,"L",h.left_bottom1,u-d.bottom_height1-k,"Z"],{class:"key-fill key-touch-area"}),O=ve,Re=fe(["M",h.left_top+O,j,"L",Math.max(h.left_top+O,h.left_top+b.left_top),be,"H",Math.min(h.right_top-O,h.right_top-b.right_top),"L",h.right_top-O,j,"L",h.right_bottom-O,u-O-d.bottom_height-Ae,"L",T-O,u-O,"H",S+O,"L",h.left_bottom+O,u-O-d.bottom_height-Ae,"Z"],["M",h.left_top1+O,j,"L",Math.max(h.left_top1+O,h.left_top1+b.left_top1),Ee,"H",Math.min(h.right_top1-O,h.right_top1-b.right_top1),"L",h.right_top1-O,j,"L",h.right_bottom1-O,u-O-d.bottom_height1-Ae,"L",T-O,u-O,"H",S+O,"L",h.left_bottom1+O,u-O-d.bottom_height1-Ae,"Z"],{class:"key-highlight"});if(ne.appendChild($t),ne.appendChild(Re),b.left_bottom>0||b.left_top>0){let st=fe(["M",h.left_top,j,"L",h.left_bottom,u,"L",h.left_bottom+b.left_bottom,u-d.bottom_height-k,"L",h.left_top+b.left_top,be,"Z"],["M",h.left_top1,j,"L",h.left_bottom1,u,"L",h.left_bottom1+b.left_bottom1,u-d.bottom_height1-k,"L",h.left_top1+b.left_top1,Ee,"Z"],{class:"key-left-bevel black-key-bevel"});ne.appendChild(st)}if(b.right_bottom>0||b.right_top>0){let st=fe(["M",h.right_top,j,"L",h.right_bottom,u,"L",h.right_bottom-b.right_bottom,u-d.bottom_height-k,"L",h.right_top-b.right_top,be,"Z"],["M",h.right_top1,j,"L",h.right_bottom1,u,"L",h.right_bottom1-b.right_bottom1,u-d.bottom_height1-k,"L",h.right_top1-b.right_top1,Ee,"Z"],{class:"key-right-bevel black-key-bevel"});ne.appendChild(st)}let yt=fe(["M",S,u,"H",T,"L",h.right_bottom-b.right_bottom-k,u-d.bottom_height,"H",h.left_bottom+b.left_bottom+k,"Z"],["M",S,u,"H",T,"L",h.right_bottom1-b.right_bottom1-k,u-d.bottom_height1,"H",h.left_bottom1+b.left_bottom1+k,"Z"],{class:"key-bottom-bevel black-key-bevel"});ne.appendChild(yt);let kt=fe(["M",S,u,"L",h.left_bottom+b.left_bottom,u-d.bottom_height-k,"Q",h.left_bottom+b.left_bottom+ae,u-d.bottom_height-ae,h.left_bottom+b.left_bottom+k,u-d.bottom_height,"Z"],["M",S,u,"L",h.left_bottom1+b.left_bottom1,u-d.bottom_height1-k,"Q",h.left_bottom1+b.left_bottom1+ae,u-d.bottom_height1-ae,h.left_bottom1+b.left_bottom1+k,u-d.bottom_height1,"Z"],{class:"key-left-round-bevel black-key-bevel"});ne.appendChild(kt);let c=fe(["M",T,u,"L",h.right_bottom-b.right_bottom,u-d.bottom_height-k,"Q",h.right_bottom-b.right_bottom-ae,u-d.bottom_height-ae,h.right_bottom-b.right_bottom-k,u-d.bottom_height,"Z"],["M",T,u,"L",h.right_bottom1-b.right_bottom1,u-d.bottom_height1-k,"Q",h.right_bottom1-b.right_bottom1-ae,u-d.bottom_height1-ae,h.right_bottom1-b.right_bottom1-k,u-d.bottom_height1,"Z"],{class:"key-right-round-bevel black-key-bevel"});ne.appendChild(c);let a=d.bottom_height*.8,H=d.bottom_height1*.8,Se=fe(["M",L-G,u-a,"h",Ve,"v",a,"h",-Ve,"Z"],["M",L-G,u-H,"h",Ve,"v",H,"h",-Ve,"Z"],{class:"gap-reflection"});ne.appendChild(Se);let wt=le(v,z),vt=z+C/2+q,x=D-ot,xt=E.makeCircle(vt,x,He,{class:"key-sticker black-key-sticker"}),nt=E.createGroup({class:"key-marker-group",press_transform:`translateX(${(ye-q)*.7}px) translateY(${tt-Le}px)`});return nt.appendChild(wt),nt.appendChild(xt),ne.appendChild(nt),ne}function se(v,z){let C=z+te,u=E.createElement("text",{x:C,y:Me,id:`keylabel${v}`,class:"key-label white-key-label"});return u.appendChild(E.createElement("tspan",{x:C})),u}function le(v,z){let C=z+ue+$(v)/2,u=E.createElement("text",{x:C,y:Le,id:`keylabel${v}`,class:"key-label black-key-label"});return u.appendChild(E.createElement("tspan",{x:C})),u.appendChild(E.createElement("tspan",{x:C,dy:"-0.9lh"})),u.appendChild(E.createElement("tspan",{x:C,dy:"-1.0lh"})),u}let re=0,ge=0;for(let v=r;v<=_;v++){let z=v%12;if(Fe(z)){let C=F(v,z,ge,V,P,we);Ke.appendChild(C),t[v]=C,re+=V,ge+=V}else{let C=ge-ue+Ze[z]*ee,u=W(v,C,ee,D,_e,ge);I.appendChild(u),t[v]=u}}e.appendChild(Ke),e.appendChild(E.makeRect(re,he.height,0,he.top,null,null,{id:"top-felt"})),e.appendChild(I);let oe={left:-2,top:-4,width:re+je+2,height:P*Math.max(it,1)+je+Xo};e.setAttribute("viewBox",`${oe.left} ${oe.top} ${oe.width} ${oe.height}`);function pe(v,z,C=!1,u={}){let k=E.createElement("linearGradient",C?{id:v,x2:"0%",y2:"100%"}:{id:v});for(let L of z)k.appendChild(E.createElement("stop",L));for(let[L,S]of Object.entries(u))k.setAttribute(L,S);return k}let ce=E.createElement("defs");ce.appendChild(pe("white-key-gradient",[{offset:"30%","stop-color":"color-mix(in oklch, var(--color-white-key), white 10%)"},{offset:"100%","stop-color":"color-mix(in oklch, var(--color-white-key), black 10%)"}],!1,{gradientTransform:"rotate(45)"})),ce.appendChild(pe("black-key-gradient",[{offset:"30%","stop-color":"color-mix(in oklch, var(--color-black-key), white 15%)"},{offset:"100%","stop-color":"color-mix(in oklch, var(--color-black-key), black 15%)"}],!1,{gradientTransform:"rotate(45)"})),ce.appendChild(pe("pressed-white-key-highlight-gradient",[{offset:"0%","stop-color":"var(--color-highlight-alpha)","stop-opacity":"50%"},{offset:"40%","stop-color":"var(--color-highlight-alpha)"}],!0)),ce.appendChild(pe("pressed-black-key-highlight-gradient",[{offset:"0%","stop-color":"var(--color-highlight-alpha)","stop-opacity":"50%"},{offset:"50%","stop-color":"var(--color-highlight-alpha)"}],!0)),ce.appendChild(pe("top-felt-gradient",[{offset:"50%","stop-color":"var(--color-felt-top)"},{offset:"100%","stop-color":"var(--color-felt-bottom)"}],!0)),ce.appendChild(pe("gap-reflection-gradient",[{offset:"0%","stop-color":"var(--color-background)","stop-opacity":"0%"},{offset:"100%","stop-color":"var(--color-background)","stop-opacity":"100%"}],!0)),e.appendChild(ce)}function Yt(e,t,n={}){let s=Xt,i=n.height_factor??1,r=n.first_key??noteToMidi("a0"),_=n.last_key??noteToMidi("c8"),m=s*i,R=m*(.14*i+.51),P=je/2,D=Ve/2,y=s*2.2/15.5,G=s*1.4/15.5,V=y/2,ee=y/3,te=G/2,me=y/17,ue=2,we=2,_e={top:-4,height:7,get bottom(){return this.top+this.height}},Ie=_e.bottom-1,ve=_e.bottom-5,he=m-V*i,xe=R-V*i,j=y/4/2,Ee=j+ee*i,d=Ee;e.innerHTML="";for(let I=0;I<128;I++)(I<r||I>_)&&(t[I]=null);let Me=E.createGroup(),ze=E.createGroup();function Le(I,F,$,W,se,le){let re=$+P+D,ge=$+W-P-D,oe=R+P+We,pe=I>r&&[2,4,7,9,11].includes(F),ce=I<_&&[0,2,5,7,9].includes(F),v=$+P+(pe?te+G*Ze[F-1]+We:D),z=$+W-P-(ce?te-G*Ze[F+1]+We:D),C=E.createGroup({id:`key${I}`,class:"key white-key lowperf",value:I}),u=E.makePath(["M",v,Ie,"H",z,ce?["V",oe,"H",ge]:null,"V",se-le,"L",ge-le,se,"H",re+le,"L",re,se-le,pe?["V",oe,"H",v]:null,"Z"],{class:"key-fill key-touch-area lowperf"}),k=ue,L=E.makePath(["M",v+k,Ie-P,"H",z-k,ce?["V",oe+k,"H",ge-k]:null,"V",se-k-le+P,"L",ge-le-k+P,se-k,"H",re+k+le-P,"L",re+k,se-k-le+P,pe?["V",oe+k,"H",v+k]:null,"Z"],{class:"key-highlight lowperf"}),S=ct(I,$),T=$+W/2,Ae=m-Ee,ae=E.makeCircle(T,Ae,j,{class:"key-sticker white-key-sticker lowperf"}),q=E.createGroup({class:"key-marker-group lowperf"});return q.appendChild(S),q.appendChild(ae),C.appendChild(u),C.appendChild(L),C.appendChild(q),C}function tt(I,F,$,W){let se=F,le=se+$,re=E.createGroup({id:`key${I}`,class:"key black-key lowperf",value:I}),ge=E.makePath(["M",se,ve,"H",le,"V",W,"H",se,"Z"],{class:"key-fill key-touch-area lowperf"}),oe=we,pe=E.makePath(["M",se+oe,ve+oe,"H",le-oe,"V",W-oe,"H",se+oe,"Z"],{class:"key-highlight lowperf"}),ce=He(I,F),v=F+$/2,z=R-d,C=E.makeCircle(v,z,j,{class:"key-sticker black-key-sticker lowperf"}),u=E.createGroup({class:"key-marker-group lowperf"});return u.appendChild(ce),u.appendChild(C),re.appendChild(ge),re.appendChild(pe),re.appendChild(u),re}function ct(I,F){let $=F+V,W=E.createElement("text",{x:$,y:he,id:`keylabel${I}`,class:"key-label white-key-label lowperf"});return W.appendChild(E.createElement("tspan",{x:$})),W}function He(I,F){let $=F+te,W=E.createElement("text",{x:$,y:xe,id:`keylabel${I}`,class:"key-label black-key-label lowperf"});return W.appendChild(E.createElement("tspan",{x:$})),W.appendChild(E.createElement("tspan",{x:$,dy:"-0.9lh"})),W.appendChild(E.createElement("tspan",{x:$,dy:"-1.0lh"})),W}let qe=0,ot=0;for(let I=r;I<=_;I++){let F=I%12;if(Fe(F)){let $=Le(I,F,ot,y,m,me);Me.appendChild($),t[I]=$,qe+=y,ot+=y}else{let $=ot-te+Ze[F]*G,W=tt(I,$,G,R);ze.appendChild(W),t[I]=W}}e.appendChild(Me),e.appendChild(E.makeRect(qe,_e.height,0,_e.top,null,null,{id:"top-felt",class:"lowperf"})),e.appendChild(ze);let Ke={left:-2,top:-4,width:qe+je+2,height:m*it+je+4};e.setAttribute("viewBox",`${Ke.left} ${Ke.top} ${Ke.width} ${Ke.height}`)}function fe(e,t,n={}){let s=E.createElement("path",n);return e=e.filter(i=>i!=null).map(i=>Array.isArray(i)?i.join(" "):i).join(" "),t=t.filter(i=>i!=null).map(i=>Array.isArray(i)?i.join(" "):i).join(" "),s.setAttribute("d0",e),s.setAttribute("d1",t),s}var Qo=[!0,!1,!0,!1,!0,!0,!1,!0,!1,!0,!1,!0];function Fe(e){return Qo[e%12]}var Y={onKeyPress:null,onKeyRelease:null,onSustain:null,onReset:null,get enabled(){return K.enabled},get velocity(){return K.velocity},set velocity(e){e<0&&(e=0),e>127&&(e=127),K.velocity=e},enable(e=null,t=null,n=null,s=null){e&&(this.onKeyPress=e),t&&(this.onKeyRelease=t),n&&(this.onSustain=n),s&&(this.onReset=s),Yo()},disable(){Uo()},isNotePressed(e){return K.pressed_keys.has(e)},isNoteSustained(e){return K.pressed_keys.has(e)||K.sustain_keys.has(e)},isSustainActive(){return K.sustain},resetState(){K.reset(),this.onReset?.()}},K={enabled:!1,pressed_keys:new Set([]),sustain_keys:new Set([]),sustain:!1,velocity:88,map:new Map([["KeyZ",48],["KeyS",49],["KeyX",50],["KeyD",51],["KeyC",52],["KeyV",53],["KeyG",54],["KeyB",55],["KeyH",56],["KeyN",57],["KeyJ",58],["KeyM",59],["KeyW",60],["Digit3",61],["KeyE",62],["Digit4",63],["KeyR",64],["KeyT",65],["Digit6",66],["KeyY",67],["Digit7",68],["KeyU",69],["Digit8",70],["KeyI",71],["KeyO",72],["Digit0",73],["KeyP",74],["KeyQ",59],["Digit1",58],["Comma",60],["KeyL",61],["Period",62],["Semicolon",63],["Slash",64],["IntlRo",65],["Backslash",66],["Minus",75],["BracketLeft",76],["BracketRight",77],["IntlBackslash",47]]),reset(){this.pressed_keys.clear(),this.sustain_keys.clear(),this.sustain=!1}};function Yo(){K.enabled||(K.enabled=!0,window.addEventListener("keydown",Jt),window.addEventListener("keyup",eo))}function Uo(){K.enabled&&(window.removeEventListener("keydown",Jt),window.removeEventListener("keyup",eo),K.enabled=!1,K.reset())}function Jo(e){K.pressed_keys.add(e),K.sustain&&K.sustain_keys.add(e),Y.onKeyPress?.(e,K.velocity)}function en(e){K.pressed_keys.delete(e),Y.onKeyRelease?.(e)}function Ut(e){if(K.sustain!=e){if(K.sustain=e,e)for(let t of K.pressed_keys)K.sustain_keys.add(t);else K.sustain_keys.clear();Y.onSustain(e)}}function Jt(e){if(!(e.ctrlKey||e.altKey)){if(e.code.startsWith("Shift"))e.preventDefault(),Ut(!0);else if(K.map.has(e.code)){if(e.preventDefault(),e.repeat)return;let t=K.map.get(e.code);Jo(t)}}}function eo(e){if(e.code.startsWith("Shift")&&!e.shiftKey&&(e.preventDefault(),Ut(!1)),K.map.has(e.code)){if(e.preventDefault(),e.repeat)return;let t=K.map.get(e.code);en(t)}}var ut=class{#e=null;#o="";constructor(t,n){switch(t){case"local":this.#e=localStorage;break;case"session":this.#e=sessionStorage;break;default:throw Error(`Invalid storage type: "${t}".`)}n!=""&&(this.#o=n+"_"),this.#o.replace(" ","_")}#t(t){return this.#o+t}isAvailable(){try{let t="__storage_test__";return this.#e.setItem(t,t),this.#e.removeItem(t),!0}catch(t){return t instanceof DOMException&&t.name==="QuotaExceededError"&&this.#e&&this.#e.length!==0}}readString(t,n=""){try{if(!this.isAvailable())throw Error();let s=this.#e.getItem(this.#t(t));return s??n}catch{return n}}writeString(t,n){try{if(!this.isAvailable())throw Error();this.#e.setItem(this.#t(t),n)}catch{return!1}return!0}readNumber(t,n=0){let s=this.readString(t,n);return isNaN(s)?n:Number(s)}writeNumber(t,n){return isNaN(n)?!1:this.writeString(t,n.toString())}readBool(t,n=!1){return this.readString(t,n.toString())==="true"}writeBool(t,n){return n!=!0&&n!=!1?!1:this.writeString(t,n.toString())}remove(t){try{if(!this.isAvailable())throw Error();this.#e.removeItem(this.#t(t))}catch{return!1}return!0}has(t){return this.isAvailable()&&this.#e.getItem(this.#t(t))!==null}keys(){let t=[],n=this.#o.length;for(let s=0;s<this.#e.length;s++){let i=this.#e.key(s);i.startsWith(this.#o)&&t.push(i.substring(n))}return t}clear(){for(let t of this.keys())this.remove(t)}},ht=class extends ut{constructor(t){super("local",t)}},pt=class extends ut{constructor(t){super("session",t)}};var Bt=class{#e;#o;#t=[];#n=[];#c=[];#i;#l=!1;#s=!1;get visible(){return this.#s}onshow=void 0;onhide=void 0;onmenuenter=void 0;onoptionenter=void 0;constructor(t,n,s="alt"){this.#e=t,this.#o=n,this.#i=s,this.enable()}enable(){this.#l||(this.#l=!0,window.addEventListener("keydown",t=>this.#d(t)),window.addEventListener("keyup",t=>this.#u(t)),window.addEventListener("blur",()=>this.#h()))}disable(){this.#l&&(window.removeEventListener("keydown",t=>this.#d(t)),window.removeEventListener("keyup",t=>this.#u(t)),window.removeEventListener("blur",()=>this.#h()),this.#l=!1)}replaceStructure(t){this.#o=t,this.#s&&this.#r()}#f(){this.#s==!1&&(this.#s=!0,this.#t=[0],this.onshow?.(),this.#e.hidden=!1,this.#e.focus()),this.#r()}#m(t){this.#t.push(t),this.onmenuenter?.(this.#n[t].text)}#g(){this.#t.length>1&&(this.#t.pop(),this.onmenuenter?.(this.#c.text))}#r(){this.#e.innerHTML="";let t=document.createElement("sl-breadcrumb");this.#e.appendChild(t);let n=this.#o;for(let r of this.#t){let _=document.createElement("sl-breadcrumb-item");_.innerHTML=oo(n[r][0]),n=n[r][1],t.appendChild(_)}this.#n=[];for(let[r,_]of n.entries()){this.#c=this.#n;let m=_[1]===null||_[2]?.noindex?_[0]:`&${r+1}: ${_[0]}`;this.#n.push({html:to(m),text:oo(_[0]),action:Array.isArray(_[1])?r:_[1],keys:_[2]?.key?no(m).concat([_[2].key]):no(m),checkbox:_[2]?Object.hasOwn(_[2],"checked"):!1,checked:_[2]?.checked})}this.#t.length>1&&this.#n.push({html:to("&0: Back"),text:"Back",action:()=>this.#g(),keys:["0"]});let s=this.#n.map(r=>r.checkbox?`<span check-item${r.checked?" checked":""}><span class="checkbox">${r.checked?"\u{1F5F9}":"\u2610"}</span> ${r.html}</span>`:`<span>${r.html}</span>`).join("|"),i=document.createElement("sl-breadcrumb-item");i.innerHTML=s,t.appendChild(i)}#a(){this.#s&&(this.#s=!1,this.#e.hidden=!0,this.onhide?.())}#d(t){if(!t.repeat){if(this.#p(t))t.preventDefault(),this.#f();else if(this.#_(t)){let n=!1,s=t.key.toLowerCase();for(let i of this.#n)i.keys.includes(s)&&i.action!==null&&(n=!0,typeof i.action=="number"?this.#m(i.action):typeof i.action=="function"&&(i.action(),this.onoptionenter?.()));this.#r(),(n||s.length==1)&&t.preventDefault()}}}#u(t){this.#p(t)&&(t.preventDefault(),this.#a())}#h(){this.#s&&this.#a()}#p(t){return t.key.toLowerCase()==this.#i||t.code.toLowerCase().startsWith(this.#i)}#_(t){return[this.#i=="ctrl"&&t.ctrlKey,this.#i=="alt"&&t.altKey,this.#i=="shift"&&t.shiftKey].filter(n=>n).length==1}};function to(e){return e.replace(/&(.)/g,"<u>$1</u>")}function oo(e){return e.replaceAll("&","")}function no(e){return e.match(/(?<=&)./g)?.map(n=>n.toLowerCase())??[]}var so=Bt;var w=new ht("piano-projector"),Ye=new pt("piano-projector-session"),o={first_time:!0,lowperf:!1,number_of_keys:88,height_factor:1,device_name:null,sound:null,offset:{x:.5,y:.5},labels:{type:"english",octave:!0,played:!1,keys:new Set,toggle(e,t=void 0){t=t??!this.keys.has(e),t?this.keys.add(e):this.keys.delete(e),Te(e),M()},keysToStr(){return[...this.keys].join(",")},strToKeys(e){if(this.keys.clear(),e)for(let t of e.split(",")){let n=parseInt(t);Number.isInteger(n)&&this.keys.add(n)}},get type_badge(){return{english:"English",german:"German",italian:"Italian",pc:"Pitch-class",midi:"MIDI",freq:"Frequency"}[this.type]}},stickers:{color:"red",keys:new Map,toggle(e,t=void 0){t=t??!this.keys.has(e),t?this.keys.set(e,this.color):this.keys.delete(e),Te(e),M()},keysToStr(){let e=[];for(let[t,n]of this.keys.entries())e.push(`${t}:${n}`);return e.join(",")},strToKeys(e){if(this.keys.clear(),e)for(let t of e.split(",")){let[n,s]=t.split(":"),i=parseInt(n);Number.isInteger(i)&&this.keys.set(i,s)}}},zoom:1,pedals:!0,pedal_dim:!0,perspective:!0,top_felt:!0,toolbar:!0,semitones:0,octaves:0,get transpose(){return this.semitones+this.octaves*12},get highlight_opacity(){return getComputedStyle(document.documentElement).getPropertyValue("--highlight-opacity")},set highlight_opacity(e){document.documentElement.style.setProperty("--highlight-opacity",e)},get color_highlight(){return getComputedStyle(document.documentElement).getPropertyValue("--color-highlight")},set color_highlight(e){document.documentElement.style.setProperty("--color-highlight",e)},get color_white(){return getComputedStyle(document.documentElement).getPropertyValue("--color-white-key")},set color_white(e){document.documentElement.style.setProperty("--color-white-key",e)},get color_black(){return getComputedStyle(document.documentElement).getPropertyValue("--color-black-key")},set color_black(e){document.documentElement.style.setProperty("--color-black-key",e)},get color_top_felt(){return getComputedStyle(document.documentElement).getPropertyValue("--color-felt-top")},set color_top_felt(e){document.documentElement.style.setProperty("--color-felt-top",e)},get pc_keyboard_connected(){return this.device_name==="pckbd"}},N={ports:[],get menu_items(){return Array.from(l.menus.connect.querySelectorAll(".menu-connect-item-midi-input"))},get connected_port(){return A.getConnectedPort()},access:"unavailable",queryAccess(e=null){A.queryMidiAccess(t=>{this.access=t,e?.(this.access)})},requestAccess(e=null){A.requestMidiAccess(()=>{this.access="granted",e?.(!0)},()=>{this.access="denied",e?.(!1)})},requestPorts(e=null){A.requestInputPortList(t=>{this.ports=t,e?.(t)},()=>{this.ports=null,e?.(null)})},clearMenuItems(){for(let e of this.menu_items)e.remove()},watchdog_id:null,setWatchdog(e){this.watchdog_id&&clearInterval(this.watchdog_id),this.watchdog_id=setInterval(So,e)}},g={type:"",loaded:!1,led:null,audio_ctx:null,player:null,get loading(){return this.type&&!this.loaded},play(e,t=100){this.type=="epiano1"?e+=12:this.type=="harpsi"&&(t=127),this.player?.start({note:e+o.transpose,velocity:t})},stop(e,t){this.type=="epiano1"&&(e+=12),(t||!(A.isNoteOn(e,o.pedals?"both":"none")||Y.isNoteSustained(e))&&!(this.type=="apiano"&&e+o.transpose>88))&&this.player?.stop(e+o.transpose)},stopAll(e){if(e)this.player?.stop();else for(let t=0;t<128;t++)this.stop(t,!1)},fail_alert:document.getElementById("alert-sound-connection-fail"),apiano:null,epiano:null,versilian:null,cache:null},U={state:0,origin:{x:0,y:0},previous_offset:{x:0,y:0}},B={enabled:!1,points:new Map,started(e=null){return e!==null?this.points.has(e):this.points.size>0},has_note(e){for(let t of this.points.values())if(t.has(e))return!0;return!1},add(e,t){this.points.has(e)&&(t=this.points.get(e).union(t)),this.points.set(e,t);for(let n of t.values())g.play(n),Te(n)},change(e,t){let n=0,s=new Set().union(this.points.get(e));this.points.set(e,t);for(let i of s.values())t.has(i)||(g.stop(i),Te(i),n=-1);for(let i of t.values())s.has(i)||(g.play(i),Te(i),n=1);return n},remove(e){let t=this.points.get(e);this.points.delete(e);for(let n of t.values())this.has_note(n)||g.stop(n),Te(n)},reset(){this.points.clear(),g.stopAll()},enable(){this.enabled=!0,f.svg.style.cursor="pointer"},disable(){this.reset(),this.enabled=!1,f.svg.style.removeProperty("cursor")}};var l={self:document.getElementById("top-toolbar"),title:document.getElementById("toolbar-title"),dropdowns:{connect:document.getElementById("dropdown-connect"),sound:document.getElementById("dropdown-sound"),transpose:document.getElementById("dropdown-transpose"),size:document.getElementById("dropdown-size"),colors:document.getElementById("dropdown-colors"),pedals:document.getElementById("dropdown-pedals"),labels:document.getElementById("dropdown-labels"),stickers:document.getElementById("dropdown-stickers"),get all(){return[this.connect,this.sound,this.transpose,this.size,this.colors,this.pedals,this.labels,this.stickers]},closeAll(){for(let e of this.all)e.hide()},getOpen(){return this.all.find(e=>e.open)??null}},buttons:{connect:document.getElementById("btn-connect"),sound:document.getElementById("btn-sound"),transpose:document.getElementById("btn-transpose"),size:document.getElementById("btn-size"),colors:document.getElementById("btn-colors"),pedals:document.getElementById("btn-pedals"),labels_group:document.getElementById("btn-labels-group"),labels_left:document.getElementById("btn-labels-switch"),labels_right:document.getElementById("btn-labels-dropdown"),stickers_group:document.getElementById("btn-labels-group"),stickers_left:document.getElementById("btn-stickers-switch"),stickers_right:document.getElementById("btn-stickers-dropdown"),panic:document.getElementById("btn-panic"),hide_toolbar:document.getElementById("btn-hide-toolbar"),show_toolbar:document.getElementById("btn-show-toolbar")},menus:{connect:document.getElementById("midi-connection-menu"),sound:document.getElementById("menu-sound"),size:document.getElementById("menu-size"),colors:{top:document.getElementById("menu-colors"),highlight_opacity:document.getElementById("menu-highlight-opacity"),picker_color_white:document.getElementById("color-white"),picker_color_black:document.getElementById("color-black"),picker_color_pressed:document.getElementById("color-pressed"),item_perspective:document.getElementById("menu-perspective"),item_top_felt:document.getElementById("menu-top-felt")},labels:{top:document.getElementById("menu-labels-top"),labeling_mode:document.getElementById("menu-labeling-mode"),played:document.getElementById("menu-labels-played-keys"),presets:document.getElementById("menu-labels-which"),type:document.getElementById("menu-labels-type"),octave:document.getElementById("menu-item-labels-octave")},stickers:{top:document.getElementById("menu-stickers-top"),clear:document.getElementById("menu-stickers-clear")},pedals:document.getElementById("pedal-menu")},resize:{observer:null,timeout:null}},io=[{elm:l.title,action:"hide-elm"},{elm:l.buttons.sound,action:"hide-label"},{elm:l.buttons.connect,action:"hide-label"},{elm:l.buttons.pedals,action:"hide-label"},{elm:l.buttons.transpose,action:"hide-label"},{elm:l.buttons.stickers_left,action:"hide-label"},{elm:l.buttons.labels_left,action:"hide-label"},{elm:l.dropdowns.colors,action:"hide-elm"},{elm:l.dropdowns.size,action:"hide-elm"},{elm:l.dropdowns.sound,action:"hide-elm"},{elm:l.dropdowns.pedals,action:"hide-elm"},{elm:l.buttons.stickers_group,action:"hide-elm"},{elm:l.buttons.labels_group,action:"hide-elm"},{elm:l.buttons.panic,action:"hide-elm"},{elm:l.self,action:"hide-elm"}],f={svg:document.querySelector("svg#piano"),container:document.getElementById("main-area"),first_key:null,last_key:null,keys:Array(128).fill(null),labels:Array(128).fill(null),marking_groups:Array(128).fill(null),loaded:!1,resize:{timeout:null,observer:null}},Z=null,tn=["\u208B\u2081","\u2080","\u2081","\u2082","\u2083","\u2084","\u2085","\u2086","\u2087","\u2088","\u2089"],on=["\u207B\xB2","\u207B\xB9","\xB9","\xB2","\xB3","\u2074","\u2075","\u2076","\u2077","\u2078","\u2079","\xB9\u2070"],nn=["\u208B\u2082","\u208B\u2081","\u2081","\u2082","\u2083","\u2084","\u2085","\u2086","\u2087","\u2088","\u2089","\u2081\u2080"],lo=["C","C\u266F","D","D\u266F","E","F","F\u266F","G","G\u266F","A","A\u266F","B"],sn=[,"D\u266D",,"E\u266D",,,"G\u266D",,"A\u266D",,"B\u266D"],ft=["C","Ces","D","Des","E","F","Fes","G","Ges","A","Aes","H"],ro=[,"Dis",,"Eis",,,"Gis",,"Ais",,"B"],co=["do","do\u266F","re","re\u266F","mi","fa","fa\u266F","sol","sol\u266F","la","la\u266F","si"],ln=[,"re\u266D",,"mi\u266D",,,"sol\u266D",,"la\u266D",,"si\u266D"];function ao(e){let t=new Set;switch(e){case"mc":t.add(60);break;case"cs":for(let n of Ge(0,128,12))t.add(n);break;case"white":for(let n of Ge(0,128))Fe(n)&&t.add(n);break;case"all":for(let n of Ge(0,128))t.add(n);break}return t}function uo(){for(let e of["none","mc","cs","white","all"]){let t=ao(e);if(o.labels.keys.symmetricDifference(t).size==0)return e}return"custom"}function lt(){let e=new Map([[88,["a0","c8"]],[61,["c2","c7"]],[49,["c2","c6"]],[37,["c3","c6"]],[25,["c3","c5"]],[20,["f3","c5"]]]).get(o.number_of_keys);f.first_key=It(e[0]),f.last_key=It(e[1]);let t={height_factor:o.height_factor,perspective:o.perspective,top_felt:o.top_felt,first_key:f.first_key,last_key:f.last_key};o.lowperf?Yt(f.svg,f.keys,t):Qt(f.svg,f.keys,t);for(let[n,s]of f.keys.entries())f.marking_groups[n]=s?.querySelector(".key-marker-group"),f.labels[n]=s?.querySelector(".key-label");f.loaded=!0,$e(),Q(),ho()}function ho(){document.getElementById("top-felt").toggleAttribute("hidden",!o.top_felt)}function Te(e){let t=f.keys[e];if(t){let n=e-o.transpose,i=B.has_note(e)||A.isKeyPressed(n)||Y.isNotePressed(n),r=i||A.isNoteOn(n,o.pedals?"both":"none")||Y.isNoteSustained(n);t.classList.toggle("active",r),t.classList.toggle("pressed",i),t.classList.toggle("dim",o.pedal_dim&&r&&!i);let _=i?"d1":"d0";for(let m of t.children)m.hasAttribute(_)&&m.setAttribute("d",m.getAttribute(_));rn(e,r,i)}}function Q(e=Ge(0,128)){for(let t of e)Te(t)}function rn(e,t,n){let s=f.keys[e],i=f.marking_groups[e],r=f.labels[e];function _(){let m=e%12,R=Math.trunc(e/12),P=Fe(m),D="";switch(o.labels.type){case"pc":D=`${m}`;break;case"english":let G=o.labels.octave?tn[R]:"";D=P?`${lo[m]}${G}`:`${sn[m]}
${lo[m]}
${G}`;break;case"german":if(R>=4){let te=o.labels.octave?"\u2019".repeat(R-4):"";D=P?`${ft[m].toLowerCase()}${te}`:`${ro[m].toLowerCase()}
${ft[m].toLowerCase()}`}else{let te=o.labels.octave?",".repeat(Math.abs(R-3)):"";D=P?`${ft[m]}${te}`:`${ro[m]}
${ft[m]}`}break;case"italian":let V=o.labels.octave?P?on[R-1]:nn[R-1]:"";D=P?`${co[m]}${V}`:`${ln[m]}
${co[m]}
${V}`;break;case"freq":let ee=Zt(B.enabled?e+o.transpose:e);D=`${ee.toFixed(ee<1e3?1:0)}`;break;default:D=`${e}`}let y=D.split(`
`);for(let[G,V]of Array.from(r.children).entries())V.textContent=y[G]??""}if(s){let m=o.labels.keys.has(e),R=m||o.labels.played&&t,P=o.labels.played&&!m;R&&_(),s.classList.toggle("label-visible",R),s.classList.toggle("has-fixed-label",m),s.classList.toggle("has-temporary-label",P),r.classList.toggle("rotated",o.labels.type=="freq");let D=o.stickers.keys.has(e),y=D?o.stickers.keys.get(e):null;s.classList.toggle("has-sticker",D),s.classList.toggle("has-sticker-red",y=="red"),s.classList.toggle("has-sticker-yellow",y=="yellow"),s.classList.toggle("has-sticker-green",y=="green"),s.classList.toggle("has-sticker-blue",y=="blue"),s.classList.toggle("has-sticker-violet",y=="violet"),n&&i.hasAttribute("press_transform")?i.style.setProperty("transform",i.getAttribute("press_transform")):i.style.removeProperty("transform")}}function Je(){Ce("pedr",Y.isSustainActive()||A.sustain_pedal_value/127),Ce("pedm",A.sostenuto_pedal_value/127),Ce("pedl",A.soft_pedal_value/127)}function J(){Ce("connection-power-icon",o.pc_keyboard_connected||B.enabled||o.device_name&&A.getConnectedPort()),Ce("transpose-power-icon",o.transpose!=0),Ce("sound-power-icon",g.led,g.led==1?"red":null),Ce("labels-power-icon",Z=="label"),Ce("stickers-power-icon",Z=="sticker",{red:"red",yellow:"yellow",green:"#0b0",blue:"blue",violet:"violet"}[o.stickers.color]),l.self.toggleAttribute("hidden",!o.toolbar),l.buttons.show_toolbar.toggleAttribute("hidden",o.toolbar),l.dropdowns.pedals.toggleAttribute("hidden",B.enabled),Je()}function po(){for(let e of io)e.action=="hide-elm"?e.elm.classList.toggle("condensed-toolbar-hidden-elm",!1):e.action=="hide-label"&&e.elm.classList.toggle("condensed-toolbar-hidden-label",!1);for(let e of io){if(l.self.scrollWidth<=l.self.clientWidth)break;e.action=="hide-elm"?e.elm.classList.toggle("condensed-toolbar-hidden-elm",!0):e.action=="hide-label"&&e.elm.classList.toggle("condensed-toolbar-hidden-label",!0)}}function fo(){if(g.type&&!g.loaded)for(let e of l.menus.sound.querySelectorAll(".menu-sound-item"))e.toggleAttribute("disabled",!e.hasAttribute("loading")),e.checked=!1;else for(let e of l.menus.sound.querySelectorAll(".menu-sound-item"))e.toggleAttribute("disabled",!1),e.checked=e.value==g.type&&!e.hasAttribute("loading")}function Tt(){for(let e of l.dropdowns.size.querySelectorAll(".btn-number-of-keys")){let t=parseInt(e.value)==o.number_of_keys;e.variant=t?"neutral":null}for(let e of l.dropdowns.size.querySelectorAll(".btn-key-depth")){let t=parseFloat(e.value)==o.height_factor;e.variant=t?"neutral":null}}function mo(){l.menus.colors.picker_color_white.value=o.color_white,l.menus.colors.picker_color_black.value=o.color_black,l.menus.colors.picker_color_pressed.value=o.color_highlight,l.menus.colors.item_perspective.checked=o.perspective,l.menus.colors.item_perspective.hidden=o.lowperf,l.menus.colors.item_top_felt.checked=o.top_felt;for(let e of l.menus.colors.highlight_opacity.children)e.checked=e.value==o.highlight_opacity.toString()}function Ht(){document.getElementById("menu-pedal-follow").checked=o.pedals;let e=document.getElementById("menu-pedal-dim");e.checked=o.pedal_dim,e.toggleAttribute("disabled",!o.pedals)}function et(){l.menus.labels.labeling_mode.checked=Z=="label",l.menus.labels.played.checked=o.labels.played;let e=uo();for(let t of l.menus.labels.presets.children)t.checked=t.value===e;l.menus.labels.presets.nextElementSibling.innerText={none:"None",mc:"Middle-C",cs:"C's",white:"White",all:"All",custom:"Custom"}[e];for(let t of l.menus.labels.type.children)t.value!="octave"&&(t.checked=t.value===o.labels.type);l.menus.labels.type.nextElementSibling.innerText=o.labels.type_badge,l.menus.labels.octave.disabled=["pc","midi","freq"].includes(o.labels.type),l.menus.labels.octave.checked=o.labels.octave}function Kt(){let e=Z=="sticker";for(let t of l.menus.stickers.top.children)if(t.getAttribute("type")=="checkbox"){let n=t.value==o.stickers.color;t.checked=e&&n,t.querySelector(".menu-keyboard-shortcut").classList.toggle("invisible",!n)}l.menus.stickers.clear.disabled=o.stickers.keys.size==0}function go(){document.getElementById("input-semitones").value=o.semitones,document.getElementById("input-octaves").value=o.octaves,document.getElementById("reset-transpose").toggleAttribute("disabled",o.transpose==0),Ce("transpose-power-icon",o.transpose!=0)}function $e(){let e=f.container.clientHeight/f.svg.clientHeight;o.zoom>1?(o.zoom>e&&(o.zoom=e),f.svg.style.transform=`scale(${o.zoom}, ${o.zoom})`):f.svg.style.removeProperty("transform");let t=f.svg.getBoundingClientRect(),n=f.container.getBoundingClientRect(),s=(n.height-t.height)*o.offset.y;f.svg.style.top=`${s}px`;let i=Math.round((t.width-n.width)*o.offset.x);f.container.scroll(i,0),document.getElementById("keyboard-navigator").toggleAttribute("position-top",o.offset.y>.5)}function Pt(e){let t=e+o.transpose;t>=0&&t<128&&Te(t)}function _t(){o.toolbar=!o.toolbar,J(),$e(),M()}function Nt(){g.stopAll(!0),A.reset(),B.reset(),Y.resetState(),lt(),Je(),l.buttons.panic.setAttribute("variant","danger"),setTimeout(()=>{l.buttons.panic.removeAttribute("variant")},1e3)}function ie(e={}){let t=o.transpose;e.reset&&(o.semitones=0,o.octaves=0),e.set?(Object.hasOwn(e,"semitones")&&(o.semitones=e.semitones),Object.hasOwn(e,"octaves")&&(o.octaves=e.octaves)):(Object.hasOwn(e,"semitones")&&(o.semitones=Ne(o.semitones+e.semitones,-11,11)),Object.hasOwn(e,"octaves")&&(o.octaves=Ne(o.octaves+e.octaves,-2,2))),t!=o.transpose&&g.stopAll(!0),go(),Q(),M()}function Xe(e){o.number_of_keys=e,o.zoom=1,Tt(),lt(),M()}function _o(e){o.height_factor=e,Tt(),lt(),M()}function cn(){_o(qt(o.height_factor,[1,.75,.5]))}function Qe(e){o.labels.keys=ao(e),et(),Q(),M()}function De(e){o.labels.type=e,et(),Q(),M()}function Dt(e){Z=e||null,f.svg.classList.toggle("marking-mode",!!e),J()}function bt(e=void 0){e===void 0&&(e=Z!="label"),Dt(e?"label":null),et()}function Be(e=void 0,t=o.stickers.color){e===void 0&&(e=Z!="sticker"||t!=o.stickers.color),o.stickers.color=t,Dt(e?"sticker":null),Kt()}function bo(){o.stickers.keys.clear(),Q(),Kt(),M()}function yo(e=void 0){o.labels.played=e===void 0?!o.labels.played:e,et(),Q(),M()}function ko(e=void 0){o.labels.octave=e===void 0?!o.labels.octave:e,et(),Q(),M()}function an(e=void 0){o.pedals=e===void 0?!o.pedals:e,Ht(),Q(),M()}function dn(e=void 0){o.pedal_dim=e===void 0?!o.pedal_dim:e,Ht(),Q(),M()}function M(){w.writeBool("first-time",!1),w.writeNumber("height-factor",o.height_factor),w.writeNumber("number-of-keys",o.number_of_keys),w.writeString("color-pressed",o.color_highlight),w.writeString("color-white",o.color_white),w.writeString("color-black",o.color_black),w.writeString("labels-type",o.labels.type),w.writeBool("labels-octave",o.labels.octave),w.writeBool("labels-played",o.labels.played),w.writeString("labels-keys",o.labels.keysToStr()),w.writeString("sticker-color",o.stickers.color),w.writeString("stickers-keys",o.stickers.keysToStr()),w.writeBool("perspective",o.perspective),w.writeBool("top-felt",o.top_felt),w.writeString("highlight-opacity",o.highlight_opacity),w.writeBool("pedals",o.pedals),w.writeBool("pedal-dim",o.pedal_dim),w.writeNumber("offset-y",o.offset.y),o.device_name?w.writeString("device",o.device_name):w.remove("device"),w.writeString("sound",g.type),Ye.writeNumber("semitones",o.semitones),Ye.writeNumber("octaves",o.octaves),Ye.writeBool("toolbar",o.toolbar)}function un(){o.first_time=w.readBool("first-time",!0),o.lowperf=w.readBool("lowperf",o.lowperf),o.height_factor=w.readNumber("height-factor",X()?.75:o.height_factor),o.number_of_keys=w.readNumber("number-of-keys",X()?20:o.number_of_keys),o.color_white=w.readString("color-white",o.color_white),o.color_black=w.readString("color-black",o.color_black),o.color_highlight=w.readString("color-pressed",o.color_highlight),o.labels.type=w.readString("labels-type",o.labels.type),o.labels.octave=w.readBool("labels-octave",o.labels.octave),o.labels.played=w.readBool("labels-played",o.labels.played),o.labels.strToKeys(w.readString("labels-keys","")),o.stickers.color=w.readString("sticker-color",o.stickers.color),o.stickers.strToKeys(w.readString("stickers-keys","")),o.perspective=w.readBool("perspective",o.perspective),o.top_felt=w.readBool("top-felt",o.top_felt),o.highlight_opacity=w.readString("highlight-opacity",o.highlight_opacity),o.pedals=w.readBool("pedals",o.pedals),o.pedal_dim=w.readBool("pedal-dim",o.pedal_dim),o.offset.y=w.readNumber("offset-y",o.offset.y),o.device_name=w.readString("device",null),o.sound=w.readString("sound",""),o.semitones=Ye.readNumber("semitones",0),o.octaves=Ye.readNumber("octaves",0),o.toolbar=Ye.readBool("toolbar",o.toolbar)}function hn(){let e=Rt("mode").toLowerCase();["lp","lowperf"].includes(e)?(o.lowperf=!0,w.writeBool("lowperf",!0)):["hp","highperf"].includes(e)&&(o.lowperf=!1,w.writeBool("lowperf",!1))}function Ce(e,t,n=null){let s=document.getElementById(e);s.classList.toggle("active",t),t&&n?s.style.color=n:s.style.removeProperty("color"),s.style.setProperty("--led-intensity",`${t*100}%`)}function pn(e=null){e===null&&(e=!o.pc_keyboard_connected),e?Ue("pckbd"):Ot()}function fn(e=null){e===null&&(e=!B.enabled),e?Ue("touch"):Ot()}function Ue(e,t=!1){switch(A.disconnect(),g.stopAll(),e){case"pckbd":Y.enable(),B.disable(),o.device_name="pckbd",J(),Q(),t&&M();break;case"touch":Y.disable(),B.enable(),o.device_name="touch",J(),Q(),t&&M();break;default:Y.disable(),B.disable(),o.device_name=null,J(),Q(),A.connectByPortName(e,()=>{o.device_name=e,J(),ke.visible&&ke.replaceStructure(rt()),t&&M()})}}function Ot(e=!1){A.disconnect(),Y.disable(),B.disable(),o.device_name=null,J(),Q(),e&&M()}function gt(e,t=!1){e&&o.device_name!=e?Ue(o.device_name==e?"":e,t):Ot(t)}function Oe(){let e=l.menus.connect.querySelector("sl-divider");if(document.getElementById("menu-connect-item-midi-denied").toggleAttribute("hidden",N.access!="denied"),document.getElementById("menu-connect-item-midi-unavailable").toggleAttribute("hidden",X()||N.access!="unavailable"),document.getElementById("menu-connect-item-midi-prompt").toggleAttribute("hidden",N.access!="prompt"),e.toggleAttribute("hidden",N.access=="granted"&&!N.ports?.length||X()&&N.access=="unavailable"),document.getElementById("menu-connect-item-computer-keyboard").toggleAttribute("checked",o.pc_keyboard_connected),document.getElementById("menu-connect-item-touch").toggleAttribute("checked",B.enabled),N.access!="granted"){N.clearMenuItems();return}let t=document.getElementById("menu-connect-item-midi-port-template");for(let n of N.ports??[])if(!N.menu_items.some(s=>n.name==s.value)){let s=Vt(t,{value:n.name},n.name);s.addEventListener("click",i=>{gt(i.currentTarget.value,!0)}),l.menus.connect.insertBefore(s,e)}for(let n of N.menu_items??[])N.ports.some(s=>n.value==s.name)?n.toggleAttribute("checked",n.value==N.connected_port?.name):n.remove()}l.dropdowns.connect.addEventListener("sl-show",()=>{Oe(),N.setWatchdog(500),N.queryAccess(e=>{e!="granted"&&Oe(),["granted","prompt"].includes(e)&&N.requestAccess(t=>{Oe(),t&&N.requestPorts(Oe)})})});l.dropdowns.connect.addEventListener("sl-hide",()=>{N.setWatchdog(2e3),J()});l.dropdowns.sound.addEventListener("sl-show",fo);l.dropdowns.size.addEventListener("sl-show",Tt);l.dropdowns.colors.addEventListener("sl-show",mo);l.dropdowns.pedals.addEventListener("sl-show",Ht);l.dropdowns.labels.addEventListener("sl-show",et);l.dropdowns.stickers.addEventListener("sl-show",Kt);l.dropdowns.transpose.addEventListener("sl-show",go);for(let e of l.dropdowns.all)e.addEventListener("sl-show",t=>{t.currentTarget.querySelector("sl-button").setAttribute("variant","neutral")}),e.addEventListener("sl-hide",t=>{let n=t.currentTarget.querySelector("sl-button");n.setAttribute("variant","default"),n.blur()});document.getElementById("menu-connect-item-computer-keyboard").addEventListener("click",()=>{pn(),M()});document.getElementById("menu-connect-item-touch").addEventListener("click",()=>{fn(),M()});function wo(e=null,t=null){if(g.stopAll(!0),!e)g.player&&(g.player=null),g.loaded=!1,g.led=0,g.type="",J();else if(g.type!=e){t||(t=l.dropdowns.sound.querySelector(`.menu-sound-item[value="${e}"]`)),g.audio_ctx||(g.audio_ctx=new AudioContext);let n={apiano:{loader:g.apiano,options:{volume:90}},epiano1:{loader:g.epiano,options:{instrument:"TX81Z",volume:127}},epiano2:{loader:g.epiano,options:{instrument:"WurlitzerEP200",volume:70}},epiano3:{loader:g.epiano,options:{instrument:"CP80",volume:70}},harpsi:{loader:g.versilian,options:{instrument:"Chordophones/Zithers/Harpsichord, Unk",volume:100}}}[e];n.storage=g.cache,g.player=new n.loader(g.audio_ctx,n.options),g.loaded=!1,g.led=1,t.toggleAttribute("loading",!0),g.type=e,J();let s=setInterval(()=>{g.led=g.led==0?1:0,J()},400),i=r=>{clearInterval(s),g.loaded=r,g.led=r?2:0,t.toggleAttribute("loading",!1),J(),fo()};g.player.load.then(()=>{i(!0),g.audio_ctx.resume(),M()},r=>{g.player=null,g.type="",i(!1),g.fail_alert.children[1].innerText=`Reason: ${r}`,g.fail_alert.toast()})}}l.menus.sound.addEventListener("sl-select",e=>{wo(e.detail.item.value,e.detail.item),M()});l.dropdowns.size.querySelectorAll(".btn-number-of-keys").forEach(e=>{e.addEventListener("click",t=>{Xe(parseInt(t.currentTarget.value)),X()&&l.dropdowns.size.hide()})});l.dropdowns.size.querySelectorAll(".btn-key-depth").forEach(e=>{e.addEventListener("click",t=>{_o(parseFloat(t.currentTarget.value)),X()&&l.dropdowns.size.hide()})});l.menus.colors.highlight_opacity.addEventListener("sl-select",e=>{o.highlight_opacity=e.detail.item.value,M(),mo()});l.menus.colors.item_perspective.addEventListener("click",()=>{o.perspective=!o.perspective,lt(),M(),X()&&l.dropdowns.colors.hide()});l.menus.colors.item_top_felt.addEventListener("click",()=>{o.top_felt=!o.top_felt,ho(),M(),X()&&l.dropdowns.colors.hide()});document.getElementById("color-white").addEventListener("sl-change",e=>{o.color_white=e.target.value,M()});document.getElementById("color-black").addEventListener("sl-change",e=>{o.color_black=e.target.value,M()});document.getElementById("color-pressed").addEventListener("sl-change",e=>{o.color_highlight=e.target.value,M()});l.menus.labels.presets.addEventListener("sl-select",e=>{Qe(e.detail.item.value),X()&&l.dropdowns.labels.hide()});l.menus.labels.type.addEventListener("sl-select",e=>{e.detail.item.value==l.menus.labels.octave.value?ko(e.detail.item.checked):De(e.detail.item.value),X()&&l.dropdowns.labels.hide()});l.menus.labels.top.addEventListener("sl-select",e=>{e.detail.item.id==l.menus.labels.labeling_mode.id?(bt(e.detail.item.checked),l.dropdowns.labels.hide()):e.detail.item.id==l.menus.labels.played.id&&(yo(e.detail.item.checked),X()&&l.dropdowns.labels.hide())});l.buttons.labels_left.addEventListener("click",()=>{bt()});l.menus.stickers.top.addEventListener("sl-select",e=>{e.detail.item.getAttribute("type")=="checkbox"&&(Be(void 0,e.detail.item.value),l.dropdowns.stickers.hide()),M()});l.buttons.stickers_left.addEventListener("click",()=>{Be()});l.menus.stickers.clear.addEventListener("click",e=>{bo()});l.menus.pedals.addEventListener("sl-select",e=>{let t=e.detail.item;switch(t.id){case"menu-pedal-follow":o.pedals=t.checked;break;case"menu-pedal-dim":o.pedal_dim=t.checked;break}document.getElementById("menu-pedal-dim").toggleAttribute("disabled",!o.pedals),Je(),Q(),M(),X()&&l.dropdowns.pedals.hide()});document.getElementById("btn-semitone-plus").onclick=()=>{ie({semitones:1})};document.getElementById("btn-semitone-minus").onclick=()=>{ie({semitones:-1})};document.getElementById("btn-octave-plus").onclick=()=>{ie({octaves:1})};document.getElementById("btn-octave-minus").onclick=()=>{ie({octaves:-1})};document.getElementById("reset-transpose").onclick=()=>{ie({reset:!0}),X()&&l.dropdowns.transpose.hide()};l.buttons.panic.onclick=Nt;l.buttons.hide_toolbar.onclick=_t;l.buttons.show_toolbar.onclick=_t;l.title.onclick=()=>{document.getElementById("dialog-about").show()};window.addEventListener("keydown",xn);function rt(){function e(){let i=N.ports.map((r,_)=>[r.name,()=>gt(r.name,!0),{checked:o.device_name==r.name}]);return i.push(["Computer keyboard",()=>gt("pckbd",!0),{checked:o.pc_keyboard_connected}]),i.push(["Touch or mouse",()=>gt("touch",!0),{checked:B.enabled}]),i}function t(){if(!o.transpose)return"not transposed";let i=`${o.semitones} semitone${o.semitones!=1?"s":""}`,r=`${o.octaves} octave${o.octaves!=1?"s":""}`;return`${i}, ${r}`}function n(){return o.height_factor==1?"Full":o.height_factor==.5?"1/2":"3/4"}let s=uo();return[["",[["&Control",e()],["&Transpose",[["[\u2191] Semitone up",()=>ie({semitones:1}),{noindex:!0,key:"arrowup"}],["[\u2193] Semitone down",()=>ie({semitones:-1}),{noindex:!0,key:"arrowdown"}],["[\u2192] Octave up",()=>ie({octaves:1}),{noindex:!0,key:"arrowright"}],["[\u2190] Octave down",()=>ie({octaves:-1}),{noindex:!0,key:"arrowleft"}],["&Reset",()=>ie({reset:!0}),{noindex:!0}],[`State: ${t()}`,null]]],["&Size",[["&88 keys",()=>Xe(88),{noindex:!0,checked:o.number_of_keys==88}],["&61 keys",()=>Xe(61),{noindex:!0,checked:o.number_of_keys==61}],["&49 keys",()=>Xe(49),{noindex:!0,checked:o.number_of_keys==49}],["&37 keys",()=>Xe(37),{noindex:!0,checked:o.number_of_keys==37}],["&25 keys",()=>Xe(25),{noindex:!0,checked:o.number_of_keys==25}],[`Change key &depth (current: ${n()})`,()=>cn(),{noindex:!0}]]],["&Pedals",[["&Follow pedals",()=>an(),{checked:o.pedals}],["&Dim pedalized notes",()=>dn(),{checked:o.pedal_dim}]]],["&Labels",[["&Toggle Labeling mode (F2)",()=>bt(),{checked:Z=="label"}],["&Show on played keys",()=>yo(),{checked:o.labels.played}],["&Presets",[["&None",()=>Qe("none"),{checked:s=="none"}],["&Middle-C",()=>Qe("mc"),{checked:s=="mc"}],["&C-keys",()=>Qe("cs"),{checked:s=="cs"}],["&White keys",()=>Qe("white"),{checked:s=="white"}],["&All keys",()=>Qe("all"),{checked:s=="all"}]]],["&Format",[["&English",()=>De("english"),{checked:o.labels.type=="english"}],["&German",()=>De("german"),{checked:o.labels.type=="german"}],["&Italian",()=>De("italian"),{checked:o.labels.type=="italian"}],["&Pitch-class",()=>De("pc"),{checked:o.labels.type=="pc"}],["&MIDI value",()=>De("midi"),{checked:o.labels.type=="midi"}],["&Frequency",()=>De("freq"),{checked:o.labels.type=="freq"}],["Show &octave",()=>ko(),{checked:o.labels.octave}]]]]],["Stic&kers",[["&Red",()=>Be(void 0,"red"),{checked:Z=="sticker"&&o.stickers.color=="red"}],["&Yellow",()=>Be(void 0,"yellow"),{checked:Z=="sticker"&&o.stickers.color=="yellow"}],["&Green",()=>Be(void 0,"green"),{checked:Z=="sticker"&&o.stickers.color=="green"}],["&Blue",()=>Be(void 0,"blue"),{checked:Z=="sticker"&&o.stickers.color=="blue"}],["&Violet",()=>Be(void 0,"violet"),{checked:Z=="sticker"&&o.stickers.color=="violet"}],["&Clear",()=>bo()]]],["Panic!",Nt],[`${o.toolbar?"Hide":"Show"} toolbar [<u>F9</u>]`,_t,{key:"f9"}]]]]}var ke=new so(document.getElementById("keyboard-navigator"),rt());ke.onmenuenter=e=>{N.setWatchdog(e=="Control"?500:2e3),ke.replaceStructure(rt())};ke.onoptionenter=()=>ke.replaceStructure(rt());ke.onshow=()=>N.setWatchdog(2e3);ke.onhide=()=>N.setWatchdog(2e3);f.svg.oncontextmenu=e=>{U.state>0&&e.preventDefault(),U.state=0};f.svg.addEventListener("pointerdown",e=>{l.dropdowns.closeAll(),(e.pointerType!="touch"&&e.button!=0||!B.enabled)&&(!Z||e.button!=0)&&(U.state=1,U.origin.x=e.screenX,U.origin.y=e.screenY,U.previous_offset.x=o.offset.x,U.previous_offset.y=o.offset.y,f.svg.classList.toggle("grabbing",!0),f.svg.setPointerCapture(e.pointerId))},{capture:!0,passive:!1});f.svg.addEventListener("pointerup",e=>{e.pointerType!="touch"&&U.state&&(U.state=U.state==2&&e.button==2?3:0,f.svg.classList.toggle("grabbing",!1),f.svg.releasePointerCapture(e.pointerId),$e(),M())},{capture:!0,passive:!1});f.svg.addEventListener("pointermove",e=>{if(e.pointerType!="touch"&&U.state){let n=f.svg.getBoundingClientRect(),s=f.container.getBoundingClientRect();U.state=2;let r=(e.screenX-U.origin.x)/(n.width-s.width);o.offset.x=Ne(U.previous_offset.x-r,0,1);let _=f.container.clientHeight/f.svg.clientHeight;if(o.zoom<_-(_-1)/10){let R=(e.screenY-U.origin.y)/(s.height-n.height);o.offset.y=Ne(U.previous_offset.y+R,0,1),e.ctrlKey||(o.offset.y<.06&&(o.offset.y=0),o.offset.y>1-.06&&(o.offset.y=1),Math.abs(.5-o.offset.y)<.06&&(o.offset.y=.5))}$e()}},{capture:!1,passive:!0});f.container.addEventListener("wheel",e=>{if(e.preventDefault(),!U.state&&!B.started()&&!e.ctrlKey){let t=-e.deltaY/(e.deltaY<=0?1e3:500),n=f.container.clientHeight/f.svg.clientHeight,s=Ne(o.zoom+t,1,n);if(o.zoom!=s){let r=f.svg.getBoundingClientRect(),_=f.container.getBoundingClientRect(),m=Math.round(_.width*s);o.offset.x=(e.clientX-(e.clientX-r.left)/r.width*m-_.left)/(_.width-m),o.zoom=s}let i=e.deltaX/1e3;i&&(o.offset.x=Ne(o.offset.x-i,0,1)),$e()}},{capture:!1,passive:!1});X()||(mt=null,f.container.addEventListener("pointermove",e=>{e.pointerType!="touch"&&(mt&&clearTimeout(mt),l.buttons.show_toolbar.toggleAttribute("visible",!0),f.container.toggleAttribute("cursor-hidden",!1),f.svg.toggleAttribute("cursor-hidden",!1),mt=setTimeout(()=>{l.buttons.show_toolbar.toggleAttribute("visible",!1),B.enabled||(f.container.toggleAttribute("cursor-hidden",!0),f.svg.toggleAttribute("cursor-hidden",!0))},4e3))},{capture:!1,passive:!0}));var mt;function Pe(e,t){let n=document.elementFromPoint(e,t)?.parentElement;return n?.classList.contains("key")?parseInt(n.getAttribute("value")):null}function vo(e,t,n,s,i){let r=Gt(i),_=Math.sin(r),m=Math.cos(r);Lt()&&(n/=10,s/=10);let[R,P]=n>=s?[e+n*m,t+n*_]:[e-s*_,t+s*m],[D,y]=n>=s?[e-n*m,t-n*_]:[e+s*_,t-s*m],[G,V]=n>=s?[e-s*_,t+s*m]:[e+n*m,t+n*_],[ee,te]=n>=s?[e+s*_,t-s*m]:[e-n*m,t-n*_],me=Pe(R,P),ue=Pe(D,y),we=Pe(G,V),_e=Pe(ee,te),Ie=new Set([me,ue,we,_e]),ve=Math.min(me,ue,we,_e),he=Math.max(me,ue,we,_e),xe=he-ve;if(xe>1){let[be,j]=ve==me?[R,P]:ve==ue?[D,y]:ve==we?[G,V]:[ee,te],[Ee,d]=he==me?[R,P]:he==ue?[D,y]:he==we?[G,V]:[ee,te],Me=(Ee-be)/xe,ze=(d-j)/xe;for(let Le=.5;Le<xe;Le+=.5){let[tt,ct]=[be+Me*Le,j+ze*Le],He=Pe(tt,ct);Ie.add(He)}}return Ie.delete(null),Ie}function mn(e){if(l.dropdowns.closeAll(),e.pointerType!="touch"&&B.enabled&&!Z&&e.button===0&&!B.started(e.pointerId)){let t=Pe(e.clientX,e.clientY);t&&(e.preventDefault(),B.add(e.pointerId,new Set([t])))}}function xo(e){e.pointerType!="touch"&&B.started(e.pointerId)&&e.button===0&&(B.remove(e.pointerId),e.preventDefault())}function gn(e){if(e.pointerType!="touch"&&B.started(e.pointerId)){e.preventDefault();let t=Pe(e.clientX,e.clientY);B.change(e.pointerId,new Set([t]))}}function _n(e){if(B.enabled&&!Z){for(let t of e.changedTouches)if(!B.started(t.identifier)){let n=vo(t.clientX,t.clientY,t.radiusX,t.radiusY,t.rotationAngle);n.size&&(B.add(t.identifier,n),navigator.vibrate(40),e.preventDefault())}}}function Eo(e){for(let t of e.changedTouches)B.started(t.identifier)&&(B.remove(t.identifier),e.preventDefault())}function bn(e){for(let t of e.changedTouches)if(B.started(t.identifier)){e.preventDefault();let n=vo(t.clientX,t.clientY,t.radiusX,t.radiusY,t.rotationAngle);B.change(t.identifier,n)==1&&navigator.vibrate(40)}}f.svg.addEventListener("pointerdown",mn,{capture:!0,passive:!1});f.svg.addEventListener("touchstart",_n,{capture:!0,passive:!1});window.addEventListener("pointerup",xo,{capture:!1,passive:!1});window.addEventListener("pointercancel",xo,{capture:!1,passive:!1});window.addEventListener("touchend",Eo,{capture:!1,passive:!1});window.addEventListener("touchcancel",Eo,{capture:!1,passive:!1});window.addEventListener("pointermove",gn,{capture:!1,passive:!1});window.addEventListener("touchmove",bn,{capture:!1,passive:!1});function yn(e){if(e.button===0){let t=Pe(e.clientX,e.clientY);if(t){let n=e.ctrlKey?Array.from(Ge(t%12,128,12)):[t];if(Z=="label"){let s=!o.labels.keys.has(t);for(let i of n)o.labels.toggle(i,s)}else if(Z=="sticker"){let s=!o.stickers.keys.has(t);for(let i of n)o.stickers.toggle(i,s)}}}}f.svg.addEventListener("click",yn,{capture:!1,passive:!0});function Lo(e,t){Pt(e),g.play(e,t)}function Ao(e,t,n){n&&n<100?setTimeout(()=>Pt(e),100-n):Pt(e),g.stop(e,!1)}function kn(){Q(),g.stopAll(!1),Je()}function wn(e){e>63&&e<68&&(Q(),g.stopAll(!1),Je())}function vn(){Q(),g.stopAll(!0),Je()}A.onConnectionChange=()=>{Q(),J()};A.onKeyPress=Lo;A.onKeyRelease=Ao;A.onControlChange=wn;Y.onKeyPress=Lo;Y.onKeyRelease=Ao;Y.onSustain=kn;Y.onReset=vn;function So(){let e=l.dropdowns.connect.open;N.queryAccess(t=>{t=="granted"?(ke.visible&&ke.replaceStructure(rt()),N.requestPorts(n=>{if(N.ports=n,o.device_name&&o.device_name!="pckbd"&&o.device_name!="touch"){if(!A.getConnectedPort()){let i=n.find(r=>r.name==o.device_name);i&&A.connect(i,()=>{J(),e&&Oe()})}J()}e&&Oe()})):(A.disconnect(),J(),e&&Oe())})}function xn(e){if(e.repeat)return;if(e.key=="Alt"){let i=l.dropdowns.getOpen();i&&(i.hide(),i.querySelector("sl-button[slot=trigger]").blur())}let t=new Map([["f2",bt],["f3",Be],["f9",_t],["escape",()=>{let i=l.dropdowns.getOpen();i?(i.hide(),i.querySelector("sl-button[slot=trigger]").blur()):Z?Dt(null):Nt()}],["pageup",()=>ie({semitones:1})],["pagedown",()=>ie({semitones:-1})],["shift+pageup",()=>ie({octaves:1})],["shift+pagedown",()=>ie({octaves:-1})]]),n=[];e.ctrlKey&&n.push("ctrl"),e.altKey&&n.push("alt"),e.shiftKey&&n.push("shift"),n.push(e.key.toLowerCase());let s=n.join("+");t.has(s)&&(e.preventDefault(),t.get(s)())}function En(){console.log("toolbar resized"),l.resize.timeout&&clearTimeout(l.resize.timeout),l.resize_timeout=setTimeout(()=>{po(),l.resize.timeout=null},o.lowperf?50:5)}function Ln(){console.log("piano container resized"),f.resize.timeout&&clearTimeout(f.resize.timeout),f.resize_timeout=setTimeout(()=>{$e(),f.resize.timeout=null},o.lowperf?50:5)}function An(){if(un(),hn(),X()&&(document.documentElement.classList.add("mobile"),l.buttons.show_toolbar.classList.add("mobile"),l.buttons.panic.parentElement.toggleAttribute("disabled",!0),l.buttons.hide_toolbar.parentElement.toggleAttribute("disabled",!0),l.buttons.show_toolbar.parentElement.toggleAttribute("disabled",!0),l.menus.size.querySelector('.btn-number-of-keys[value="20"]').toggleAttribute("hidden",!1)),Lt()?l.dropdowns.sound.toggleAttribute("hidden",!0):import("https://unpkg.com/smplr@0.16.1/dist/index.mjs").then(t=>{g.cache=new t.CacheStorage("sound_v1"),g.apiano=t.SplendidGrandPiano,g.epiano=t.ElectricPiano,g.versilian=t.Versilian,document.getElementById("menu-sound-item-unavailable").hidden=!0,l.menus.sound.querySelectorAll(".menu-sound-item").forEach(n=>{n.hidden=!1}),X()&&o.sound&&wo(o.sound)}),J(),lt(),o.device_name)["pckbd","touch"].includes(o.device_name)?Ue(o.device_name):N.queryAccess(t=>{t=="granted"&&Ue(o.device_name)});else{let t=document.getElementById("dropdown-connect-tooltip");X()?(Ue("touch",!0),t.setAttribute("content","Play your keyboard using your fingers! Or change the input method by tapping this button.")):t.setAttribute("content","Click on this button to select an input method."),t.open=!0,window.addEventListener("click",()=>{t.open=!1},{once:!0})}function e(){po(),l.resize.observer=new ResizeObserver(En),l.resize.observer.observe(l.self),$e(),f.resize.observer=new ResizeObserver(Ln),f.resize.observer.observe(f.container)}document.readyState=="complete"?e():window.addEventListener("load",e,{once:!0}),So(),N.setWatchdog(2e3)}Promise.allSettled([customElements.whenDefined("sl-dropdown"),customElements.whenDefined("sl-button"),customElements.whenDefined("sl-button-group"),customElements.whenDefined("sl-icon"),customElements.whenDefined("sl-menu"),customElements.whenDefined("sl-menu-item")]).finally(An);})();
