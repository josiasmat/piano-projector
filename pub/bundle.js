(()=>{var Oo=Object.create;var Ot=Object.defineProperty;var $o=Object.getOwnPropertyDescriptor;var zo=Object.getOwnPropertyNames;var qo=Object.getPrototypeOf,Ro=Object.prototype.hasOwnProperty;var Go=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(t,n)=>(typeof require<"u"?require:t)[n]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});var Vo=(e,t,n,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of zo(t))!Ro.call(e,i)&&i!==n&&Ot(e,i,{get:()=>t[i],enumerable:!(s=$o(t,i))||s.enumerable});return e};var Wo=(e,t,n)=>(n=e!=null?Oo(qo(e)):{},Vo(t||!e||!e.__esModule?Ot(n,"default",{value:e,enumerable:!0}):n,e));var jo=["0","1","2","3","4","5","6","7","8","9"],Hn=jo.concat(["A","a","B","b","C","c","D","d","E","e","F","f"]);function*Ve(e,t,n=t>e?1:-1){if(n>0&&e<t)for(;e<t;)yield e,e+=n;else if(n<0&&e>t)for(;e>t;)yield e,e+=n}function Ne(e,t,n){return e<t?t:e>n?n:e}function $t(e,t){let n=t.indexOf(e)+1;return n==t.length&&(n=0),t[n]}function zt(e,t=""){return new URLSearchParams(window.parent.location.search).get(e)??t}function qt(e){return e*(Math.PI/180)}function Rt(e,t={},n=null){let s=e.cloneNode(!0).content.children[0];for(let[i,r]of Object.entries(t))typeof r=="boolean"?s.toggleAttribute(i,r):s.setAttribute(i,r);return n!==null&&(s.children[0].innerText=n),s}function Gt(){return navigator.userAgentData?navigator.userAgentData.mobile:/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)}function Vt(){return/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}var xt=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],Et=64,Lt=66,Wt=67,Fo=123,S={onKeyPress:null,onKeyRelease:null,onPitchClassOn:null,onPitchClassOff:null,onControlChange:null,onSustainPedal:null,onSostenutoPedal:null,onReset:null,onConnectionChange:null,get browserHasMidiSupport(){return!!navigator.requestMIDIAccess},queryMidiAccess(e=null){return this.browserHasMidiSupport?(navigator.permissions.query({name:"midi",sysex:!1}).then(t=>{switch(t.state){case"granted":e?.("granted");break;case"prompt":e?.("prompt");break;default:e?.("denied")}}),!0):(e?.("unavailable"),!1)},requestMidiAccess(e,t=null){if(!this.browserHasMidiSupport){t?.();return}navigator.requestMIDIAccess({sysex:!1}).then(e,t)},requestInputPortList(e,t){if(!this.browserHasMidiSupport){t?.();return}navigator.requestMIDIAccess({sysex:!1}).then(n=>{let s=[];if(n.inputs.size>0)for(let i of n.inputs.values())s.push(i);e(s)},t)},connect(e,t=null,n=xt){this.browserHasMidiSupport&&(this.disconnect(),e.open().then(()=>{p.dev=e,e.addEventListener("midimessage",at),t?.(e),this.onConnectionChange?.(!0,e)}),p.channels=Array.from(n))},connectByPortName(e,t=null,n=xt){this.browserHasMidiSupport&&this.requestInputPortList(s=>{for(let i of s)i.name==e&&(this.disconnect(),i.open().then(r=>{p.dev=r,r.addEventListener("midimessage",at),t?.(r),this.onConnectionChange?.(!0,r)}),p.channels=Array.from(n))})},connectByPortId(e,t=null,n=xt){this.browserHasMidiSupport&&this.requestInputPortList(s=>{for(let i of s)i.id==e&&(this.disconnect(),i.open().then(r=>{p.dev=r,r.addEventListener("midimessage",at),t?.(r),this.onConnectionChange?.(!0,r)}),p.channels=Array.from(n))})},disconnect(){if(!this.browserHasMidiSupport)return;let e=p.dev;e&&(p.dev.removeEventListener("midimessage",at),e.removeEventListener("statechange",Zo),p.dev.close(),p.dev=null,p.channels=[],p.reset(),this.onConnectionChange(!1,e))},getConnectedPort(){return this.browserHasMidiSupport&&p.dev?.state=="connected"?p.dev:null},isKeyPressed(e){return e<0||e>127?!1:p.keys[e]},isNoteOn(e,t="none"){if(e<0||e>127)return!1;switch(t){case"sustain":return this.isKeyPressed(e)||p.sustain[e];case"sostenuto":return this.isKeyPressed(e)||p.sostenuto[e];case"both":return this.isKeyPressed(e)||p.sustain[e]||p.sostenuto[e];default:return this.isKeyPressed(e)}},isPitchClassOn(e,t="none"){for(let n=e;n<128;n+=12)if(this.isNoteOn(n,t))return!0;return!1},getLastControlValue(e){return p.cc[e]},reset(){p.reset()},setPedalThreshold(e){p.pedals.threshold=e},get sustain_pressed(){return p.pedals.sustain},get sostenuto_pressed(){return p.pedals.sostenuto},get soft_pressed(){return p.pedals.soft},get sustain_pedal_value(){return p.cc[Et]},get sostenuto_pedal_value(){return p.cc[Lt]},get soft_pedal_value(){return p.cc[Wt]}};function Zo(e){e.port.state=="disconnected"&&p.dev==e.port&&(p.dev=null),S.onConnectionChange?.(e.port.state=="connected",e.port)}var p={dev:null,channels:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],cc:Array(128).fill(0),keys:Array(128).fill(null),pcs:Array(12).fill(0),sustain:Array(128).fill(!1),sostenuto:Array(128).fill(!1),pedals:{threshold:64,get sustain(){return p.cc[Et]>=this.threshold},get sostenuto(){return p.cc[Lt]>=this.threshold},get soft(){return p.cc[Wt]>=this.threshold}},last_event_timestamp:0,last_event_time_delta:0,reset(){this.cc=Array(128).fill(0),this.keys=Array(128).fill(!1),this.pcs=Array(12).fill(0),this.sustain=Array(128).fill(!1),this.sostenuto=Array(128).fill(!1)}};function at(e){p.last_event_time_delta=e.timeStamp-p.last_event_timestamp,p.last_event_timestamp=e.timeStamp;for(let t of p.channels)switch(e.data[0]){case 144+t:Xo(e.data[1],e.data[2]);break;case 128+t:jt(e.data[1],e.data[2]);break;case 176+t:Uo(e.data[1],e.data[2])}}function Xo(e,t){let n=e%12;p.keys[e]||(p.keys[e]=Date.now(),p.pcs[n]+=1),p.pedals.sustain&&(p.sustain[e]=!0),S.onKeyPress?.(e,t),p.pcs[n]==1&&S.onPitchClassOn?.(n)}function jt(e,t){let n=e%12,s=0;p.keys[e]&&(s=Date.now()-p.keys[e],p.keys[e]=null,p.pcs[n]-=1),S.onKeyRelease?.(e,t,s),p.pcs[n]==0&&S.onPitchClassOff?.(n)}function Qo(e){let t=e>=p.pedals.threshold;if(p.pedals.sustain!=t)if(t){for(let n=0;n<128;n++)p.sustain[n]=p.keys[n]||p.sostenuto[n];S.onSustainPedal?.(t,e)}else{for(let n=0;n<128;n++)p.sustain[n]=!1;S.onSustainPedal?.(t,e)}}function Yo(e){if(!p.pedals.sostenuto&&e>=p.pedals.threshold){for(let t=0;t<128;t++)p.sostenuto[t]=p.keys[t];S.onSostenutoPedal?.(p.pedals.sostenuto,e)}else if(p.pedals.sostenuto&&e<p.pedals.threshold){for(let t=0;t<128;t++)p.sostenuto[t]=!1;S.onSostenutoPedal?.(p.pedals.sostenuto,e)}}function Uo(e,t){e==Lt&&Yo(t),e==Et&&Qo(t),e==Fo&&Jo(),p.cc[e]=t,S.onControlChange?.(e,t)}function Jo(){for(let e=0;e<128;e++)jt(e)}function At(e){let n={c:0,"c#":1,db:1,d:2,"d#":3,eb:3,e:4,fb:4,"e#":5,f:5,"f#":6,gb:6,g:7,"g#":8,ab:8,a:9,"a#":10,bb:10,b:11,"b#":12,cb:-1}[e.slice(0,e.length-1).toLowerCase()],s=parseInt(e.slice(e.length-1));return n+12*(s+1)}function Ft(e,t=440){return 2**((e-69)/12)*t}var St="http://www.w3.org/2000/svg",en={createElement(e,t={}){let n=document.createElementNS(St,e);for(let[s,i]of Object.entries(t))n.setAttribute(s,i);return n},createRootElement(e={}){let t=document.createElementNS(St,"svg");t.setAttribute("version","1.1"),t.setAttribute("xmlns",St);for(let[n,s]of Object.entries(e))t.setAttribute(n,s);return t},createGroup(e={}){return this.createElement("g",e)},makeLine(e,t,n,s,i){let r=this.createElement("line",i);return r.setAttribute("x1",e),r.setAttribute("y1",t),r.setAttribute("x2",n),r.setAttribute("y2",s),r},makeCircle(e,t,n,s={}){let i=this.createElement("circle",s);return i.setAttribute("cx",e),i.setAttribute("cy",t),i.setAttribute("r",n),i},makeRect(e,t,n=null,s=null,i=null,r=null,g={}){let m=this.createElement("rect",g);return m.setAttribute("width",e),m.setAttribute("height",t),n&&m.setAttribute("x",n),s&&m.setAttribute("y",s),i&&m.setAttribute("rx",i),r&&m.setAttribute("ry",r),m},makePolygon(e,t={}){let n=e.length,s=this.createElement("path",t),i=["M",e[0].x,e[0].y];if(n>1){for(let r=1;r<n;r++)e[r]&&i.push("L",e[r].x,e[r].y);n>2&&i.push("Z"),s.setAttribute("d",i.join(" "))}return s},makePath(e,t={},n=null,s=null){let i=this.createElement("path",t);return Array.isArray(e)&&(e=e.filter(r=>r!=null).map(r=>Array.isArray(r)?r.join(" "):r).join(" ")),i.setAttribute("d",e),n!=null&&i.setAttribute("x",n.toString()),s!=null&&i.setAttribute("y",s.toString()),i},makeSimpleArrowMarker(e,t,n={}){let s=this.makePath(["M",0,0,"L",10,5,"L",0,10,"Z"],n),i=this.createElement("marker",{id:e,viewbox:[-5,-5,15,15].join(" "),refX:5,refY:5,markerWidth:t,markerHeight:t,orient:"auto-start-reverse"});return i.appendChild(s),i}},E=en;var Xt=500,We=1.3,Qt=1.8,je=2.5,ct=.13,st=1.01,tn=5,Zt=3,Fe=[,-ct,,+ct,,,-1.4*ct,,0,,1.4*ct];function Yt(e,t,n={}){let s=Xt,i=n.height_factor??1,r=n.first_key??noteToMidi("a0"),g=n.last_key??noteToMidi("c8"),m=g-r,R=(r+g)/2,B=s*i,N=B*(.14*i+.51),y=We/2,j=Qt/2,G=s*2.2/15.5,ee=s*1.4/15.5,te=G/2,pe=G/3,de=ee/2,we=G/15,be=ee/20,Ie=2,ve=2,ue={top:-4,height:7,get bottom(){return this.top+this.height}},xe=ue.bottom-1,ye=ue.bottom-5,V=ue.bottom+1,Ee=ye+(V-ye)/4,d={bottom_height:ee/1.8*(Math.max(i-.5,0)/2+.75),bottom_height1:0,side_width_bottom:Zt*2,side_width_top:Zt,side_width_min:0,side_width_max:0};d.side_width_min=Math.min(d.side_width_top,d.side_width_bottom),d.side_width_max=Math.max(d.side_width_top,d.side_width_bottom),d.bottom_height1=d.bottom_height/2;let Me=B-te*i,qe=Me*st,Le=N-d.bottom_height-pe*i,tt=N-d.bottom_height1-pe*i,He=G/4/2,Re=He+pe*i,ot=Re*.8+d.bottom_height;e.innerHTML="";for(let v=0;v<128;v++)(v<r||v>g)&&(t[v]=null);let Ke=E.createGroup(),M=E.createGroup();function Z(v,z,I,u,k,L){let C=I+y+j,T=I+u-y-j,Ae=C+(T-C)/2,ae=k*st,q=N+y+je,ke=q*st,ce=v>r&&[2,4,7,9,11].includes(z),b=v<g&&[0,2,5,7,9].includes(z),h=I+y+(ce?de+ee*Fe[z-1]+je:j),se=I+u-y-(b?de-ee*Fe[z+1]+je:j),D=u*.015,Ge=D*q/k,yt=h+(Ae-h)/u*Ge,kt=se-(se-Ae)/u*Ge,a={ax:h,ay:xe,bx:se,by:xe,cx:se,cy:q,dx:T,dy:q,ex:T,ey:k,fx:C,fy:k,gx:C,gy:q,hx:h,hy:q},c={ax:a.ax,ay:a.ay,bx:a.bx,by:a.by,cx:kt,cy:ke,dx:T-Ge,dy:ke,ex:T-D,ey:ae,fx:C+D,fy:ae,gx:C+Ge,gy:ke,hx:yt,hy:ke},O=L/4,Se=E.createGroup({id:`key${v}`,class:"key white-key",value:v}),wt=E.makePath(["M",a.ax,a.ay,"H",a.bx,b?["V",a.cy,"H",a.dx]:null,"V",a.ey,"H",a.fx,ce?["V",a.gy,"H",a.hx]:null,"Z"],{class:"key-touch-area invisible",value:v}),nt=_e(["M",a.ax,a.ay,"H",a.bx,b?["L",a.cx,a.cy,"H",a.dx]:null,"L",a.ex,a.ey-L,"Q",a.ex-O,a.ey-O,a.ex-L,a.ey,"H",a.fx+L,"Q",a.fx+O,a.fy-O,a.fx,a.fy-L,ce?["L",a.gx,a.gy,"H",a.hx]:null,"Z"],["M",c.ax,c.ay,"H",c.bx,b?["L",c.cx,c.cy,"H",c.dx]:null,"L",c.ex,c.ey-L,"Q",c.ex-O,c.ey-O,c.ex-L,c.ey,"H",c.fx+L,"Q",c.fx+O,c.fy-O,c.fx,c.fy-L,ce?["L",c.gx,c.gy,"H",c.hx]:null,"Z"],{class:"key-fill"}),x=Ie,Po=_e(["M",a.ax+x,a.ay-y,"H",a.bx-x,b?["L",a.cx-x,a.cy+x,"H",a.dx-x]:null,"L",a.ex-x,a.ey-x-L+y,"Q",a.ex-O-x+y,a.ey-O-x,a.ex-L-x+y,a.ey-x,"H",a.fx+x+L-y,"Q",a.fx+O+x,a.fy-x-O+y,a.fx+x,a.fy-x-L+y,ce?["L",a.gx+x,a.gy+x,"H",a.hx+x]:null,"Z"],["M",c.ax+x,c.ay-y,"H",c.bx-x,b?["L",c.cx-x,c.cy+x,"H",c.dx-x]:null,"L",c.ex-x,c.ey-x-L+y,"Q",c.ex-O-x+y,c.ey-O-x,c.ex-L-x+y,c.ey-x,"H",c.fx+x+L-y,"Q",c.fx+O+x,c.fy-x-O+y,c.fx+x,c.fy-x-L+y,ce?["L",c.gx+x,c.gy+x,"H",c.hx+x]:null,"Z"],{class:"key-highlight"}),Bo=_e(["M",a.ax,a.ay+y,ce?["L",a.hx,a.hy,"H",a.gx]:null,"L",a.fx,a.fy-L-y,b?["M",a.cx,a.cy,"H",a.dx]:null],["M",c.ax,c.ay+y,ce?["L",c.hx,c.hy,"H",c.gx]:null,"L",c.fx,c.fy-L-y,b?["M",c.cx,c.cy,"H",c.dx]:null],{class:"key-light-border white-key-border"}),To=_e(["M",a.fx,a.fy-L,"Q",a.fx+O,a.fy-O,a.fx+L,a.fy,"H",a.ex-L,"Q",a.ex-O,a.ey-O,a.ex,a.ey-L,b?["L",a.dx,a.dy,"M",a.cx,a.cy]:null,"L",a.bx,a.by+y],["M",c.fx,c.fy-L,"Q",c.fx+O,c.fy-O,c.fx+L,c.fy,"H",c.ex-L,"Q",c.ex-O,c.ey-O,c.ex,c.ey-L,b?["L",c.dx,c.dy,"M",c.cx,c.cy]:null,"L",c.bx,c.by+y],{class:"key-dark-border white-key-border"}),Ho=ne(v,I),Ko=I+u/2,No=B-Re,Do=E.makeCircle(Ko,No,He,{class:"key-sticker white-key-sticker"}),vt=E.createGroup({class:"key-marker-group",press_transform:`translateY(${qe-Me}px)`});return vt.appendChild(Ho),vt.appendChild(Do),Se.appendChild(nt),Se.appendChild(Po),Se.appendChild(To),Se.appendChild(Bo),Se.appendChild(vt),Se.appendChild(wt),Se}function $(v){return!n.perspective||Ze(v)?0:(v-R)/((88+m)/4)*d.side_width_max}function F(v,z,I,u,k,L){let C=z,T=C+I,Ae=k/2,ae=k/4,q=$(v)*1.5,ke=q/2,ce=q/1.2,b=n.perspective?{left_top:Math.max(0,d.side_width_top+q),left_bottom:Math.max(0,d.side_width_bottom+q),right_top:Math.max(0,d.side_width_top-q),right_bottom:Math.max(0,d.side_width_bottom-q),left_top1:Math.max(0,d.side_width_top+ce),left_bottom1:Math.max(0,d.side_width_bottom+ke),right_top1:Math.max(0,d.side_width_top-ce),right_bottom1:Math.max(0,d.side_width_bottom-ke)}:{left_top:d.side_width_top,left_bottom:d.side_width_bottom,right_top:d.side_width_top,right_bottom:d.side_width_bottom,left_top1:d.side_width_top,left_bottom1:d.side_width_bottom,right_top1:d.side_width_top,right_bottom1:d.side_width_bottom},h=n.perspective?{left_top:Math.min(C,C+d.side_width_top+q),left_bottom:Math.min(C,C+d.side_width_bottom+q),right_top:Math.max(T,T-d.side_width_top+q),right_bottom:Math.max(T,T-d.side_width_bottom+q),left_top1:Math.min(C,C+d.side_width_top+ce),left_bottom1:Math.min(C,C+d.side_width_bottom+ke),right_top1:Math.max(T,T-d.side_width_top+ce),right_bottom1:Math.max(T,T-d.side_width_bottom+ke)}:{left_top:C,left_bottom:C,right_top:T,right_bottom:T,left_top1:C,left_bottom1:C,right_top1:T,right_bottom1:T},se=E.createGroup({id:`key${v}`,class:"key black-key",value:v}),Dt=_e(["M",h.left_top,V,"L",h.left_top+b.left_top,ye,"H",h.right_top-b.right_top,"L",h.right_top,V,"L",h.right_bottom,u-d.bottom_height-k,"L",T,u,"H",C,"L",h.left_bottom,u-d.bottom_height-k,"Z"],["M",h.left_top1,V,"L",h.left_top1+b.left_top1,Ee,"H",h.right_top1-b.right_top1,"L",h.right_top1,V,"L",h.right_bottom1,u-d.bottom_height1-k,"L",T,u,"H",C,"L",h.left_bottom1,u-d.bottom_height1-k,"Z"],{class:"key-fill key-touch-area"}),D=ve,Ge=_e(["M",h.left_top+D,V,"L",Math.max(h.left_top+D,h.left_top+b.left_top),ye,"H",Math.min(h.right_top-D,h.right_top-b.right_top),"L",h.right_top-D,V,"L",h.right_bottom-D,u-D-d.bottom_height-Ae,"L",T-D,u-D,"H",C+D,"L",h.left_bottom+D,u-D-d.bottom_height-Ae,"Z"],["M",h.left_top1+D,V,"L",Math.max(h.left_top1+D,h.left_top1+b.left_top1),Ee,"H",Math.min(h.right_top1-D,h.right_top1-b.right_top1),"L",h.right_top1-D,V,"L",h.right_bottom1-D,u-D-d.bottom_height1-Ae,"L",T-D,u-D,"H",C+D,"L",h.left_bottom1+D,u-D-d.bottom_height1-Ae,"Z"],{class:"key-highlight"});if(se.appendChild(Dt),se.appendChild(Ge),b.left_bottom>0||b.left_top>0){let x=_e(["M",h.left_top,V,"L",h.left_bottom,u,"L",h.left_bottom+b.left_bottom,u-d.bottom_height-k,"L",h.left_top+b.left_top,ye,"Z"],["M",h.left_top1,V,"L",h.left_bottom1,u,"L",h.left_bottom1+b.left_bottom1,u-d.bottom_height1-k,"L",h.left_top1+b.left_top1,Ee,"Z"],{class:"key-left-bevel black-key-bevel"});se.appendChild(x)}if(b.right_bottom>0||b.right_top>0){let x=_e(["M",h.right_top,V,"L",h.right_bottom,u,"L",h.right_bottom-b.right_bottom,u-d.bottom_height-k,"L",h.right_top-b.right_top,ye,"Z"],["M",h.right_top1,V,"L",h.right_bottom1,u,"L",h.right_bottom1-b.right_bottom1,u-d.bottom_height1-k,"L",h.right_top1-b.right_top1,Ee,"Z"],{class:"key-right-bevel black-key-bevel"});se.appendChild(x)}let yt=_e(["M",C,u,"H",T,"L",h.right_bottom-b.right_bottom-k,u-d.bottom_height,"H",h.left_bottom+b.left_bottom+k,"Z"],["M",C,u,"H",T,"L",h.right_bottom1-b.right_bottom1-k,u-d.bottom_height1,"H",h.left_bottom1+b.left_bottom1+k,"Z"],{class:"key-bottom-bevel black-key-bevel"});se.appendChild(yt);let kt=_e(["M",C,u,"L",h.left_bottom+b.left_bottom,u-d.bottom_height-k,"Q",h.left_bottom+b.left_bottom+ae,u-d.bottom_height-ae,h.left_bottom+b.left_bottom+k,u-d.bottom_height,"Z"],["M",C,u,"L",h.left_bottom1+b.left_bottom1,u-d.bottom_height1-k,"Q",h.left_bottom1+b.left_bottom1+ae,u-d.bottom_height1-ae,h.left_bottom1+b.left_bottom1+k,u-d.bottom_height1,"Z"],{class:"key-left-round-bevel black-key-bevel"});se.appendChild(kt);let a=_e(["M",T,u,"L",h.right_bottom-b.right_bottom,u-d.bottom_height-k,"Q",h.right_bottom-b.right_bottom-ae,u-d.bottom_height-ae,h.right_bottom-b.right_bottom-k,u-d.bottom_height,"Z"],["M",T,u,"L",h.right_bottom1-b.right_bottom1,u-d.bottom_height1-k,"Q",h.right_bottom1-b.right_bottom1-ae,u-d.bottom_height1-ae,h.right_bottom1-b.right_bottom1-k,u-d.bottom_height1,"Z"],{class:"key-right-round-bevel black-key-bevel"});se.appendChild(a);let c=le(v,z),O=z+I/2+q,Se=N-ot,wt=E.makeCircle(O,Se,He,{class:"key-sticker black-key-sticker"}),nt=E.createGroup({class:"key-marker-group",press_transform:`translateX(${(ke-q)*.7}px) translateY(${tt-Le}px)`});return nt.appendChild(c),nt.appendChild(wt),se.appendChild(nt),se}function ne(v,z){let I=z+te,u=E.createElement("text",{x:I,y:Me,id:`keylabel${v}`,class:"key-label white-key-label"});return u.appendChild(E.createElement("tspan",{x:I})),u}function le(v,z){let I=z+de+$(v)/2,u=E.createElement("text",{x:I,y:Le,id:`keylabel${v}`,class:"key-label black-key-label"});return u.appendChild(E.createElement("tspan",{x:I})),u.appendChild(E.createElement("tspan",{x:I,dy:"-0.9lh"})),u.appendChild(E.createElement("tspan",{x:I,dy:"-1.0lh"})),u}let re=0,fe=0;for(let v=r;v<=g;v++){let z=v%12;if(Ze(z)){let I=Z(v,z,fe,G,B,we);Ke.appendChild(I),t[v]=I,re+=G,fe+=G}else{let I=fe-de+Fe[z]*ee,u=F(v,I,ee,N,be,fe);M.appendChild(u),t[v]=u}}e.appendChild(Ke),e.appendChild(E.makeRect(re,ue.height,0,ue.top,null,null,{id:"top-felt"})),e.appendChild(M);let oe={left:-2,top:-4,width:re+We+2,height:B*Math.max(st,1)+We+tn};e.setAttribute("viewBox",`${oe.left} ${oe.top} ${oe.width} ${oe.height}`);function me(v,z,I=!1,u={}){let k=E.createElement("linearGradient",I?{id:v,x2:"0%",y2:"100%"}:{id:v});for(let L of z)k.appendChild(E.createElement("stop",L));for(let[L,C]of Object.entries(u))k.setAttribute(L,C);return k}let he=E.createElement("defs");he.appendChild(me("white-key-gradient",[{offset:"30%","stop-color":"color-mix(in oklch, var(--color-white-key), white 10%)"},{offset:"100%","stop-color":"color-mix(in oklch, var(--color-white-key), black 10%)"}],!1,{gradientTransform:"rotate(45)"})),he.appendChild(me("black-key-gradient",[{offset:"30%","stop-color":"color-mix(in oklch, var(--color-black-key), white 15%)"},{offset:"100%","stop-color":"color-mix(in oklch, var(--color-black-key), black 15%)"}],!1,{gradientTransform:"rotate(45)"})),he.appendChild(me("pressed-white-key-highlight-gradient",[{offset:"0%","stop-color":"var(--color-highlight-alpha)","stop-opacity":"50%"},{offset:"40%","stop-color":"var(--color-highlight-alpha)"}],!0)),he.appendChild(me("pressed-black-key-highlight-gradient",[{offset:"0%","stop-color":"var(--color-highlight-alpha)","stop-opacity":"50%"},{offset:"50%","stop-color":"var(--color-highlight-alpha)"}],!0)),he.appendChild(me("top-felt-gradient",[{offset:"50%","stop-color":"var(--color-felt-top)"},{offset:"100%","stop-color":"var(--color-felt-bottom)"}],!0)),e.appendChild(he)}function Ut(e,t,n={}){let s=Xt,i=n.height_factor??1,r=n.first_key??noteToMidi("a0"),g=n.last_key??noteToMidi("c8"),m=s*i,R=m*(.14*i+.51),B=We/2,N=Qt/2,y=s*2.2/15.5,j=s*1.4/15.5,G=y/2,ee=y/3,te=j/2,pe=y/17,de=2,we=2,be={top:-4,height:7,get bottom(){return this.top+this.height}},Ie=be.bottom-1,ve=be.bottom-5,ue=m-G*i,xe=R-G*i,V=y/4/2,Ee=V+ee*i,d=Ee;e.innerHTML="";for(let M=0;M<128;M++)(M<r||M>g)&&(t[M]=null);let Me=E.createGroup(),qe=E.createGroup();function Le(M,Z,$,F,ne,le){let re=$+B+N,fe=$+F-B-N,oe=R+B+je,me=M>r&&[2,4,7,9,11].includes(Z),he=M<g&&[0,2,5,7,9].includes(Z),v=$+B+(me?te+j*Fe[Z-1]+je:N),z=$+F-B-(he?te-j*Fe[Z+1]+je:N),I=E.createGroup({id:`key${M}`,class:"key white-key lowperf",value:M}),u=E.makePath(["M",v,Ie,"H",z,he?["V",oe,"H",fe]:null,"V",ne-le,"L",fe-le,ne,"H",re+le,"L",re,ne-le,me?["V",oe,"H",v]:null,"Z"],{class:"key-fill key-touch-area lowperf"}),k=de,L=E.makePath(["M",v+k,Ie-B,"H",z-k,he?["V",oe+k,"H",fe-k]:null,"V",ne-k-le+B,"L",fe-le-k+B,ne-k,"H",re+k+le-B,"L",re+k,ne-k-le+B,me?["V",oe+k,"H",v+k]:null,"Z"],{class:"key-highlight lowperf"}),C=rt(M,$),T=$+F/2,Ae=m-Ee,ae=E.makeCircle(T,Ae,V,{class:"key-sticker white-key-sticker lowperf"}),q=E.createGroup({class:"key-marker-group lowperf"});return q.appendChild(C),q.appendChild(ae),I.appendChild(u),I.appendChild(L),I.appendChild(q),I}function tt(M,Z,$,F){let ne=Z,le=ne+$,re=E.createGroup({id:`key${M}`,class:"key black-key lowperf",value:M}),fe=E.makePath(["M",ne,ve,"H",le,"V",F,"H",ne,"Z"],{class:"key-fill key-touch-area lowperf"}),oe=we,me=E.makePath(["M",ne+oe,ve+oe,"H",le-oe,"V",F-oe,"H",ne+oe,"Z"],{class:"key-highlight lowperf"}),he=He(M,Z),v=Z+$/2,z=R-d,I=E.makeCircle(v,z,V,{class:"key-sticker black-key-sticker lowperf"}),u=E.createGroup({class:"key-marker-group lowperf"});return u.appendChild(he),u.appendChild(I),re.appendChild(fe),re.appendChild(me),re.appendChild(u),re}function rt(M,Z){let $=Z+G,F=E.createElement("text",{x:$,y:ue,id:`keylabel${M}`,class:"key-label white-key-label lowperf"});return F.appendChild(E.createElement("tspan",{x:$})),F}function He(M,Z){let $=Z+te,F=E.createElement("text",{x:$,y:xe,id:`keylabel${M}`,class:"key-label black-key-label lowperf"});return F.appendChild(E.createElement("tspan",{x:$})),F.appendChild(E.createElement("tspan",{x:$,dy:"-0.9lh"})),F.appendChild(E.createElement("tspan",{x:$,dy:"-1.0lh"})),F}let Re=0,ot=0;for(let M=r;M<=g;M++){let Z=M%12;if(Ze(Z)){let $=Le(M,Z,ot,y,m,pe);Me.appendChild($),t[M]=$,Re+=y,ot+=y}else{let $=ot-te+Fe[Z]*j,F=tt(M,$,j,R);qe.appendChild(F),t[M]=F}}e.appendChild(Me),e.appendChild(E.makeRect(Re,be.height,0,be.top,null,null,{id:"top-felt",class:"lowperf"})),e.appendChild(qe);let Ke={left:-2,top:-4,width:Re+We+2,height:m*st+We+4};e.setAttribute("viewBox",`${Ke.left} ${Ke.top} ${Ke.width} ${Ke.height}`)}function _e(e,t,n={}){let s=E.createElement("path",n);return e=e.filter(i=>i!=null).map(i=>Array.isArray(i)?i.join(" "):i).join(" "),t=t.filter(i=>i!=null).map(i=>Array.isArray(i)?i.join(" "):i).join(" "),s.setAttribute("d0",e),s.setAttribute("d1",t),s}var on=[!0,!1,!0,!1,!0,!0,!1,!0,!1,!0,!1,!0];function Ze(e){return on[e%12]}var Q={onKeyPress:null,onKeyRelease:null,onSustain:null,onReset:null,get enabled(){return H.enabled},get velocity(){return H.velocity},set velocity(e){e<0&&(e=0),e>127&&(e=127),H.velocity=e},enable(e=null,t=null,n=null,s=null){e&&(this.onKeyPress=e),t&&(this.onKeyRelease=t),n&&(this.onSustain=n),s&&(this.onReset=s),nn()},disable(){sn()},isNotePressed(e){return H.pressed_keys.has(e)},isNoteSustained(e){return H.pressed_keys.has(e)||H.sustain_keys.has(e)},isSustainActive(){return H.sustain},resetState(){H.reset(),this.onReset?.()}},H={enabled:!1,pressed_keys:new Set([]),sustain_keys:new Set([]),sustain:!1,velocity:88,map:new Map([["KeyZ",48],["KeyS",49],["KeyX",50],["KeyD",51],["KeyC",52],["KeyV",53],["KeyG",54],["KeyB",55],["KeyH",56],["KeyN",57],["KeyJ",58],["KeyM",59],["KeyW",60],["Digit3",61],["KeyE",62],["Digit4",63],["KeyR",64],["KeyT",65],["Digit6",66],["KeyY",67],["Digit7",68],["KeyU",69],["Digit8",70],["KeyI",71],["KeyO",72],["Digit0",73],["KeyP",74],["KeyQ",59],["Digit1",58],["Comma",60],["KeyL",61],["Period",62],["Semicolon",63],["Slash",64],["IntlRo",65],["Backslash",66],["Minus",75],["BracketLeft",76],["BracketRight",77],["IntlBackslash",47]]),reset(){this.pressed_keys.clear(),this.sustain_keys.clear(),this.sustain=!1}};function nn(){H.enabled||(H.enabled=!0,window.addEventListener("keydown",eo),window.addEventListener("keyup",to))}function sn(){H.enabled&&(window.removeEventListener("keydown",eo),window.removeEventListener("keyup",to),H.enabled=!1,H.reset())}function ln(e){H.pressed_keys.add(e),H.sustain&&H.sustain_keys.add(e),Q.onKeyPress?.(e,H.velocity)}function rn(e){H.pressed_keys.delete(e),Q.onKeyRelease?.(e)}function Jt(e){if(H.sustain!=e){if(H.sustain=e,e)for(let t of H.pressed_keys)H.sustain_keys.add(t);else H.sustain_keys.clear();Q.onSustain(e)}}function eo(e){if(!(e.ctrlKey||e.altKey)){if(e.code.startsWith("Shift"))e.preventDefault(),Jt(!0);else if(H.map.has(e.code)){if(e.preventDefault(),e.repeat)return;let t=H.map.get(e.code);ln(t)}}}function to(e){if(e.code.startsWith("Shift")&&!e.shiftKey&&(e.preventDefault(),Jt(!1)),H.map.has(e.code)){if(e.preventDefault(),e.repeat)return;let t=H.map.get(e.code);rn(t)}}var dt=class{#e=null;#o="";constructor(t,n){switch(t){case"local":this.#e=localStorage;break;case"session":this.#e=sessionStorage;break;default:throw Error(`Invalid storage type: "${t}".`)}n!=""&&(this.#o=n+"_"),this.#o.replace(" ","_")}#t(t){return this.#o+t}isAvailable(){try{let t="__storage_test__";return this.#e.setItem(t,t),this.#e.removeItem(t),!0}catch(t){return t instanceof DOMException&&t.name==="QuotaExceededError"&&this.#e&&this.#e.length!==0}}readString(t,n=""){try{if(!this.isAvailable())throw Error();let s=this.#e.getItem(this.#t(t));return s??n}catch{return n}}writeString(t,n){try{if(!this.isAvailable())throw Error();this.#e.setItem(this.#t(t),n)}catch{return!1}return!0}readNumber(t,n=0){let s=this.readString(t,n);return isNaN(s)?n:Number(s)}writeNumber(t,n){return isNaN(n)?!1:this.writeString(t,n.toString())}readBool(t,n=!1){return this.readString(t,n.toString())==="true"}writeBool(t,n){return n!=!0&&n!=!1?!1:this.writeString(t,n.toString())}remove(t){try{if(!this.isAvailable())throw Error();this.#e.removeItem(this.#t(t))}catch{return!1}return!0}has(t){return this.isAvailable()&&this.#e.getItem(this.#t(t))!==null}keys(){let t=[],n=this.#o.length;for(let s=0;s<this.#e.length;s++){let i=this.#e.key(s);i.startsWith(this.#o)&&t.push(i.substring(n))}return t}clear(){for(let t of this.keys())this.remove(t)}},ut=class extends dt{constructor(t){super("local",t)}},ht=class extends dt{constructor(t){super("session",t)}};var Ct=class{#e;#o;#t=[];#n=[];#a=[];#i;#l=!1;#s=!1;get visible(){return this.#s}onshow=void 0;onhide=void 0;onmenuenter=void 0;onoptionenter=void 0;constructor(t,n,s="alt"){this.#e=t,this.#o=n,this.#i=s,this.enable()}enable(){this.#l||(this.#l=!0,window.addEventListener("keydown",t=>this.#d(t)),window.addEventListener("keyup",t=>this.#u(t)),window.addEventListener("blur",()=>this.#h()))}disable(){this.#l&&(window.removeEventListener("keydown",t=>this.#d(t)),window.removeEventListener("keyup",t=>this.#u(t)),window.removeEventListener("blur",()=>this.#h()),this.#l=!1)}get container(){return this.#e}replaceStructure(t){this.#o=t,this.#s&&this.#r()}#f(){this.#s==!1&&(this.#s=!0,this.#t=[0],this.onshow?.(),this.#e.hidden=!1,this.#e.focus()),this.#r()}#m(t){this.#t.push(t),this.onmenuenter?.(this.#n[t].text)}#_(){this.#t.length>1&&(this.#t.pop(),this.onmenuenter?.(this.#a.text))}#r(){this.#e.innerHTML="";let t=document.createElement("sl-breadcrumb");this.#e.appendChild(t);let n=this.#o;for(let r of this.#t){let g=document.createElement("sl-breadcrumb-item");g.innerHTML=no(n[r][0]),n=n[r][1],t.appendChild(g)}this.#n=[];for(let[r,g]of n.entries()){this.#a=this.#n;let m=g[1]===null||g[2]?.noindex?g[0]:`&${r+1}: ${g[0]}`;this.#n.push({html:oo(m),text:no(g[0]),action:Array.isArray(g[1])?r:g[1],keys:g[2]?.key?so(m).concat([g[2].key]):so(m),checkbox:g[2]?Object.hasOwn(g[2],"checked"):!1,checked:g[2]?.checked})}this.#t.length>1&&this.#n.push({html:oo("&0: Back"),text:"Back",action:()=>this.#_(),keys:["0"]});let s=this.#n.map(r=>r.checkbox?`<span check-item${r.checked?" checked":""}><span class="checkbox">${r.checked?"\u{1F5F9}":"\u2610"}</span> ${r.html}</span>`:`<span>${r.html}</span>`).join("|"),i=document.createElement("sl-breadcrumb-item");i.innerHTML=s,t.appendChild(i)}#c(){this.#s&&(this.#s=!1,this.#e.hidden=!0,this.onhide?.())}#d(t){if(!t.repeat){if(this.#p(t))t.preventDefault(),this.#f();else if(this.#g(t)){let n=!1,s=t.key.toLowerCase();for(let i of this.#n)i.keys.includes(s)&&i.action!==null&&(n=!0,typeof i.action=="number"?this.#m(i.action):typeof i.action=="function"&&(i.action(),this.onoptionenter?.()));this.#r(),(n||s.length==1)&&t.preventDefault()}}}#u(t){this.#p(t)&&(t.preventDefault(),this.#c())}#h(){this.#s&&this.#c()}#p(t){return t.key.toLowerCase()==this.#i||t.code.toLowerCase().startsWith(this.#i)}#g(t){return[this.#i=="ctrl"&&t.ctrlKey,this.#i=="alt"&&t.altKey,this.#i=="shift"&&t.shiftKey].filter(n=>n).length==1}};function oo(e){return e.replace(/&(.)/g,"<u>$1</u>")}function no(e){return e.replaceAll("&","")}function so(e){return e.match(/(?<=&)./g)?.map(n=>n.toLowerCase())??[]}var io=Ct;var w=new ut("piano-projector"),Ye=new ht("piano-projector-session"),U=Gt(),uo=Vt(),o={first_time:!0,lowperf:!1,number_of_keys:88,height_factor:1,device_name:null,sound:null,offset:{x:.5,y:.5},labels:{type:"english",octave:!0,played:!1,keys:new Set,toggle(e,t=void 0){t=t??!this.keys.has(e),t?this.keys.add(e):this.keys.delete(e),Te(e),P()},keysToStr(){return[...this.keys].join(",")},strToKeys(e){if(this.keys.clear(),e)for(let t of e.split(",")){let n=parseInt(t);Number.isInteger(n)&&this.keys.add(n)}},get type_badge(){return{english:"English",german:"German",italian:"Italian",pc:"Pitch-class",midi:"MIDI",freq:"Frequency"}[this.type]}},stickers:{color:"red",keys:new Map,toggle(e,t=void 0){t=t??!this.keys.has(e),t?this.keys.set(e,this.color):this.keys.delete(e),Te(e),P()},keysToStr(){let e=[];for(let[t,n]of this.keys.entries())e.push(`${t}:${n}`);return e.join(",")},strToKeys(e){if(this.keys.clear(),e)for(let t of e.split(",")){let[n,s]=t.split(":"),i=parseInt(n);Number.isInteger(i)&&this.keys.set(i,s)}}},zoom:1,pedals:!0,pedal_dim:!0,perspective:!0,top_felt:!0,toolbar:!0,semitones:0,octaves:0,get transpose(){return this.semitones+this.octaves*12},get highlight_opacity(){return getComputedStyle(document.documentElement).getPropertyValue("--highlight-opacity")},set highlight_opacity(e){document.documentElement.style.setProperty("--highlight-opacity",e)},get color_highlight(){return getComputedStyle(document.documentElement).getPropertyValue("--color-highlight")},set color_highlight(e){document.documentElement.style.setProperty("--color-highlight",e)},get color_white(){return getComputedStyle(document.documentElement).getPropertyValue("--color-white-key")},set color_white(e){document.documentElement.style.setProperty("--color-white-key",e)},get color_black(){return getComputedStyle(document.documentElement).getPropertyValue("--color-black-key")},set color_black(e){document.documentElement.style.setProperty("--color-black-key",e)},get color_top_felt(){return getComputedStyle(document.documentElement).getPropertyValue("--color-felt-top")},set color_top_felt(e){document.documentElement.style.setProperty("--color-felt-top",e)},get pc_keyboard_connected(){return this.device_name==="pckbd"}},K={ports:[],get menu_items(){return Array.from(l.menus.connect.querySelectorAll(".menu-connect-item-midi-input"))},get connected_port(){return S.getConnectedPort()},access:"unavailable",queryAccess(e=null){S.queryMidiAccess(t=>{this.access=t,e?.(this.access)})},requestAccess(e=null){S.requestMidiAccess(()=>{this.access="granted",e?.(!0)},()=>{this.access="denied",e?.(!1)})},requestPorts(e=null){S.requestInputPortList(t=>{this.ports=t,e?.(t)},()=>{this.ports=null,e?.(null)})},clearMenuItems(){for(let e of this.menu_items)e.remove()},watchdog_id:null,setWatchdog(e){this.watchdog_id&&clearInterval(this.watchdog_id),this.watchdog_id=setInterval(Mo,e)}},_={type:"",loaded:!1,led:null,audio_ctx:null,player:null,get loading(){return this.type&&!this.loaded},play(e,t=100){this.type=="epiano1"?e+=12:this.type=="harpsi"&&(t=127),this.player?.start({note:e+o.transpose,velocity:t})},stop(e,t){this.type=="epiano1"&&(e+=12),(t||!(S.isNoteOn(e,o.pedals?"both":"none")||Q.isNoteSustained(e))&&!(this.type=="apiano"&&e+o.transpose>88))&&this.player?.stop(e+o.transpose)},stopAll(e){if(e)this.player?.stop();else for(let t=0;t<128;t++)this.stop(t,!1)},fail_alert:document.getElementById("alert-sound-connection-fail"),apiano:null,epiano:null,versilian:null,cache:null},X={state:0,origin:{x:0,y:0},previous_offset:{x:0,y:0}},A={enabled:!1,points:new Map,started(e=null){return e!==null?this.points.has(e):this.points.size>0},has_note(e){for(let t of this.points.values())if(t.has(e))return!0;return!1},add(e,t){this.points.has(e)&&(t=this.points.get(e).union(t)),this.points.set(e,t);for(let n of t.values())_.play(n),Te(n)},change(e,t){let n=0,s=new Set().union(this.points.get(e));this.points.set(e,t);for(let i of s.values())t.has(i)||(_.stop(i),Te(i),n=-1);for(let i of t.values())s.has(i)||(_.play(i),Te(i),n=1);return n},remove(e){let t=this.points.get(e);this.points.delete(e);for(let n of t.values())this.has_note(n)||_.stop(n),Te(n)},reset(){this.points.clear(),_.stopAll()},enable(){this.enabled=!0,$e()},disable(){this.reset(),this.enabled=!1,$e()},last_vibration_time:0},l={self:document.getElementById("top-toolbar"),title:document.getElementById("toolbar-title"),dropdowns:{connect:document.getElementById("dropdown-connect"),sound:document.getElementById("dropdown-sound"),transpose:document.getElementById("dropdown-transpose"),size:document.getElementById("dropdown-size"),colors:document.getElementById("dropdown-colors"),pedals:document.getElementById("dropdown-pedals"),labels:document.getElementById("dropdown-labels"),stickers:document.getElementById("dropdown-stickers"),get all(){return[this.connect,this.sound,this.transpose,this.size,this.colors,this.pedals,this.labels,this.stickers]},closeAll(){for(let e of this.all)e.hide()},getOpen(){return this.all.find(e=>e.open)??null}},buttons:{connect:document.getElementById("btn-connect"),sound:document.getElementById("btn-sound"),transpose:document.getElementById("btn-transpose"),size:document.getElementById("btn-size"),colors:document.getElementById("btn-colors"),pedals:document.getElementById("btn-pedals"),labels_group:document.getElementById("btn-labels-group"),labels_left:document.getElementById("btn-labels-switch"),labels_right:document.getElementById("btn-labels-dropdown"),stickers_group:document.getElementById("btn-labels-group"),stickers_left:document.getElementById("btn-stickers-switch"),stickers_right:document.getElementById("btn-stickers-dropdown"),panic:document.getElementById("btn-panic"),hide_toolbar:document.getElementById("btn-hide-toolbar"),show_toolbar:document.getElementById("btn-show-toolbar")},menus:{connect:document.getElementById("midi-connection-menu"),sound:document.getElementById("menu-sound"),transpose:{top:document.getElementById("menu-transpose"),semitones:{input:document.getElementById("input-semitones"),btn_minus:document.getElementById("btn-semitone-minus"),btn_plus:document.getElementById("btn-semitone-plus")},octaves:{input:document.getElementById("input-octaves"),btn_minus:document.getElementById("btn-octave-minus"),btn_plus:document.getElementById("btn-octave-plus")},item_reset:document.getElementById("reset-transpose")},size:document.getElementById("menu-size"),colors:{top:document.getElementById("menu-colors"),highlight_opacity:document.getElementById("menu-highlight-opacity"),picker_color_white:document.getElementById("color-white"),picker_color_black:document.getElementById("color-black"),picker_color_pressed:document.getElementById("color-pressed"),item_perspective:document.getElementById("menu-perspective"),item_top_felt:document.getElementById("menu-top-felt")},labels:{top:document.getElementById("menu-labels-top"),labeling_mode:document.getElementById("menu-labeling-mode"),played:document.getElementById("menu-labels-played-keys"),presets:document.getElementById("menu-labels-which"),type:document.getElementById("menu-labels-type"),octave:document.getElementById("menu-item-labels-octave")},stickers:{top:document.getElementById("menu-stickers-top"),clear:document.getElementById("menu-stickers-clear")},pedals:{top:document.getElementById("pedal-menu"),item_follow:document.getElementById("menu-pedal-follow"),item_dim:document.getElementById("menu-pedal-dim")}},resize:{observer:null,timeout:null}},lo=[{elm:l.title,action:"hide-elm"},{elm:l.buttons.sound,action:"hide-label"},{elm:l.buttons.connect,action:"hide-label"},{elm:l.buttons.pedals,action:"hide-label"},{elm:l.buttons.transpose,action:"hide-label"},{elm:l.buttons.stickers_left,action:"hide-label"},{elm:l.buttons.labels_left,action:"hide-label"},{elm:l.dropdowns.colors,action:"hide-elm"},{elm:l.dropdowns.size,action:"hide-elm"},{elm:l.dropdowns.sound,action:"hide-elm"},{elm:l.dropdowns.pedals,action:"hide-elm"},{elm:l.buttons.stickers_group,action:"hide-elm"},{elm:l.buttons.labels_group,action:"hide-elm"},{elm:l.buttons.panic,action:"hide-elm"},{elm:l.self,action:"hide-elm"}],f={svg:document.querySelector("svg#piano"),container:document.getElementById("main-area"),first_key:null,last_key:null,keys:Array(128).fill(null),labels:Array(128).fill(null),marking_groups:Array(128).fill(null),loaded:!1,resize:{timeout:null,observer:null}},W=null,Mt=500,_t=2e3,an=["\u208B\u2081","\u2080","\u2081","\u2082","\u2083","\u2084","\u2085","\u2086","\u2087","\u2088","\u2089"],cn=["\u207B\xB2","\u207B\xB9","\xB9","\xB2","\xB3","\u2074","\u2075","\u2076","\u2077","\u2078","\u2079","\xB9\u2070"],dn=["\u208B\u2082","\u208B\u2081","\u2081","\u2082","\u2083","\u2084","\u2085","\u2086","\u2087","\u2088","\u2089","\u2081\u2080"],ro=["C","C\u266F","D","D\u266F","E","F","F\u266F","G","G\u266F","A","A\u266F","B"],un=[,"D\u266D",,"E\u266D",,,"G\u266D",,"A\u266D",,"B\u266D"],pt=["C","Ces","D","Des","E","F","Fes","G","Ges","A","Aes","H"],ao=[,"Dis",,"Eis",,,"Gis",,"Ais",,"B"],co=["do","do\u266F","re","re\u266F","mi","fa","fa\u266F","sol","sol\u266F","la","la\u266F","si"],hn=[,"re\u266D",,"mi\u266D",,,"sol\u266D",,"la\u266D",,"si\u266D"];function ho(e){let t=new Set;switch(e){case"mc":t.add(60);break;case"cs":for(let n of Ve(0,128,12))t.add(n);break;case"white":for(let n of Ve(0,128))Ze(n)&&t.add(n);break;case"all":for(let n of Ve(0,128))t.add(n);break}return t}function po(){for(let e of["none","mc","cs","white","all"]){let t=ho(e);if(o.labels.keys.symmetricDifference(t).size==0)return e}return"custom"}function it(){let e=new Map([[88,["a0","c8"]],[61,["c2","c7"]],[49,["c2","c6"]],[37,["c3","c6"]],[25,["c3","c5"]],[20,["f3","c5"]]]).get(o.number_of_keys);f.first_key=At(e[0]),f.last_key=At(e[1]);let t={height_factor:o.height_factor,perspective:o.perspective,top_felt:o.top_felt,first_key:f.first_key,last_key:f.last_key};o.lowperf?Ut(f.svg,f.keys,t):Yt(f.svg,f.keys,t);for(let[n,s]of f.keys.entries())f.marking_groups[n]=s?.querySelector(".key-marker-group"),f.labels[n]=s?.querySelector(".key-label");f.loaded=!0,mo()}function fo(){document.getElementById("top-felt")?.toggleAttribute("hidden",!o.top_felt)}function Te(e){let t=f.keys[e];if(t){let n=e-o.transpose,i=A.has_note(e)||S.isKeyPressed(n)||Q.isNotePressed(n),r=i||S.isNoteOn(n,o.pedals?"both":"none")||Q.isNoteSustained(n);t.classList.toggle("active",r),t.classList.toggle("pressed",i),t.classList.toggle("dim",o.pedal_dim&&r&&!i);let g=i?"d1":"d0";for(let m of t.children)m.hasAttribute(g)&&m.setAttribute("d",m.getAttribute(g));pn(e,r,i)}}function J(e=Ve(0,128)){for(let t of e)Te(t)}function pn(e,t,n){let s=f.keys[e],i=f.marking_groups[e],r=f.labels[e];function g(){let m=e%12,R=Math.trunc(e/12),B=Ze(m),N="";switch(o.labels.type){case"pc":N=`${m}`;break;case"english":let j=o.labels.octave?an[R]:"";N=B?`${ro[m]}${j}`:`${un[m]}
${ro[m]}
${j}`;break;case"german":if(R>=4){let te=o.labels.octave?"\u2019".repeat(R-4):"";N=B?`${pt[m].toLowerCase()}${te}`:`${ao[m].toLowerCase()}
${pt[m].toLowerCase()}`}else{let te=o.labels.octave?",".repeat(Math.abs(R-3)):"";N=B?`${pt[m]}${te}`:`${ao[m]}
${pt[m]}`}break;case"italian":let G=o.labels.octave?B?cn[R-1]:dn[R-1]:"";N=B?`${co[m]}${G}`:`${hn[m]}
${co[m]}
${G}`;break;case"freq":let ee=Ft(A.enabled?e+o.transpose:e);N=`${ee.toFixed(ee<1e3?1:0)}`;break;default:N=`${e}`}let y=N.split(`
`);for(let[j,G]of Array.from(r.children).entries())G.textContent=y[j]??""}if(s){let m=o.labels.keys.has(e),R=m||o.labels.played&&t,B=o.labels.played&&!m;R&&g(),s.classList.toggle("label-visible",R),s.classList.toggle("has-fixed-label",m),s.classList.toggle("has-temporary-label",B),r.classList.toggle("rotated",o.labels.type=="freq");let N=o.stickers.keys.has(e),y=N?o.stickers.keys.get(e):null;s.classList.toggle("has-sticker",N),s.classList.toggle("has-sticker-red",y=="red"),s.classList.toggle("has-sticker-yellow",y=="yellow"),s.classList.toggle("has-sticker-green",y=="green"),s.classList.toggle("has-sticker-blue",y=="blue"),s.classList.toggle("has-sticker-violet",y=="violet"),n&&i.hasAttribute("press_transform")?i.style.setProperty("transform",i.getAttribute("press_transform")):i.style.removeProperty("transform")}}function $e(){f.svg.classList.toggle("touch-input",A.enabled),f.svg.classList.toggle("grabbing",[1,2].includes(X.state)),f.svg.classList.toggle("marking-mode",W)}function mo(){J(),fo(),ze(),$e()}function Je(){Ce("pedr",Q.isSustainActive()||S.sustain_pedal_value/127),Ce("pedm",S.sostenuto_pedal_value/127),Ce("pedl",S.soft_pedal_value/127)}function Y(){Ce("connection-power-icon",o.pc_keyboard_connected||A.enabled||o.device_name&&S.getConnectedPort()),Ce("transpose-power-icon",o.transpose!=0),Ce("sound-power-icon",_.led,_.led==1?"red":null),Ce("labels-power-icon",W=="label"),Ce("stickers-power-icon",W=="sticker",{red:"red",yellow:"yellow",green:"#0b0",blue:"blue",violet:"violet"}[o.stickers.color]),l.self.toggleAttribute("hidden",!o.toolbar),l.buttons.show_toolbar.toggleAttribute("hidden",o.toolbar),l.dropdowns.pedals.toggleAttribute("hidden",A.enabled),Je()}function _o(){for(let e of lo)e.action=="hide-elm"?e.elm.classList.toggle("condensed-toolbar-hidden-elm",!1):e.action=="hide-label"&&e.elm.classList.toggle("condensed-toolbar-hidden-label",!1);for(let e of lo){if(l.self.scrollWidth<=l.self.clientWidth)break;e.action=="hide-elm"?e.elm.classList.toggle("condensed-toolbar-hidden-elm",!0):e.action=="hide-label"&&e.elm.classList.toggle("condensed-toolbar-hidden-label",!0)}}function go(){if(_.type&&!_.loaded)for(let e of l.menus.sound.querySelectorAll(".menu-sound-item"))e.toggleAttribute("disabled",!e.hasAttribute("loading")),e.checked=!1;else for(let e of l.menus.sound.querySelectorAll(".menu-sound-item"))e.toggleAttribute("disabled",!1),e.checked=e.value==_.type&&!e.hasAttribute("loading")}function Pt(){for(let e of l.dropdowns.size.querySelectorAll(".btn-number-of-keys")){let t=parseInt(e.value)==o.number_of_keys;e.variant=t?"neutral":null}for(let e of l.dropdowns.size.querySelectorAll(".btn-key-depth")){let t=parseFloat(e.value)==o.height_factor;e.variant=t?"neutral":null}}function bo(){l.menus.colors.picker_color_white.value=o.color_white,l.menus.colors.picker_color_black.value=o.color_black,l.menus.colors.picker_color_pressed.value=o.color_highlight,l.menus.colors.item_perspective.checked=o.perspective,l.menus.colors.item_perspective.hidden=o.lowperf,l.menus.colors.item_top_felt.checked=o.top_felt;for(let e of l.menus.colors.highlight_opacity.children)e.checked=e.value==o.highlight_opacity.toString()}function Bt(){l.menus.pedals.item_follow.checked=o.pedals,l.menus.pedals.item_dim.checked=o.pedal_dim,l.menus.pedals.item_dim.toggleAttribute("disabled",!o.pedals)}function et(){l.menus.labels.labeling_mode.checked=W=="label",l.menus.labels.played.checked=o.labels.played;let e=po();for(let t of l.menus.labels.presets.children)t.checked=t.value===e;l.menus.labels.presets.nextElementSibling.innerText={none:"None",mc:"Middle-C",cs:"C's",white:"White",all:"All",custom:"Custom"}[e];for(let t of l.menus.labels.type.children)t.value!="octave"&&(t.checked=t.value===o.labels.type);l.menus.labels.type.nextElementSibling.innerText=o.labels.type_badge,l.menus.labels.octave.disabled=["pc","midi","freq"].includes(o.labels.type),l.menus.labels.octave.checked=o.labels.octave}function Tt(){let e=W=="sticker";for(let t of l.menus.stickers.top.children)if(t.getAttribute("type")=="checkbox"){let n=t.value==o.stickers.color;t.checked=e&&n,t.querySelector(".menu-keyboard-shortcut").classList.toggle("invisible",!n)}l.menus.stickers.clear.disabled=o.stickers.keys.size==0}function yo(){l.menus.transpose.semitones.input.value=o.semitones,l.menus.transpose.octaves.input.value=o.octaves,l.menus.transpose.item_reset.toggleAttribute("disabled",o.transpose==0),Ce("transpose-power-icon",o.transpose!=0)}function ze(){let e=f.container.clientHeight/f.svg.clientHeight;o.zoom>1?(o.zoom>e&&(o.zoom=e),f.svg.style.transform=`scale(${o.zoom}, ${o.zoom})`):f.svg.style.removeProperty("transform");let t=f.svg.getBoundingClientRect(),n=f.container.getBoundingClientRect(),s=(n.height-t.height)*o.offset.y;f.svg.style.top=`${s}px`;let i=Math.round((t.width-n.width)*o.offset.x);f.container.scroll(i,0),ge.container.toggleAttribute("position-top",o.offset.y>.5)}function It(e){let t=e+o.transpose;t>=0&&t<128&&Te(t)}function gt(){o.toolbar=!o.toolbar,Y(),ze(),P()}function Ht(){_.stopAll(!0),S.reset(),A.reset(),Q.resetState(),it(),Je(),l.buttons.panic.setAttribute("variant","danger"),setTimeout(()=>{l.buttons.panic.removeAttribute("variant")},1e3)}function ie(e={}){let t=o.transpose;e.reset&&(o.semitones=0,o.octaves=0),e.set?(Object.hasOwn(e,"semitones")&&(o.semitones=e.semitones),Object.hasOwn(e,"octaves")&&(o.octaves=e.octaves)):(Object.hasOwn(e,"semitones")&&(o.semitones=Ne(o.semitones+e.semitones,-11,11)),Object.hasOwn(e,"octaves")&&(o.octaves=Ne(o.octaves+e.octaves,-2,2))),t!=o.transpose&&_.stopAll(!0),yo(),J(),P()}function Xe(e){o.number_of_keys=e,o.zoom=1,Pt(),it(),P()}function ko(e){o.height_factor=e,Pt(),it(),P()}function fn(){ko($t(o.height_factor,[1,.75,.5]))}function Qe(e){o.labels.keys=ho(e),et(),J(),P()}function De(e){o.labels.type=e,et(),J(),P()}function Kt(e){W=e||null,$e(),Y()}function bt(e=void 0){e===void 0&&(e=W!="label"),Kt(e?"label":null),et()}function Pe(e=void 0,t=o.stickers.color){e===void 0&&(e=W!="sticker"||t!=o.stickers.color),o.stickers.color=t,Kt(e?"sticker":null),Tt()}function wo(){o.stickers.keys.clear(),J(),Tt(),P()}function vo(e=void 0){o.labels.played=e===void 0?!o.labels.played:e,et(),J(),P()}function xo(e=void 0){o.labels.octave=e===void 0?!o.labels.octave:e,et(),J(),P()}function mn(e=void 0){o.pedals=e===void 0?!o.pedals:e,Bt(),J(),P()}function _n(e=void 0){o.pedal_dim=e===void 0?!o.pedal_dim:e,Bt(),J(),P()}function P(){w.writeBool("first-time",!1),w.writeNumber("height-factor",o.height_factor),w.writeNumber("number-of-keys",o.number_of_keys),w.writeString("color-pressed",o.color_highlight),w.writeString("color-white",o.color_white),w.writeString("color-black",o.color_black),w.writeString("labels-type",o.labels.type),w.writeBool("labels-octave",o.labels.octave),w.writeBool("labels-played",o.labels.played),w.writeString("labels-keys",o.labels.keysToStr()),w.writeString("sticker-color",o.stickers.color),w.writeString("stickers-keys",o.stickers.keysToStr()),w.writeBool("perspective",o.perspective),w.writeBool("top-felt",o.top_felt),w.writeString("highlight-opacity",o.highlight_opacity),w.writeBool("pedals",o.pedals),w.writeBool("pedal-dim",o.pedal_dim),w.writeNumber("offset-y",o.offset.y),o.device_name?w.writeString("device",o.device_name):w.remove("device"),w.writeString("sound",_.type),Ye.writeNumber("semitones",o.semitones),Ye.writeNumber("octaves",o.octaves),Ye.writeBool("toolbar",o.toolbar)}function gn(){o.first_time=w.readBool("first-time",!0),o.lowperf=w.readBool("lowperf",o.lowperf),o.height_factor=w.readNumber("height-factor",U?.75:o.height_factor),o.number_of_keys=w.readNumber("number-of-keys",U?20:o.number_of_keys),o.color_white=w.readString("color-white",o.color_white),o.color_black=w.readString("color-black",o.color_black),o.color_highlight=w.readString("color-pressed",o.color_highlight),o.labels.type=w.readString("labels-type",o.labels.type),o.labels.octave=w.readBool("labels-octave",o.labels.octave),o.labels.played=w.readBool("labels-played",o.labels.played),o.labels.strToKeys(w.readString("labels-keys","")),o.stickers.color=w.readString("sticker-color",o.stickers.color),o.stickers.strToKeys(w.readString("stickers-keys","")),o.perspective=w.readBool("perspective",o.perspective),o.top_felt=w.readBool("top-felt",o.top_felt),o.highlight_opacity=w.readString("highlight-opacity",o.highlight_opacity),o.pedals=w.readBool("pedals",o.pedals),o.pedal_dim=w.readBool("pedal-dim",o.pedal_dim),o.offset.y=w.readNumber("offset-y",o.offset.y),o.device_name=w.readString("device",null),o.sound=w.readString("sound",""),o.semitones=Ye.readNumber("semitones",0),o.octaves=Ye.readNumber("octaves",0),o.toolbar=Ye.readBool("toolbar",o.toolbar)}function bn(){let e=zt("mode").toLowerCase();["lp","lowperf"].includes(e)?(o.lowperf=!0,w.writeBool("lowperf",!0)):["hp","highperf"].includes(e)&&(o.lowperf=!1,w.writeBool("lowperf",!1))}function Ce(e,t,n=null){let s=document.getElementById(e);s.classList.toggle("active",t),t&&n?s.style.color=n:s.style.removeProperty("color"),s.style.setProperty("--led-intensity",`${t*100}%`)}function yn(e=null){e===null&&(e=!o.pc_keyboard_connected),e?Ue("pckbd"):Nt()}function kn(e=null){e===null&&(e=!A.enabled),e?Ue("touch"):Nt()}function Ue(e,t=!1){switch(S.disconnect(),_.stopAll(),e){case"pckbd":Q.enable(),A.disable(),o.device_name="pckbd",Y(),mo(),t&&P();break;case"touch":Q.disable(),A.enable(),o.device_name="touch",Y(),J(),t&&P();break;default:Q.disable(),A.disable(),o.device_name=null,Y(),J(),S.connectByPortName(e,()=>{o.device_name=e,Y(),ge.visible&&ge.replaceStructure(lt()),t&&P()})}}function Nt(e=!1){S.disconnect(),Q.disable(),A.disable(),o.device_name=null,Y(),J(),e&&P()}function mt(e,t=!1){e&&o.device_name!=e?Ue(o.device_name==e?"":e,t):Nt(t)}function Oe(){let e=l.menus.connect.querySelector("sl-divider");if(document.getElementById("menu-connect-item-midi-denied").toggleAttribute("hidden",K.access!="denied"),document.getElementById("menu-connect-item-midi-unavailable").toggleAttribute("hidden",U||K.access!="unavailable"),document.getElementById("menu-connect-item-midi-prompt").toggleAttribute("hidden",K.access!="prompt"),e.toggleAttribute("hidden",K.access=="granted"&&!K.ports?.length||U&&K.access=="unavailable"),document.getElementById("menu-connect-item-computer-keyboard").toggleAttribute("checked",o.pc_keyboard_connected),document.getElementById("menu-connect-item-touch").toggleAttribute("checked",A.enabled),K.access!="granted"){K.clearMenuItems();return}let t=document.getElementById("menu-connect-item-midi-port-template");for(let n of K.ports??[])if(!K.menu_items.some(s=>n.name==s.value)){let s=Rt(t,{value:n.name},n.name);s.addEventListener("click",i=>{mt(i.currentTarget.value,!0)}),l.menus.connect.insertBefore(s,e)}for(let n of K.menu_items??[])K.ports.some(s=>n.value==s.name)?n.toggleAttribute("checked",n.value==K.connected_port?.name):n.remove()}l.dropdowns.connect.addEventListener("sl-show",()=>{Oe(),K.setWatchdog(Mt),K.queryAccess(e=>{e!="granted"&&Oe(),["granted","prompt"].includes(e)&&K.requestAccess(t=>{Oe(),t&&K.requestPorts(Oe)})})});l.dropdowns.connect.addEventListener("sl-hide",()=>{K.setWatchdog(_t),Y()});l.dropdowns.sound.addEventListener("sl-show",go);l.dropdowns.size.addEventListener("sl-show",Pt);l.dropdowns.colors.addEventListener("sl-show",bo);l.dropdowns.pedals.addEventListener("sl-show",Bt);l.dropdowns.labels.addEventListener("sl-show",et);l.dropdowns.stickers.addEventListener("sl-show",Tt);l.dropdowns.transpose.addEventListener("sl-show",yo);for(let e of l.dropdowns.all)e.addEventListener("sl-show",t=>{t.currentTarget.querySelector("sl-button").setAttribute("variant","neutral")}),e.addEventListener("sl-hide",t=>{let n=t.currentTarget.querySelector("sl-button");n.setAttribute("variant","default"),n.blur()});document.getElementById("menu-connect-item-computer-keyboard").addEventListener("click",()=>{yn(),P()});document.getElementById("menu-connect-item-touch").addEventListener("click",()=>{kn(),P()});function Eo(e=null,t=null){if(_.stopAll(!0),!e)_.player&&(_.player=null),_.loaded=!1,_.led=0,_.type="",Y();else if(_.type!=e){t||(t=l.dropdowns.sound.querySelector(`.menu-sound-item[value="${e}"]`)),_.audio_ctx||(_.audio_ctx=new AudioContext);let n={apiano:{loader:_.apiano,options:{volume:90}},epiano1:{loader:_.epiano,options:{instrument:"TX81Z",volume:127}},epiano2:{loader:_.epiano,options:{instrument:"WurlitzerEP200",volume:70}},epiano3:{loader:_.epiano,options:{instrument:"CP80",volume:70}},harpsi:{loader:_.versilian,options:{instrument:"Chordophones/Zithers/Harpsichord, Unk",volume:100}}}[e];n.storage=_.cache,_.player=new n.loader(_.audio_ctx,n.options),_.loaded=!1,_.led=1,t.toggleAttribute("loading",!0),_.type=e,Y();let s=setInterval(()=>{_.led=_.led==0?1:0,Y()},400),i=r=>{clearInterval(s),_.loaded=r,_.led=r?2:0,t.toggleAttribute("loading",!1),Y(),go()};_.player.load.then(()=>{i(!0),_.audio_ctx.resume(),P()},r=>{_.player=null,_.type="",i(!1),_.fail_alert.children[1].innerText=`Reason: ${r}`,_.fail_alert.toast()})}}l.menus.sound.addEventListener("sl-select",e=>{Eo(e.detail.item.value,e.detail.item),P()});l.dropdowns.size.querySelectorAll(".btn-number-of-keys").forEach(e=>{e.addEventListener("click",t=>{Xe(parseInt(t.currentTarget.value)),U&&l.dropdowns.size.hide()})});l.dropdowns.size.querySelectorAll(".btn-key-depth").forEach(e=>{e.addEventListener("click",t=>{ko(parseFloat(t.currentTarget.value)),U&&l.dropdowns.size.hide()})});l.menus.colors.highlight_opacity.addEventListener("sl-select",e=>{o.highlight_opacity=e.detail.item.value,P(),bo()});l.menus.colors.item_perspective.addEventListener("click",()=>{o.perspective=!o.perspective,it(),P(),U&&l.dropdowns.colors.hide()});l.menus.colors.item_top_felt.addEventListener("click",()=>{o.top_felt=!o.top_felt,fo(),P(),U&&l.dropdowns.colors.hide()});l.menus.colors.picker_color_white.addEventListener("sl-change",e=>{o.color_white=e.target.value,P()});l.menus.colors.picker_color_black.addEventListener("sl-change",e=>{o.color_black=e.target.value,P()});l.menus.colors.picker_color_pressed.addEventListener("sl-change",e=>{o.color_highlight=e.target.value,P()});l.menus.labels.presets.addEventListener("sl-select",e=>{Qe(e.detail.item.value),U&&l.dropdowns.labels.hide()});l.menus.labels.type.addEventListener("sl-select",e=>{e.detail.item.value==l.menus.labels.octave.value?xo(e.detail.item.checked):De(e.detail.item.value),U&&l.dropdowns.labels.hide()});l.menus.labels.top.addEventListener("sl-select",e=>{e.detail.item.id==l.menus.labels.labeling_mode.id?(bt(e.detail.item.checked),l.dropdowns.labels.hide()):e.detail.item.id==l.menus.labels.played.id&&(vo(e.detail.item.checked),U&&l.dropdowns.labels.hide())});l.buttons.labels_left.addEventListener("click",()=>{bt()});l.menus.stickers.top.addEventListener("sl-select",e=>{e.detail.item.getAttribute("type")=="checkbox"&&(Pe(void 0,e.detail.item.value),l.dropdowns.stickers.hide()),P()});l.buttons.stickers_left.addEventListener("click",()=>{Pe()});l.menus.stickers.clear.addEventListener("click",e=>{wo()});l.menus.pedals.top.addEventListener("sl-select",e=>{let t=e.detail.item;switch(t.id){case"menu-pedal-follow":o.pedals=t.checked;break;case"menu-pedal-dim":o.pedal_dim=t.checked;break}l.menus.pedals.item_dim.toggleAttribute("disabled",!o.pedals),Je(),J(),P(),U&&l.dropdowns.pedals.hide()});l.menus.transpose.semitones.btn_plus.onclick=()=>{ie({semitones:1})};l.menus.transpose.semitones.btn_minus.onclick=()=>{ie({semitones:-1})};l.menus.transpose.octaves.btn_plus.onclick=()=>{ie({octaves:1})};l.menus.transpose.octaves.btn_minus.onclick=()=>{ie({octaves:-1})};l.menus.transpose.item_reset.onclick=()=>{ie({reset:!0}),U&&l.dropdowns.transpose.hide()};l.buttons.panic.onclick=Ht;l.buttons.hide_toolbar.onclick=gt;l.buttons.show_toolbar.onclick=gt;l.title.onclick=()=>{document.getElementById("dialog-about").show()};window.addEventListener("keydown",In);function lt(){function e(){let i=K.ports.map((r,g)=>[r.name,()=>mt(r.name,!0),{checked:o.device_name==r.name}]);return i.push(["Computer keyboard",()=>mt("pckbd",!0),{checked:o.pc_keyboard_connected}]),i.push(["Touch or mouse",()=>mt("touch",!0),{checked:A.enabled}]),i}function t(){if(!o.transpose)return"not transposed";let i=`${o.semitones} semitone${o.semitones!=1?"s":""}`,r=`${o.octaves} octave${o.octaves!=1?"s":""}`;return`${i}, ${r}`}function n(){return o.height_factor==1?"Full":o.height_factor==.5?"1/2":"3/4"}let s=po();return[["",[["&Control",e()],["&Transpose",[["[\u2191] Semitone up",()=>ie({semitones:1}),{noindex:!0,key:"arrowup"}],["[\u2193] Semitone down",()=>ie({semitones:-1}),{noindex:!0,key:"arrowdown"}],["[\u2192] Octave up",()=>ie({octaves:1}),{noindex:!0,key:"arrowright"}],["[\u2190] Octave down",()=>ie({octaves:-1}),{noindex:!0,key:"arrowleft"}],["&Reset",()=>ie({reset:!0}),{noindex:!0}],[`State: ${t()}`,null]]],["&Size",[["&88 keys",()=>Xe(88),{noindex:!0,checked:o.number_of_keys==88}],["&61 keys",()=>Xe(61),{noindex:!0,checked:o.number_of_keys==61}],["&49 keys",()=>Xe(49),{noindex:!0,checked:o.number_of_keys==49}],["&37 keys",()=>Xe(37),{noindex:!0,checked:o.number_of_keys==37}],["&25 keys",()=>Xe(25),{noindex:!0,checked:o.number_of_keys==25}],[`Change key &depth (current: ${n()})`,()=>fn(),{noindex:!0}]]],["&Pedals",[["&Follow pedals",()=>mn(),{checked:o.pedals}],["&Dim pedalized notes",()=>_n(),{checked:o.pedal_dim}]]],["&Labels",[["&Toggle Labeling mode (F2)",()=>bt(),{checked:W=="label"}],["&Show on played keys",()=>vo(),{checked:o.labels.played}],["&Presets",[["&None",()=>Qe("none"),{checked:s=="none"}],["&Middle-C",()=>Qe("mc"),{checked:s=="mc"}],["&C-keys",()=>Qe("cs"),{checked:s=="cs"}],["&White keys",()=>Qe("white"),{checked:s=="white"}],["&All keys",()=>Qe("all"),{checked:s=="all"}]]],["&Format",[["&English",()=>De("english"),{checked:o.labels.type=="english"}],["&German",()=>De("german"),{checked:o.labels.type=="german"}],["&Italian",()=>De("italian"),{checked:o.labels.type=="italian"}],["&Pitch-class",()=>De("pc"),{checked:o.labels.type=="pc"}],["&MIDI value",()=>De("midi"),{checked:o.labels.type=="midi"}],["&Frequency",()=>De("freq"),{checked:o.labels.type=="freq"}],["Show &octave",()=>xo(),{checked:o.labels.octave}]]]]],["Stic&kers",[["&Red",()=>Pe(void 0,"red"),{checked:W=="sticker"&&o.stickers.color=="red"}],["&Yellow",()=>Pe(void 0,"yellow"),{checked:W=="sticker"&&o.stickers.color=="yellow"}],["&Green",()=>Pe(void 0,"green"),{checked:W=="sticker"&&o.stickers.color=="green"}],["&Blue",()=>Pe(void 0,"blue"),{checked:W=="sticker"&&o.stickers.color=="blue"}],["&Violet",()=>Pe(void 0,"violet"),{checked:W=="sticker"&&o.stickers.color=="violet"}],["&Clear",()=>wo()]]],["Panic!",Ht],[`${o.toolbar?"Hide":"Show"} toolbar [<u>F9</u>]`,gt,{key:"f9"}]]]]}var ge=new io(document.getElementById("keyboard-navigator"),lt());ge.onmenuenter=e=>{K.setWatchdog(e=="Control"?Mt:_t),ge.replaceStructure(lt())};ge.onoptionenter=()=>ge.replaceStructure(lt());ge.onshow=()=>K.setWatchdog(Mt);ge.onhide=()=>K.setWatchdog(_t);f.svg.oncontextmenu=e=>{X.state>0&&e.preventDefault(),X.state=0};f.svg.addEventListener("pointerdown",e=>{l.dropdowns.closeAll(),(e.pointerType!="touch"&&e.button!=0||!A.enabled)&&(!W||e.button!=0)&&(X.state=1,X.origin.x=e.screenX,X.origin.y=e.screenY,X.previous_offset.x=o.offset.x,X.previous_offset.y=o.offset.y,f.svg.setPointerCapture(e.pointerId),$e())},{capture:!0,passive:!1});f.svg.addEventListener("pointerup",e=>{e.pointerType!="touch"&&X.state&&(X.state=X.state==2&&e.button==2?3:0,f.svg.releasePointerCapture(e.pointerId),ze(),$e(),P())},{capture:!0,passive:!1});f.svg.addEventListener("pointermove",e=>{if(e.pointerType!="touch"&&X.state){let n=f.svg.getBoundingClientRect(),s=f.container.getBoundingClientRect();X.state=2;let r=(e.screenX-X.origin.x)/(n.width-s.width);o.offset.x=Ne(X.previous_offset.x-r,0,1);let g=f.container.clientHeight/f.svg.clientHeight;if(o.zoom<g-(g-1)/10){let R=(e.screenY-X.origin.y)/(s.height-n.height);o.offset.y=Ne(X.previous_offset.y+R,0,1),e.ctrlKey||(o.offset.y<.06&&(o.offset.y=0),o.offset.y>1-.06&&(o.offset.y=1),Math.abs(.5-o.offset.y)<.06&&(o.offset.y=.5))}ze(),$e()}},{capture:!1,passive:!0});f.container.addEventListener("wheel",e=>{if(!X.state&&!A.started()&&!e.ctrlKey){let t=-e.deltaY/(e.deltaY<=0?1e3:500),n=f.container.clientHeight/f.svg.clientHeight,s=Ne(o.zoom+t,1,n);if(o.zoom!=s){let r=f.svg.getBoundingClientRect(),g=f.container.getBoundingClientRect(),m=Math.round(g.width*s);o.offset.x=(e.clientX-(e.clientX-r.left)/r.width*m-g.left)/(g.width-m),o.zoom=s}let i=e.deltaX/1e3;i&&(o.offset.x=Ne(o.offset.x-i,0,1)),ze()}e.preventDefault()},{capture:!1,passive:!1});U||(ft=null,f.container.addEventListener("pointermove",e=>{e.pointerType!="touch"&&(ft&&clearTimeout(ft),l.buttons.show_toolbar.toggleAttribute("visible",!0),f.container.toggleAttribute("cursor-hidden",!1),f.svg.toggleAttribute("cursor-hidden",!1),ft=setTimeout(()=>{l.buttons.show_toolbar.toggleAttribute("visible",!1),A.enabled||(f.container.toggleAttribute("cursor-hidden",!0),f.svg.toggleAttribute("cursor-hidden",!0))},4e3))},{capture:!1,passive:!0}));var ft;function Be(e,t){let n=document.elementFromPoint(e,t)?.parentElement;return n?.classList.contains("key")?parseInt(n.getAttribute("value")):null}function Lo(e,t,n,s,i){let r=qt(i),g=Math.sin(r),m=Math.cos(r);uo&&(n/=10,s/=10);let[R,B]=n>=s?[e+n*m,t+n*g]:[e-s*g,t+s*m],[N,y]=n>=s?[e-n*m,t-n*g]:[e+s*g,t-s*m],[j,G]=n>=s?[e-s*g,t+s*m]:[e+n*m,t+n*g],[ee,te]=n>=s?[e+s*g,t-s*m]:[e-n*m,t-n*g],pe=Be(R,B),de=Be(N,y),we=Be(j,G),be=Be(ee,te),Ie=new Set([pe,de,we,be]),ve=Math.min(pe,de,we,be),ue=Math.max(pe,de,we,be),xe=ue-ve;if(xe>1){let[ye,V]=ve==pe?[R,B]:ve==de?[N,y]:ve==we?[j,G]:[ee,te],[Ee,d]=ue==pe?[R,B]:ue==de?[N,y]:ue==we?[j,G]:[ee,te],Me=(Ee-ye)/xe,qe=(d-V)/xe;for(let Le=.5;Le<xe;Le+=.5){let[tt,rt]=[ye+Me*Le,V+qe*Le],He=Be(tt,rt);Ie.add(He)}}return Ie.delete(null),Ie}function wn(e){if(l.dropdowns.closeAll(),e.pointerType!="touch"&&A.enabled&&!W&&e.button===0&&!A.started(e.pointerId)){let t=Be(e.clientX,e.clientY);t&&(A.add(e.pointerId,new Set([t])),e.preventDefault())}}function Ao(e){e.pointerType!="touch"&&A.started(e.pointerId)&&e.button===0&&(e.preventDefault(),A.remove(e.pointerId))}function vn(e){if(e.pointerType!="touch"&&A.started(e.pointerId)){let t=Be(e.clientX,e.clientY);A.change(e.pointerId,new Set([t])),e.preventDefault()}}function xn(e){if(A.enabled&&!W){for(let t of e.changedTouches)if(!A.started(t.identifier)){let n=Lo(t.clientX,t.clientY,t.radiusX,t.radiusY,t.rotationAngle);n.size&&(A.add(t.identifier,n),e.timeStamp-A.last_vibration_time>40&&(navigator.vibrate(40),A.last_vibration_time=e.timeStamp),e.preventDefault())}}}function So(e){for(let t of e.changedTouches)A.started(t.identifier)&&(A.remove(t.identifier),e.preventDefault())}function En(e){for(let t of e.changedTouches)if(A.started(t.identifier)){let n=Lo(t.clientX,t.clientY,t.radiusX,t.radiusY,t.rotationAngle);A.change(t.identifier,n)==1&&e.timeStamp-A.last_vibration_time>40&&(navigator.vibrate(40),A.last_vibration_time=e.timeStamp),e.preventDefault()}}f.svg.addEventListener("pointerdown",wn,{capture:!0,passive:!1});f.svg.addEventListener("touchstart",xn,{capture:!0,passive:!1});window.addEventListener("pointerup",Ao,{capture:!1,passive:!1});window.addEventListener("pointercancel",Ao,{capture:!1,passive:!1});window.addEventListener("touchend",So,{capture:!1,passive:!1});window.addEventListener("touchcancel",So,{capture:!1,passive:!1});window.addEventListener("pointermove",vn,{capture:!1,passive:!1});window.addEventListener("touchmove",En,{capture:!1,passive:!1});function Ln(e){if(e.button===0){let t=Be(e.clientX,e.clientY);if(t){let n=e.ctrlKey?Array.from(Ve(t%12,128,12)):[t];if(W=="label"){let s=!o.labels.keys.has(t);for(let i of n)o.labels.toggle(i,s)}else if(W=="sticker"){let s=!o.stickers.keys.has(t);for(let i of n)o.stickers.toggle(i,s)}}}}f.svg.addEventListener("click",Ln,{capture:!1,passive:!0});function Co(e,t){It(e),_.play(e,t)}function Io(e,t,n){n&&n<100?setTimeout(()=>It(e),100-n):It(e),_.stop(e,!1)}function An(){J(),_.stopAll(!1),Je()}function Sn(e){e>63&&e<68&&(J(),_.stopAll(!1),Je())}function Cn(){J(),_.stopAll(!0),Je()}S.onConnectionChange=()=>{J(),Y()};S.onKeyPress=Co;S.onKeyRelease=Io;S.onControlChange=Sn;Q.onKeyPress=Co;Q.onKeyRelease=Io;Q.onSustain=An;Q.onReset=Cn;function Mo(){let e=l.dropdowns.connect.open;K.queryAccess(t=>{t=="granted"?(ge.visible&&ge.replaceStructure(lt()),K.requestPorts(n=>{if(K.ports=n,o.device_name&&o.device_name!="pckbd"&&o.device_name!="touch"){if(!S.getConnectedPort()){let i=n.find(r=>r.name==o.device_name);i&&S.connect(i,()=>{Y(),e&&Oe()})}Y()}e&&Oe()})):(S.disconnect(),Y(),e&&Oe())})}function In(e){if(e.repeat)return;if(e.key=="Alt"){let i=l.dropdowns.getOpen();i&&(i.hide(),i.querySelector("sl-button[slot=trigger]").blur())}let t=new Map([["f2",bt],["f3",Pe],["f9",gt],["escape",()=>{let i=l.dropdowns.getOpen();i?(i.hide(),i.querySelector("sl-button[slot=trigger]").blur()):W?Kt(null):Ht()}],["pageup",()=>ie({semitones:1})],["pagedown",()=>ie({semitones:-1})],["shift+pageup",()=>ie({octaves:1})],["shift+pagedown",()=>ie({octaves:-1})]]),n=[];e.ctrlKey&&n.push("ctrl"),e.altKey&&n.push("alt"),e.shiftKey&&n.push("shift"),n.push(e.key.toLowerCase());let s=n.join("+");t.has(s)&&(e.preventDefault(),t.get(s)())}function Mn(){l.resize.timeout&&clearTimeout(l.resize.timeout),l.resize_timeout=setTimeout(()=>{_o(),l.resize.timeout=null},o.lowperf?50:5)}function Pn(){f.resize.timeout&&clearTimeout(f.resize.timeout),f.resize_timeout=setTimeout(()=>{ze(),f.resize.timeout=null},o.lowperf?50:5)}function Bn(){if(gn(),bn(),document.body.classList.add("ready"),U&&(document.documentElement.classList.add("mobile"),l.buttons.show_toolbar.classList.add("mobile"),l.buttons.panic.parentElement.toggleAttribute("disabled",!0),l.buttons.hide_toolbar.parentElement.toggleAttribute("disabled",!0),l.buttons.show_toolbar.parentElement.toggleAttribute("disabled",!0),l.menus.size.querySelector('.btn-number-of-keys[value="20"]').toggleAttribute("hidden",!1)),uo?l.dropdowns.sound.toggleAttribute("hidden",!0):import("https://unpkg.com/smplr@0.16.1/dist/index.mjs").then(t=>{_.cache=new t.CacheStorage("sound_v1"),_.apiano=t.SplendidGrandPiano,_.epiano=t.ElectricPiano,_.versilian=t.Versilian,document.getElementById("menu-sound-item-unavailable").hidden=!0,l.menus.sound.querySelectorAll(".menu-sound-item").forEach(n=>{n.hidden=!1}),U&&o.sound&&Eo(o.sound)}),Y(),it(),o.device_name)["pckbd","touch"].includes(o.device_name)?Ue(o.device_name):K.queryAccess(t=>{t=="granted"&&Ue(o.device_name)});else{let t=document.getElementById("dropdown-connect-tooltip");U?(Ue("touch",!0),t.setAttribute("content","Play your keyboard using your fingers! Or change the input method by tapping this button.")):t.setAttribute("content","Click on this button to select an input method."),t.open=!0,window.addEventListener("click",()=>{t.open=!1},{once:!0})}function e(){_o(),l.resize.observer=new ResizeObserver(Mn),l.resize.observer.observe(l.self),ze(),f.resize.observer=new ResizeObserver(Pn),f.resize.observer.observe(f.container)}document.readyState!="complete"?window.addEventListener("load",e,{once:!0}):e(),Mo(),K.setWatchdog(_t)}Promise.allSettled([customElements.whenDefined("sl-dropdown"),customElements.whenDefined("sl-button"),customElements.whenDefined("sl-button-group"),customElements.whenDefined("sl-icon"),customElements.whenDefined("sl-menu"),customElements.whenDefined("sl-menu-item")]).finally(Bn);})();
