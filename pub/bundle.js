(()=>{var Ho=Object.create;var qt=Object.defineProperty;var Ko=Object.getOwnPropertyDescriptor;var No=Object.getOwnPropertyNames;var Do=Object.getPrototypeOf,Oo=Object.prototype.hasOwnProperty;var $o=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(t,n)=>(typeof require<"u"?require:t)[n]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});var zo=(e,t,n,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of No(t))!Oo.call(e,i)&&i!==n&&qt(e,i,{get:()=>t[i],enumerable:!(s=Ko(t,i))||s.enumerable});return e};var qo=(e,t,n)=>(n=e!=null?Ho(Do(e)):{},zo(t||!e||!e.__esModule?qt(n,"default",{value:e,enumerable:!0}):n,e));var Ro=["0","1","2","3","4","5","6","7","8","9"],Mn=Ro.concat(["A","a","B","b","C","c","D","d","E","e","F","f"]);function*Ve(e,t,n=t>e?1:-1){if(n>0&&e<t)for(;e<t;)yield e,e+=n;else if(n<0&&e>t)for(;e>t;)yield e,e+=n}function Ne(e,t,n){return e<t?t:e>n?n:e}function Rt(e,t){let n=t.indexOf(e)+1;return n==t.length&&(n=0),t[n]}function Gt(e,t=""){return new URLSearchParams(window.parent.location.search).get(e)??t}function Vt(e){return e*(Math.PI/180)}function jt(e,t={},n=null){let s=e.cloneNode(!0).content.children[0];for(let[i,r]of Object.entries(t))typeof r=="boolean"?s.toggleAttribute(i,r):s.setAttribute(i,r);return n!==null&&(s.children[0].innerText=n),s}function X(){return navigator.userAgentData?navigator.userAgentData.mobile:/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)}function At(){return/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}var St=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],Ct=64,It=66,Wt=67,Go=123,A={onKeyPress:null,onKeyRelease:null,onPitchClassOn:null,onPitchClassOff:null,onControlChange:null,onSustainPedal:null,onSostenutoPedal:null,onReset:null,onConnectionChange:null,get browserHasMidiSupport(){return!!navigator.requestMIDIAccess},queryMidiAccess(e=null){return this.browserHasMidiSupport?(navigator.permissions.query({name:"midi",sysex:!1}).then(t=>{switch(t.state){case"granted":e?.("granted");break;case"prompt":e?.("prompt");break;default:e?.("denied")}}),!0):(e?.("unavailable"),!1)},requestMidiAccess(e,t=null){if(!this.browserHasMidiSupport){t?.();return}navigator.requestMIDIAccess({sysex:!1}).then(e,t)},requestInputPortList(e,t){if(!this.browserHasMidiSupport){t?.();return}navigator.requestMIDIAccess({sysex:!1}).then(n=>{let s=[];if(n.inputs.size>0)for(let i of n.inputs.values())s.push(i);e(s)},t)},connect(e,t=null,n=St){this.browserHasMidiSupport&&(this.disconnect(),e.open().then(()=>{p.dev=e,e.addEventListener("midimessage",dt),t?.(e),this.onConnectionChange?.(!0,e)}),p.channels=Array.from(n))},connectByPortName(e,t=null,n=St){this.browserHasMidiSupport&&this.requestInputPortList(s=>{for(let i of s)i.name==e&&(this.disconnect(),i.open().then(r=>{p.dev=r,r.addEventListener("midimessage",dt),t?.(r),this.onConnectionChange?.(!0,r)}),p.channels=Array.from(n))})},connectByPortId(e,t=null,n=St){this.browserHasMidiSupport&&this.requestInputPortList(s=>{for(let i of s)i.id==e&&(this.disconnect(),i.open().then(r=>{p.dev=r,r.addEventListener("midimessage",dt),t?.(r),this.onConnectionChange?.(!0,r)}),p.channels=Array.from(n))})},disconnect(){if(!this.browserHasMidiSupport)return;let e=p.dev;e&&(p.dev.removeEventListener("midimessage",dt),e.removeEventListener("statechange",Vo),p.dev.close(),p.dev=null,p.channels=[],p.reset(),this.onConnectionChange(!1,e))},getConnectedPort(){return this.browserHasMidiSupport&&p.dev?.state=="connected"?p.dev:null},isKeyPressed(e){return e<0||e>127?!1:p.keys[e]},isNoteOn(e,t="none"){if(e<0||e>127)return!1;switch(t){case"sustain":return this.isKeyPressed(e)||p.sustain[e];case"sostenuto":return this.isKeyPressed(e)||p.sostenuto[e];case"both":return this.isKeyPressed(e)||p.sustain[e]||p.sostenuto[e];default:return this.isKeyPressed(e)}},isPitchClassOn(e,t="none"){for(let n=e;n<128;n+=12)if(this.isNoteOn(n,t))return!0;return!1},getLastControlValue(e){return p.cc[e]},reset(){p.reset()},setPedalThreshold(e){p.pedals.threshold=e},get sustain_pressed(){return p.pedals.sustain},get sostenuto_pressed(){return p.pedals.sostenuto},get soft_pressed(){return p.pedals.soft},get sustain_pedal_value(){return p.cc[Ct]},get sostenuto_pedal_value(){return p.cc[It]},get soft_pedal_value(){return p.cc[Wt]}};function Vo(e){e.port.state=="disconnected"&&p.dev==e.port&&(p.dev=null),A.onConnectionChange?.(e.port.state=="connected",e.port)}var p={dev:null,channels:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],cc:Array(128).fill(0),keys:Array(128).fill(null),pcs:Array(12).fill(0),sustain:Array(128).fill(!1),sostenuto:Array(128).fill(!1),pedals:{threshold:64,get sustain(){return p.cc[Ct]>=this.threshold},get sostenuto(){return p.cc[It]>=this.threshold},get soft(){return p.cc[Wt]>=this.threshold}},last_event_timestamp:0,last_event_time_delta:0,reset(){this.cc=Array(128).fill(0),this.keys=Array(128).fill(!1),this.pcs=Array(12).fill(0),this.sustain=Array(128).fill(!1),this.sostenuto=Array(128).fill(!1)}};function dt(e){p.last_event_time_delta=e.timeStamp-p.last_event_timestamp,p.last_event_timestamp=e.timeStamp;for(let t of p.channels)switch(e.data[0]){case 144+t:jo(e.data[1],e.data[2]);break;case 128+t:Zt(e.data[1],e.data[2]);break;case 176+t:Fo(e.data[1],e.data[2])}}function jo(e,t){let n=e%12;p.keys[e]||(p.keys[e]=Date.now(),p.pcs[n]+=1),p.pedals.sustain&&(p.sustain[e]=!0),A.onKeyPress?.(e,t),p.pcs[n]==1&&A.onPitchClassOn?.(n)}function Zt(e,t){let n=e%12,s=0;p.keys[e]&&(s=Date.now()-p.keys[e],p.keys[e]=null,p.pcs[n]-=1),A.onKeyRelease?.(e,t,s),p.pcs[n]==0&&A.onPitchClassOff?.(n)}function Wo(e){let t=e>=p.pedals.threshold;if(p.pedals.sustain!=t)if(t){for(let n=0;n<128;n++)p.sustain[n]=p.keys[n]||p.sostenuto[n];A.onSustainPedal?.(t,e)}else{for(let n=0;n<128;n++)p.sustain[n]=!1;A.onSustainPedal?.(t,e)}}function Zo(e){if(!p.pedals.sostenuto&&e>=p.pedals.threshold){for(let t=0;t<128;t++)p.sostenuto[t]=p.keys[t];A.onSostenutoPedal?.(p.pedals.sostenuto,e)}else if(p.pedals.sostenuto&&e<p.pedals.threshold){for(let t=0;t<128;t++)p.sostenuto[t]=!1;A.onSostenutoPedal?.(p.pedals.sostenuto,e)}}function Fo(e,t){e==It&&Zo(t),e==Ct&&Wo(t),e==Go&&Xo(),p.cc[e]=t,A.onControlChange?.(e,t)}function Xo(){for(let e=0;e<128;e++)Zt(e)}function Mt(e){let n={c:0,"c#":1,db:1,d:2,"d#":3,eb:3,e:4,fb:4,"e#":5,f:5,"f#":6,gb:6,g:7,"g#":8,ab:8,a:9,"a#":10,bb:10,b:11,"b#":12,cb:-1}[e.slice(0,e.length-1).toLowerCase()],s=parseInt(e.slice(e.length-1));return n+12*(s+1)}function Ft(e,t=440){return 2**((e-69)/12)*t}var Pt="http://www.w3.org/2000/svg",Qo={createElement(e,t={}){let n=document.createElementNS(Pt,e);for(let[s,i]of Object.entries(t))n.setAttribute(s,i);return n},createRootElement(e={}){let t=document.createElementNS(Pt,"svg");t.setAttribute("version","1.1"),t.setAttribute("xmlns",Pt);for(let[n,s]of Object.entries(e))t.setAttribute(n,s);return t},createGroup(e={}){return this.createElement("g",e)},makeLine(e,t,n,s,i){let r=this.createElement("line",i);return r.setAttribute("x1",e),r.setAttribute("y1",t),r.setAttribute("x2",n),r.setAttribute("y2",s),r},makeCircle(e,t,n,s={}){let i=this.createElement("circle",s);return i.setAttribute("cx",e),i.setAttribute("cy",t),i.setAttribute("r",n),i},makeRect(e,t,n=null,s=null,i=null,r=null,g={}){let m=this.createElement("rect",g);return m.setAttribute("width",e),m.setAttribute("height",t),n&&m.setAttribute("x",n),s&&m.setAttribute("y",s),i&&m.setAttribute("rx",i),r&&m.setAttribute("ry",r),m},makePolygon(e,t={}){let n=e.length,s=this.createElement("path",t),i=["M",e[0].x,e[0].y];if(n>1){for(let r=1;r<n;r++)e[r]&&i.push("L",e[r].x,e[r].y);n>2&&i.push("Z"),s.setAttribute("d",i.join(" "))}return s},makePath(e,t={},n=null,s=null){let i=this.createElement("path",t);return Array.isArray(e)&&(e=e.filter(r=>r!=null).map(r=>Array.isArray(r)?r.join(" "):r).join(" ")),i.setAttribute("d",e),n!=null&&i.setAttribute("x",n.toString()),s!=null&&i.setAttribute("y",s.toString()),i},makeSimpleArrowMarker(e,t,n={}){let s=this.makePath(["M",0,0,"L",10,5,"L",0,10,"Z"],n),i=this.createElement("marker",{id:e,viewbox:[-5,-5,15,15].join(" "),refX:5,refY:5,markerWidth:t,markerHeight:t,orient:"auto-start-reverse"});return i.appendChild(s),i}},E=Qo;var Qt=500,We=1.3,je=1.8,Ze=2.5,ut=.13,lt=1.01,Yo=5,Xt=3,Fe=[,-ut,,+ut,,,-1.4*ut,,0,,1.4*ut];function Yt(e,t,n={}){let s=Qt,i=n.height_factor??1,r=n.first_key??noteToMidi("a0"),g=n.last_key??noteToMidi("c8"),m=g-r,R=(r+g)/2,B=s*i,D=B*(.14*i+.51),y=We/2,G=je/2,V=s*2.2/15.5,ee=s*1.4/15.5,te=V/2,me=V/3,ue=ee/2,we=V/15,be=ee/30,Ie=2,ve=2,he={top:-4,height:7,get bottom(){return this.top+this.height}},xe=he.bottom-1,ye=he.bottom-5,j=he.bottom+1,Ee=ye+(j-ye)/4,d={bottom_height:ee/1.8*(Math.max(i-.5,0)/2+.75),bottom_height1:0,side_width_bottom:Xt*2,side_width_top:Xt,side_width_min:0,side_width_max:0};d.side_width_min=Math.min(d.side_width_top,d.side_width_bottom),d.side_width_max=Math.max(d.side_width_top,d.side_width_bottom),d.bottom_height1=d.bottom_height/2;let Me=B-te*i,qe=Me*lt,Le=D-d.bottom_height-me*i,ot=D-d.bottom_height1-me*i,He=V/4/2,Re=He+me*i,nt=Re*.8+d.bottom_height;e.innerHTML="";for(let v=0;v<128;v++)(v<r||v>g)&&(t[v]=null);let Ke=E.createGroup(),I=E.createGroup();function F(v,z,C,u,k,L){let S=C+y+G,T=C+u-y-G,Ae=S+(T-S)/2,ae=k*lt,q=D+y+Ze,ke=q*lt,de=v>r&&[2,4,7,9,11].includes(z),b=v<g&&[0,2,5,7,9].includes(z),h=C+y+(de?ue+ee*Fe[z-1]+Ze:G),ne=C+u-y-(b?ue-ee*Fe[z+1]+Ze:G),O=u*.015,Ge=O*q/k,kt=h+(Ae-h)/u*Ge,wt=ne-(ne-Ae)/u*Ge,c={ax:h,ay:xe,bx:ne,by:xe,cx:ne,cy:q,dx:T,dy:q,ex:T,ey:k,fx:S,fy:k,gx:S,gy:q,hx:h,hy:q},a={ax:c.ax,ay:c.ay,bx:c.bx,by:c.by,cx:wt,cy:ke,dx:T-Ge,dy:ke,ex:T-O,ey:ae,fx:S+O,fy:ae,gx:S+Ge,gy:ke,hx:kt,hy:ke},H=L/4,Se=E.createGroup({id:`key${v}`,class:"key white-key",value:v}),vt=E.makePath(["M",c.ax,c.ay,"H",c.bx,b?["V",c.cy,"H",c.dx]:null,"V",c.ey,"H",c.fx,de?["V",c.gy,"H",c.hx]:null,"Z"],{class:"key-touch-area invisible",value:v}),xt=fe(["M",c.ax,c.ay,"H",c.bx,b?["L",c.cx,c.cy,"H",c.dx]:null,"L",c.ex,c.ey-L,"Q",c.ex-H,c.ey-H,c.ex-L,c.ey,"H",c.fx+L,"Q",c.fx+H,c.fy-H,c.fx,c.fy-L,de?["L",c.gx,c.gy,"H",c.hx]:null,"Z"],["M",a.ax,a.ay,"H",a.bx,b?["L",a.cx,a.cy,"H",a.dx]:null,"L",a.ex,a.ey-L,"Q",a.ex-H,a.ey-H,a.ex-L,a.ey,"H",a.fx+L,"Q",a.fx+H,a.fy-H,a.fx,a.fy-L,de?["L",a.gx,a.gy,"H",a.hx]:null,"Z"],{class:"key-fill"}),x=Ie,Et=fe(["M",c.ax+x,c.ay-y,"H",c.bx-x,b?["L",c.cx-x,c.cy+x,"H",c.dx-x]:null,"L",c.ex-x,c.ey-x-L+y,"Q",c.ex-H-x+y,c.ey-H-x,c.ex-L-x+y,c.ey-x,"H",c.fx+x+L-y,"Q",c.fx+H+x,c.fy-x-H+y,c.fx+x,c.fy-x-L+y,de?["L",c.gx+x,c.gy+x,"H",c.hx+x]:null,"Z"],["M",a.ax+x,a.ay-y,"H",a.bx-x,b?["L",a.cx-x,a.cy+x,"H",a.dx-x]:null,"L",a.ex-x,a.ey-x-L+y,"Q",a.ex-H-x+y,a.ey-H-x,a.ex-L-x+y,a.ey-x,"H",a.fx+x+L-y,"Q",a.fx+H+x,a.fy-x-H+y,a.fx+x,a.fy-x-L+y,de?["L",a.gx+x,a.gy+x,"H",a.hx+x]:null,"Z"],{class:"key-highlight"}),st=fe(["M",c.ax,c.ay+y,de?["L",c.hx,c.hy,"H",c.gx]:null,"L",c.fx,c.fy-L-y,b?["M",c.cx,c.cy,"H",c.dx]:null],["M",a.ax,a.ay+y,de?["L",a.hx,a.hy,"H",a.gx]:null,"L",a.fx,a.fy-L-y,b?["M",a.cx,a.cy,"H",a.dx]:null],{class:"key-light-border white-key-border"}),it=fe(["M",c.fx,c.fy-L,"Q",c.fx+H,c.fy-H,c.fx+L,c.fy,"H",c.ex-L,"Q",c.ex-H,c.ey-H,c.ex,c.ey-L,b?["L",c.dx,c.dy,"M",c.cx,c.cy]:null,"L",c.bx,c.by+y],["M",a.fx,a.fy-L,"Q",a.fx+H,a.fy-H,a.fx+L,a.fy,"H",a.ex-L,"Q",a.ex-H,a.ey-H,a.ex,a.ey-L,b?["L",a.dx,a.dy,"M",a.cx,a.cy]:null,"L",a.bx,a.by+y],{class:"key-dark-border white-key-border"}),Mo=se(v,C),Po=C+u/2,Bo=B-Re,To=E.makeCircle(Po,Bo,He,{class:"key-sticker white-key-sticker"}),Lt=E.createGroup({class:"key-marker-group",press_transform:`translateY(${qe-Me}px)`});return Lt.appendChild(Mo),Lt.appendChild(To),Se.appendChild(xt),Se.appendChild(Et),Se.appendChild(it),Se.appendChild(st),Se.appendChild(Lt),Se.appendChild(vt),Se}function $(v){return!n.perspective||Xe(v)?0:(v-R)/((88+m)/4)*d.side_width_max}function Z(v,z,C,u,k,L){let S=z,T=S+C,Ae=k/2,ae=k/4,q=$(v)*1.5,ke=q/2,de=q/1.2,b=n.perspective?{left_top:Math.max(0,d.side_width_top+q),left_bottom:Math.max(0,d.side_width_bottom+q),right_top:Math.max(0,d.side_width_top-q),right_bottom:Math.max(0,d.side_width_bottom-q),left_top1:Math.max(0,d.side_width_top+de),left_bottom1:Math.max(0,d.side_width_bottom+ke),right_top1:Math.max(0,d.side_width_top-de),right_bottom1:Math.max(0,d.side_width_bottom-ke)}:{left_top:d.side_width_top,left_bottom:d.side_width_bottom,right_top:d.side_width_top,right_bottom:d.side_width_bottom,left_top1:d.side_width_top,left_bottom1:d.side_width_bottom,right_top1:d.side_width_top,right_bottom1:d.side_width_bottom},h=n.perspective?{left_top:Math.min(S,S+d.side_width_top+q),left_bottom:Math.min(S,S+d.side_width_bottom+q),right_top:Math.max(T,T-d.side_width_top+q),right_bottom:Math.max(T,T-d.side_width_bottom+q),left_top1:Math.min(S,S+d.side_width_top+de),left_bottom1:Math.min(S,S+d.side_width_bottom+ke),right_top1:Math.max(T,T-d.side_width_top+de),right_bottom1:Math.max(T,T-d.side_width_bottom+ke)}:{left_top:S,left_bottom:S,right_top:T,right_bottom:T,left_top1:S,left_bottom1:S,right_top1:T,right_bottom1:T},ne=E.createGroup({id:`key${v}`,class:"key black-key",value:v}),zt=fe(["M",h.left_top,j,"L",h.left_top+b.left_top,ye,"H",h.right_top-b.right_top,"L",h.right_top,j,"L",h.right_bottom,u-d.bottom_height-k,"L",T,u,"H",S,"L",h.left_bottom,u-d.bottom_height-k,"Z"],["M",h.left_top1,j,"L",h.left_top1+b.left_top1,Ee,"H",h.right_top1-b.right_top1,"L",h.right_top1,j,"L",h.right_bottom1,u-d.bottom_height1-k,"L",T,u,"H",S,"L",h.left_bottom1,u-d.bottom_height1-k,"Z"],{class:"key-fill key-touch-area"}),O=ve,Ge=fe(["M",h.left_top+O,j,"L",Math.max(h.left_top+O,h.left_top+b.left_top),ye,"H",Math.min(h.right_top-O,h.right_top-b.right_top),"L",h.right_top-O,j,"L",h.right_bottom-O,u-O-d.bottom_height-Ae,"L",T-O,u-O,"H",S+O,"L",h.left_bottom+O,u-O-d.bottom_height-Ae,"Z"],["M",h.left_top1+O,j,"L",Math.max(h.left_top1+O,h.left_top1+b.left_top1),Ee,"H",Math.min(h.right_top1-O,h.right_top1-b.right_top1),"L",h.right_top1-O,j,"L",h.right_bottom1-O,u-O-d.bottom_height1-Ae,"L",T-O,u-O,"H",S+O,"L",h.left_bottom1+O,u-O-d.bottom_height1-Ae,"Z"],{class:"key-highlight"});if(ne.appendChild(zt),ne.appendChild(Ge),b.left_bottom>0||b.left_top>0){let it=fe(["M",h.left_top,j,"L",h.left_bottom,u,"L",h.left_bottom+b.left_bottom,u-d.bottom_height-k,"L",h.left_top+b.left_top,ye,"Z"],["M",h.left_top1,j,"L",h.left_bottom1,u,"L",h.left_bottom1+b.left_bottom1,u-d.bottom_height1-k,"L",h.left_top1+b.left_top1,Ee,"Z"],{class:"key-left-bevel black-key-bevel"});ne.appendChild(it)}if(b.right_bottom>0||b.right_top>0){let it=fe(["M",h.right_top,j,"L",h.right_bottom,u,"L",h.right_bottom-b.right_bottom,u-d.bottom_height-k,"L",h.right_top-b.right_top,ye,"Z"],["M",h.right_top1,j,"L",h.right_bottom1,u,"L",h.right_bottom1-b.right_bottom1,u-d.bottom_height1-k,"L",h.right_top1-b.right_top1,Ee,"Z"],{class:"key-right-bevel black-key-bevel"});ne.appendChild(it)}let kt=fe(["M",S,u,"H",T,"L",h.right_bottom-b.right_bottom-k,u-d.bottom_height,"H",h.left_bottom+b.left_bottom+k,"Z"],["M",S,u,"H",T,"L",h.right_bottom1-b.right_bottom1-k,u-d.bottom_height1,"H",h.left_bottom1+b.left_bottom1+k,"Z"],{class:"key-bottom-bevel black-key-bevel"});ne.appendChild(kt);let wt=fe(["M",S,u,"L",h.left_bottom+b.left_bottom,u-d.bottom_height-k,"Q",h.left_bottom+b.left_bottom+ae,u-d.bottom_height-ae,h.left_bottom+b.left_bottom+k,u-d.bottom_height,"Z"],["M",S,u,"L",h.left_bottom1+b.left_bottom1,u-d.bottom_height1-k,"Q",h.left_bottom1+b.left_bottom1+ae,u-d.bottom_height1-ae,h.left_bottom1+b.left_bottom1+k,u-d.bottom_height1,"Z"],{class:"key-left-round-bevel black-key-bevel"});ne.appendChild(wt);let c=fe(["M",T,u,"L",h.right_bottom-b.right_bottom,u-d.bottom_height-k,"Q",h.right_bottom-b.right_bottom-ae,u-d.bottom_height-ae,h.right_bottom-b.right_bottom-k,u-d.bottom_height,"Z"],["M",T,u,"L",h.right_bottom1-b.right_bottom1,u-d.bottom_height1-k,"Q",h.right_bottom1-b.right_bottom1-ae,u-d.bottom_height1-ae,h.right_bottom1-b.right_bottom1-k,u-d.bottom_height1,"Z"],{class:"key-right-round-bevel black-key-bevel"});ne.appendChild(c);let a=d.bottom_height*.8,H=d.bottom_height1*.8,Se=fe(["M",L-G,u-a,"h",je,"v",a,"h",-je,"Z"],["M",L-G,u-H,"h",je,"v",H,"h",-je,"Z"],{class:"gap-reflection"});ne.appendChild(Se);let vt=le(v,z),xt=z+C/2+q,x=D-nt,Et=E.makeCircle(xt,x,He,{class:"key-sticker black-key-sticker"}),st=E.createGroup({class:"key-marker-group",press_transform:`translateX(${(ke-q)*.7}px) translateY(${ot-Le}px)`});return st.appendChild(vt),st.appendChild(Et),ne.appendChild(st),ne}function se(v,z){let C=z+te,u=E.createElement("text",{x:C,y:Me,id:`keylabel${v}`,class:"key-label white-key-label"});return u.appendChild(E.createElement("tspan",{x:C})),u}function le(v,z){let C=z+ue+$(v)/2,u=E.createElement("text",{x:C,y:Le,id:`keylabel${v}`,class:"key-label black-key-label"});return u.appendChild(E.createElement("tspan",{x:C})),u.appendChild(E.createElement("tspan",{x:C,dy:"-0.9lh"})),u.appendChild(E.createElement("tspan",{x:C,dy:"-1.0lh"})),u}let re=0,_e=0;for(let v=r;v<=g;v++){let z=v%12;if(Xe(z)){let C=F(v,z,_e,V,B,we);Ke.appendChild(C),t[v]=C,re+=V,_e+=V}else{let C=_e-ue+Fe[z]*ee,u=Z(v,C,ee,D,be,_e);I.appendChild(u),t[v]=u}}e.appendChild(Ke),e.appendChild(E.makeRect(re,he.height,0,he.top,null,null,{id:"top-felt"})),e.appendChild(I);let oe={left:-2,top:-4,width:re+We+2,height:B*Math.max(lt,1)+We+Yo};e.setAttribute("viewBox",`${oe.left} ${oe.top} ${oe.width} ${oe.height}`);function pe(v,z,C=!1,u={}){let k=E.createElement("linearGradient",C?{id:v,x2:"0%",y2:"100%"}:{id:v});for(let L of z)k.appendChild(E.createElement("stop",L));for(let[L,S]of Object.entries(u))k.setAttribute(L,S);return k}let ce=E.createElement("defs");ce.appendChild(pe("white-key-gradient",[{offset:"30%","stop-color":"color-mix(in oklch, var(--color-white-key), white 10%)"},{offset:"100%","stop-color":"color-mix(in oklch, var(--color-white-key), black 10%)"}],!1,{gradientTransform:"rotate(45)"})),ce.appendChild(pe("black-key-gradient",[{offset:"30%","stop-color":"color-mix(in oklch, var(--color-black-key), white 15%)"},{offset:"100%","stop-color":"color-mix(in oklch, var(--color-black-key), black 15%)"}],!1,{gradientTransform:"rotate(45)"})),ce.appendChild(pe("pressed-white-key-highlight-gradient",[{offset:"0%","stop-color":"var(--color-highlight-alpha)","stop-opacity":"50%"},{offset:"40%","stop-color":"var(--color-highlight-alpha)"}],!0)),ce.appendChild(pe("pressed-black-key-highlight-gradient",[{offset:"0%","stop-color":"var(--color-highlight-alpha)","stop-opacity":"50%"},{offset:"50%","stop-color":"var(--color-highlight-alpha)"}],!0)),ce.appendChild(pe("top-felt-gradient",[{offset:"50%","stop-color":"var(--color-felt-top)"},{offset:"100%","stop-color":"var(--color-felt-bottom)"}],!0)),ce.appendChild(pe("gap-reflection-gradient",[{offset:"0%","stop-color":"var(--color-background)","stop-opacity":"0%"},{offset:"100%","stop-color":"var(--color-background)","stop-opacity":"100%"}],!0)),e.appendChild(ce)}function Ut(e,t,n={}){let s=Qt,i=n.height_factor??1,r=n.first_key??noteToMidi("a0"),g=n.last_key??noteToMidi("c8"),m=s*i,R=m*(.14*i+.51),B=We/2,D=je/2,y=s*2.2/15.5,G=s*1.4/15.5,V=y/2,ee=y/3,te=G/2,me=y/17,ue=2,we=2,be={top:-4,height:7,get bottom(){return this.top+this.height}},Ie=be.bottom-1,ve=be.bottom-5,he=m-V*i,xe=R-V*i,j=y/4/2,Ee=j+ee*i,d=Ee;e.innerHTML="";for(let I=0;I<128;I++)(I<r||I>g)&&(t[I]=null);let Me=E.createGroup(),qe=E.createGroup();function Le(I,F,$,Z,se,le){let re=$+B+D,_e=$+Z-B-D,oe=R+B+Ze,pe=I>r&&[2,4,7,9,11].includes(F),ce=I<g&&[0,2,5,7,9].includes(F),v=$+B+(pe?te+G*Fe[F-1]+Ze:D),z=$+Z-B-(ce?te-G*Fe[F+1]+Ze:D),C=E.createGroup({id:`key${I}`,class:"key white-key lowperf",value:I}),u=E.makePath(["M",v,Ie,"H",z,ce?["V",oe,"H",_e]:null,"V",se-le,"L",_e-le,se,"H",re+le,"L",re,se-le,pe?["V",oe,"H",v]:null,"Z"],{class:"key-fill key-touch-area lowperf"}),k=ue,L=E.makePath(["M",v+k,Ie-B,"H",z-k,ce?["V",oe+k,"H",_e-k]:null,"V",se-k-le+B,"L",_e-le-k+B,se-k,"H",re+k+le-B,"L",re+k,se-k-le+B,pe?["V",oe+k,"H",v+k]:null,"Z"],{class:"key-highlight lowperf"}),S=at(I,$),T=$+Z/2,Ae=m-Ee,ae=E.makeCircle(T,Ae,j,{class:"key-sticker white-key-sticker lowperf"}),q=E.createGroup({class:"key-marker-group lowperf"});return q.appendChild(S),q.appendChild(ae),C.appendChild(u),C.appendChild(L),C.appendChild(q),C}function ot(I,F,$,Z){let se=F,le=se+$,re=E.createGroup({id:`key${I}`,class:"key black-key lowperf",value:I}),_e=E.makePath(["M",se,ve,"H",le,"V",Z,"H",se,"Z"],{class:"key-fill key-touch-area lowperf"}),oe=we,pe=E.makePath(["M",se+oe,ve+oe,"H",le-oe,"V",Z-oe,"H",se+oe,"Z"],{class:"key-highlight lowperf"}),ce=He(I,F),v=F+$/2,z=R-d,C=E.makeCircle(v,z,j,{class:"key-sticker black-key-sticker lowperf"}),u=E.createGroup({class:"key-marker-group lowperf"});return u.appendChild(ce),u.appendChild(C),re.appendChild(_e),re.appendChild(pe),re.appendChild(u),re}function at(I,F){let $=F+V,Z=E.createElement("text",{x:$,y:he,id:`keylabel${I}`,class:"key-label white-key-label lowperf"});return Z.appendChild(E.createElement("tspan",{x:$})),Z}function He(I,F){let $=F+te,Z=E.createElement("text",{x:$,y:xe,id:`keylabel${I}`,class:"key-label black-key-label lowperf"});return Z.appendChild(E.createElement("tspan",{x:$})),Z.appendChild(E.createElement("tspan",{x:$,dy:"-0.9lh"})),Z.appendChild(E.createElement("tspan",{x:$,dy:"-1.0lh"})),Z}let Re=0,nt=0;for(let I=r;I<=g;I++){let F=I%12;if(Xe(F)){let $=Le(I,F,nt,y,m,me);Me.appendChild($),t[I]=$,Re+=y,nt+=y}else{let $=nt-te+Fe[F]*G,Z=ot(I,$,G,R);qe.appendChild(Z),t[I]=Z}}e.appendChild(Me),e.appendChild(E.makeRect(Re,be.height,0,be.top,null,null,{id:"top-felt",class:"lowperf"})),e.appendChild(qe);let Ke={left:-2,top:-4,width:Re+We+2,height:m*lt+We+4};e.setAttribute("viewBox",`${Ke.left} ${Ke.top} ${Ke.width} ${Ke.height}`)}function fe(e,t,n={}){let s=E.createElement("path",n);return e=e.filter(i=>i!=null).map(i=>Array.isArray(i)?i.join(" "):i).join(" "),t=t.filter(i=>i!=null).map(i=>Array.isArray(i)?i.join(" "):i).join(" "),s.setAttribute("d0",e),s.setAttribute("d1",t),s}var Uo=[!0,!1,!0,!1,!0,!0,!1,!0,!1,!0,!1,!0];function Xe(e){return Uo[e%12]}var Y={onKeyPress:null,onKeyRelease:null,onSustain:null,onReset:null,get enabled(){return K.enabled},get velocity(){return K.velocity},set velocity(e){e<0&&(e=0),e>127&&(e=127),K.velocity=e},enable(e=null,t=null,n=null,s=null){e&&(this.onKeyPress=e),t&&(this.onKeyRelease=t),n&&(this.onSustain=n),s&&(this.onReset=s),Jo()},disable(){en()},isNotePressed(e){return K.pressed_keys.has(e)},isNoteSustained(e){return K.pressed_keys.has(e)||K.sustain_keys.has(e)},isSustainActive(){return K.sustain},resetState(){K.reset(),this.onReset?.()}},K={enabled:!1,pressed_keys:new Set([]),sustain_keys:new Set([]),sustain:!1,velocity:88,map:new Map([["KeyZ",48],["KeyS",49],["KeyX",50],["KeyD",51],["KeyC",52],["KeyV",53],["KeyG",54],["KeyB",55],["KeyH",56],["KeyN",57],["KeyJ",58],["KeyM",59],["KeyW",60],["Digit3",61],["KeyE",62],["Digit4",63],["KeyR",64],["KeyT",65],["Digit6",66],["KeyY",67],["Digit7",68],["KeyU",69],["Digit8",70],["KeyI",71],["KeyO",72],["Digit0",73],["KeyP",74],["KeyQ",59],["Digit1",58],["Comma",60],["KeyL",61],["Period",62],["Semicolon",63],["Slash",64],["IntlRo",65],["Backslash",66],["Minus",75],["BracketLeft",76],["BracketRight",77],["IntlBackslash",47]]),reset(){this.pressed_keys.clear(),this.sustain_keys.clear(),this.sustain=!1}};function Jo(){K.enabled||(K.enabled=!0,window.addEventListener("keydown",eo),window.addEventListener("keyup",to))}function en(){K.enabled&&(window.removeEventListener("keydown",eo),window.removeEventListener("keyup",to),K.enabled=!1,K.reset())}function tn(e){K.pressed_keys.add(e),K.sustain&&K.sustain_keys.add(e),Y.onKeyPress?.(e,K.velocity)}function on(e){K.pressed_keys.delete(e),Y.onKeyRelease?.(e)}function Jt(e){if(K.sustain!=e){if(K.sustain=e,e)for(let t of K.pressed_keys)K.sustain_keys.add(t);else K.sustain_keys.clear();Y.onSustain(e)}}function eo(e){if(!(e.ctrlKey||e.altKey)){if(e.code.startsWith("Shift"))e.preventDefault(),Jt(!0);else if(K.map.has(e.code)){if(e.preventDefault(),e.repeat)return;let t=K.map.get(e.code);tn(t)}}}function to(e){if(e.code.startsWith("Shift")&&!e.shiftKey&&(e.preventDefault(),Jt(!1)),K.map.has(e.code)){if(e.preventDefault(),e.repeat)return;let t=K.map.get(e.code);on(t)}}var ht=class{#e=null;#o="";constructor(t,n){switch(t){case"local":this.#e=localStorage;break;case"session":this.#e=sessionStorage;break;default:throw Error(`Invalid storage type: "${t}".`)}n!=""&&(this.#o=n+"_"),this.#o.replace(" ","_")}#t(t){return this.#o+t}isAvailable(){try{let t="__storage_test__";return this.#e.setItem(t,t),this.#e.removeItem(t),!0}catch(t){return t instanceof DOMException&&t.name==="QuotaExceededError"&&this.#e&&this.#e.length!==0}}readString(t,n=""){try{if(!this.isAvailable())throw Error();let s=this.#e.getItem(this.#t(t));return s??n}catch{return n}}writeString(t,n){try{if(!this.isAvailable())throw Error();this.#e.setItem(this.#t(t),n)}catch{return!1}return!0}readNumber(t,n=0){let s=this.readString(t,n);return isNaN(s)?n:Number(s)}writeNumber(t,n){return isNaN(n)?!1:this.writeString(t,n.toString())}readBool(t,n=!1){return this.readString(t,n.toString())==="true"}writeBool(t,n){return n!=!0&&n!=!1?!1:this.writeString(t,n.toString())}remove(t){try{if(!this.isAvailable())throw Error();this.#e.removeItem(this.#t(t))}catch{return!1}return!0}has(t){return this.isAvailable()&&this.#e.getItem(this.#t(t))!==null}keys(){let t=[],n=this.#o.length;for(let s=0;s<this.#e.length;s++){let i=this.#e.key(s);i.startsWith(this.#o)&&t.push(i.substring(n))}return t}clear(){for(let t of this.keys())this.remove(t)}},pt=class extends ht{constructor(t){super("local",t)}},ft=class extends ht{constructor(t){super("session",t)}};var Bt=class{#e;#o;#t=[];#n=[];#c=[];#i;#l=!1;#s=!1;get visible(){return this.#s}onshow=void 0;onhide=void 0;onmenuenter=void 0;onoptionenter=void 0;constructor(t,n,s="alt"){this.#e=t,this.#o=n,this.#i=s,this.enable()}enable(){this.#l||(this.#l=!0,window.addEventListener("keydown",t=>this.#d(t)),window.addEventListener("keyup",t=>this.#u(t)),window.addEventListener("blur",()=>this.#h()))}disable(){this.#l&&(window.removeEventListener("keydown",t=>this.#d(t)),window.removeEventListener("keyup",t=>this.#u(t)),window.removeEventListener("blur",()=>this.#h()),this.#l=!1)}get container(){return this.#e}replaceStructure(t){this.#o=t,this.#s&&this.#r()}#f(){this.#s==!1&&(this.#s=!0,this.#t=[0],this.onshow?.(),this.#e.hidden=!1,this.#e.focus()),this.#r()}#m(t){this.#t.push(t),this.onmenuenter?.(this.#n[t].text)}#_(){this.#t.length>1&&(this.#t.pop(),this.onmenuenter?.(this.#c.text))}#r(){this.#e.innerHTML="";let t=document.createElement("sl-breadcrumb");this.#e.appendChild(t);let n=this.#o;for(let r of this.#t){let g=document.createElement("sl-breadcrumb-item");g.innerHTML=no(n[r][0]),n=n[r][1],t.appendChild(g)}this.#n=[];for(let[r,g]of n.entries()){this.#c=this.#n;let m=g[1]===null||g[2]?.noindex?g[0]:`&${r+1}: ${g[0]}`;this.#n.push({html:oo(m),text:no(g[0]),action:Array.isArray(g[1])?r:g[1],keys:g[2]?.key?so(m).concat([g[2].key]):so(m),checkbox:g[2]?Object.hasOwn(g[2],"checked"):!1,checked:g[2]?.checked})}this.#t.length>1&&this.#n.push({html:oo("&0: Back"),text:"Back",action:()=>this.#_(),keys:["0"]});let s=this.#n.map(r=>r.checkbox?`<span check-item${r.checked?" checked":""}><span class="checkbox">${r.checked?"\u{1F5F9}":"\u2610"}</span> ${r.html}</span>`:`<span>${r.html}</span>`).join("|"),i=document.createElement("sl-breadcrumb-item");i.innerHTML=s,t.appendChild(i)}#a(){this.#s&&(this.#s=!1,this.#e.hidden=!0,this.onhide?.())}#d(t){if(!t.repeat){if(this.#p(t))t.preventDefault(),this.#f();else if(this.#g(t)){let n=!1,s=t.key.toLowerCase();for(let i of this.#n)i.keys.includes(s)&&i.action!==null&&(n=!0,typeof i.action=="number"?this.#m(i.action):typeof i.action=="function"&&(i.action(),this.onoptionenter?.()));this.#r(),(n||s.length==1)&&t.preventDefault()}}}#u(t){this.#p(t)&&(t.preventDefault(),this.#a())}#h(){this.#s&&this.#a()}#p(t){return t.key.toLowerCase()==this.#i||t.code.toLowerCase().startsWith(this.#i)}#g(t){return[this.#i=="ctrl"&&t.ctrlKey,this.#i=="alt"&&t.altKey,this.#i=="shift"&&t.shiftKey].filter(n=>n).length==1}};function oo(e){return e.replace(/&(.)/g,"<u>$1</u>")}function no(e){return e.replaceAll("&","")}function so(e){return e.match(/(?<=&)./g)?.map(n=>n.toLowerCase())??[]}var io=Bt;var w=new pt("piano-projector"),Ue=new ft("piano-projector-session"),o={first_time:!0,lowperf:!1,number_of_keys:88,height_factor:1,device_name:null,sound:null,offset:{x:.5,y:.5},labels:{type:"english",octave:!0,played:!1,keys:new Set,toggle(e,t=void 0){t=t??!this.keys.has(e),t?this.keys.add(e):this.keys.delete(e),Te(e),P()},keysToStr(){return[...this.keys].join(",")},strToKeys(e){if(this.keys.clear(),e)for(let t of e.split(",")){let n=parseInt(t);Number.isInteger(n)&&this.keys.add(n)}},get type_badge(){return{english:"English",german:"German",italian:"Italian",pc:"Pitch-class",midi:"MIDI",freq:"Frequency"}[this.type]}},stickers:{color:"red",keys:new Map,toggle(e,t=void 0){t=t??!this.keys.has(e),t?this.keys.set(e,this.color):this.keys.delete(e),Te(e),P()},keysToStr(){let e=[];for(let[t,n]of this.keys.entries())e.push(`${t}:${n}`);return e.join(",")},strToKeys(e){if(this.keys.clear(),e)for(let t of e.split(",")){let[n,s]=t.split(":"),i=parseInt(n);Number.isInteger(i)&&this.keys.set(i,s)}}},zoom:1,pedals:!0,pedal_dim:!0,perspective:!0,top_felt:!0,toolbar:!0,semitones:0,octaves:0,get transpose(){return this.semitones+this.octaves*12},get highlight_opacity(){return getComputedStyle(document.documentElement).getPropertyValue("--highlight-opacity")},set highlight_opacity(e){document.documentElement.style.setProperty("--highlight-opacity",e)},get color_highlight(){return getComputedStyle(document.documentElement).getPropertyValue("--color-highlight")},set color_highlight(e){document.documentElement.style.setProperty("--color-highlight",e)},get color_white(){return getComputedStyle(document.documentElement).getPropertyValue("--color-white-key")},set color_white(e){document.documentElement.style.setProperty("--color-white-key",e)},get color_black(){return getComputedStyle(document.documentElement).getPropertyValue("--color-black-key")},set color_black(e){document.documentElement.style.setProperty("--color-black-key",e)},get color_top_felt(){return getComputedStyle(document.documentElement).getPropertyValue("--color-felt-top")},set color_top_felt(e){document.documentElement.style.setProperty("--color-felt-top",e)},get pc_keyboard_connected(){return this.device_name==="pckbd"}},N={ports:[],get menu_items(){return Array.from(l.menus.connect.querySelectorAll(".menu-connect-item-midi-input"))},get connected_port(){return A.getConnectedPort()},access:"unavailable",queryAccess(e=null){A.queryMidiAccess(t=>{this.access=t,e?.(this.access)})},requestAccess(e=null){A.requestMidiAccess(()=>{this.access="granted",e?.(!0)},()=>{this.access="denied",e?.(!1)})},requestPorts(e=null){A.requestInputPortList(t=>{this.ports=t,e?.(t)},()=>{this.ports=null,e?.(null)})},clearMenuItems(){for(let e of this.menu_items)e.remove()},watchdog_id:null,setWatchdog(e){this.watchdog_id&&clearInterval(this.watchdog_id),this.watchdog_id=setInterval(Io,e)}},_={type:"",loaded:!1,led:null,audio_ctx:null,player:null,get loading(){return this.type&&!this.loaded},play(e,t=100){this.type=="epiano1"?e+=12:this.type=="harpsi"&&(t=127),this.player?.start({note:e+o.transpose,velocity:t})},stop(e,t){this.type=="epiano1"&&(e+=12),(t||!(A.isNoteOn(e,o.pedals?"both":"none")||Y.isNoteSustained(e))&&!(this.type=="apiano"&&e+o.transpose>88))&&this.player?.stop(e+o.transpose)},stopAll(e){if(e)this.player?.stop();else for(let t=0;t<128;t++)this.stop(t,!1)},fail_alert:document.getElementById("alert-sound-connection-fail"),apiano:null,epiano:null,versilian:null,cache:null},Q={state:0,origin:{x:0,y:0},previous_offset:{x:0,y:0}},M={enabled:!1,points:new Map,started(e=null){return e!==null?this.points.has(e):this.points.size>0},has_note(e){for(let t of this.points.values())if(t.has(e))return!0;return!1},add(e,t){this.points.has(e)&&(t=this.points.get(e).union(t)),this.points.set(e,t);for(let n of t.values())_.play(n),Te(n)},change(e,t){let n=0,s=new Set().union(this.points.get(e));this.points.set(e,t);for(let i of s.values())t.has(i)||(_.stop(i),Te(i),n=-1);for(let i of t.values())s.has(i)||(_.play(i),Te(i),n=1);return n},remove(e){let t=this.points.get(e);this.points.delete(e);for(let n of t.values())this.has_note(n)||_.stop(n),Te(n)},reset(){this.points.clear(),_.stopAll()},enable(){this.enabled=!0,$e()},disable(){this.reset(),this.enabled=!1,$e()}},l={self:document.getElementById("top-toolbar"),title:document.getElementById("toolbar-title"),dropdowns:{connect:document.getElementById("dropdown-connect"),sound:document.getElementById("dropdown-sound"),transpose:document.getElementById("dropdown-transpose"),size:document.getElementById("dropdown-size"),colors:document.getElementById("dropdown-colors"),pedals:document.getElementById("dropdown-pedals"),labels:document.getElementById("dropdown-labels"),stickers:document.getElementById("dropdown-stickers"),get all(){return[this.connect,this.sound,this.transpose,this.size,this.colors,this.pedals,this.labels,this.stickers]},closeAll(){for(let e of this.all)e.hide()},getOpen(){return this.all.find(e=>e.open)??null}},buttons:{connect:document.getElementById("btn-connect"),sound:document.getElementById("btn-sound"),transpose:document.getElementById("btn-transpose"),size:document.getElementById("btn-size"),colors:document.getElementById("btn-colors"),pedals:document.getElementById("btn-pedals"),labels_group:document.getElementById("btn-labels-group"),labels_left:document.getElementById("btn-labels-switch"),labels_right:document.getElementById("btn-labels-dropdown"),stickers_group:document.getElementById("btn-labels-group"),stickers_left:document.getElementById("btn-stickers-switch"),stickers_right:document.getElementById("btn-stickers-dropdown"),panic:document.getElementById("btn-panic"),hide_toolbar:document.getElementById("btn-hide-toolbar"),show_toolbar:document.getElementById("btn-show-toolbar")},menus:{connect:document.getElementById("midi-connection-menu"),sound:document.getElementById("menu-sound"),transpose:{top:document.getElementById("menu-transpose"),semitones:{input:document.getElementById("input-semitones"),btn_minus:document.getElementById("btn-semitone-minus"),btn_plus:document.getElementById("btn-semitone-plus")},octaves:{input:document.getElementById("input-octaves"),btn_minus:document.getElementById("btn-octave-minus"),btn_plus:document.getElementById("btn-octave-plus")},item_reset:document.getElementById("reset-transpose")},size:document.getElementById("menu-size"),colors:{top:document.getElementById("menu-colors"),highlight_opacity:document.getElementById("menu-highlight-opacity"),picker_color_white:document.getElementById("color-white"),picker_color_black:document.getElementById("color-black"),picker_color_pressed:document.getElementById("color-pressed"),item_perspective:document.getElementById("menu-perspective"),item_top_felt:document.getElementById("menu-top-felt")},labels:{top:document.getElementById("menu-labels-top"),labeling_mode:document.getElementById("menu-labeling-mode"),played:document.getElementById("menu-labels-played-keys"),presets:document.getElementById("menu-labels-which"),type:document.getElementById("menu-labels-type"),octave:document.getElementById("menu-item-labels-octave")},stickers:{top:document.getElementById("menu-stickers-top"),clear:document.getElementById("menu-stickers-clear")},pedals:{top:document.getElementById("pedal-menu"),item_follow:document.getElementById("menu-pedal-follow"),item_dim:document.getElementById("menu-pedal-dim")}},resize:{observer:null,timeout:null}},lo=[{elm:l.title,action:"hide-elm"},{elm:l.buttons.sound,action:"hide-label"},{elm:l.buttons.connect,action:"hide-label"},{elm:l.buttons.pedals,action:"hide-label"},{elm:l.buttons.transpose,action:"hide-label"},{elm:l.buttons.stickers_left,action:"hide-label"},{elm:l.buttons.labels_left,action:"hide-label"},{elm:l.dropdowns.colors,action:"hide-elm"},{elm:l.dropdowns.size,action:"hide-elm"},{elm:l.dropdowns.sound,action:"hide-elm"},{elm:l.dropdowns.pedals,action:"hide-elm"},{elm:l.buttons.stickers_group,action:"hide-elm"},{elm:l.buttons.labels_group,action:"hide-elm"},{elm:l.buttons.panic,action:"hide-elm"},{elm:l.self,action:"hide-elm"}],f={svg:document.querySelector("svg#piano"),container:document.getElementById("main-area"),first_key:null,last_key:null,keys:Array(128).fill(null),labels:Array(128).fill(null),marking_groups:Array(128).fill(null),loaded:!1,resize:{timeout:null,observer:null}},W=null,nn=["\u208B\u2081","\u2080","\u2081","\u2082","\u2083","\u2084","\u2085","\u2086","\u2087","\u2088","\u2089"],sn=["\u207B\xB2","\u207B\xB9","\xB9","\xB2","\xB3","\u2074","\u2075","\u2076","\u2077","\u2078","\u2079","\xB9\u2070"],ln=["\u208B\u2082","\u208B\u2081","\u2081","\u2082","\u2083","\u2084","\u2085","\u2086","\u2087","\u2088","\u2089","\u2081\u2080"],ro=["C","C\u266F","D","D\u266F","E","F","F\u266F","G","G\u266F","A","A\u266F","B"],rn=[,"D\u266D",,"E\u266D",,,"G\u266D",,"A\u266D",,"B\u266D"],mt=["C","Ces","D","Des","E","F","Fes","G","Ges","A","Aes","H"],co=[,"Dis",,"Eis",,,"Gis",,"Ais",,"B"],ao=["do","do\u266F","re","re\u266F","mi","fa","fa\u266F","sol","sol\u266F","la","la\u266F","si"],cn=[,"re\u266D",,"mi\u266D",,,"sol\u266D",,"la\u266D",,"si\u266D"];function uo(e){let t=new Set;switch(e){case"mc":t.add(60);break;case"cs":for(let n of Ve(0,128,12))t.add(n);break;case"white":for(let n of Ve(0,128))Xe(n)&&t.add(n);break;case"all":for(let n of Ve(0,128))t.add(n);break}return t}function ho(){for(let e of["none","mc","cs","white","all"]){let t=uo(e);if(o.labels.keys.symmetricDifference(t).size==0)return e}return"custom"}function rt(){let e=new Map([[88,["a0","c8"]],[61,["c2","c7"]],[49,["c2","c6"]],[37,["c3","c6"]],[25,["c3","c5"]],[20,["f3","c5"]]]).get(o.number_of_keys);f.first_key=Mt(e[0]),f.last_key=Mt(e[1]);let t={height_factor:o.height_factor,perspective:o.perspective,top_felt:o.top_felt,first_key:f.first_key,last_key:f.last_key};o.lowperf?Ut(f.svg,f.keys,t):Yt(f.svg,f.keys,t);for(let[n,s]of f.keys.entries())f.marking_groups[n]=s?.querySelector(".key-marker-group"),f.labels[n]=s?.querySelector(".key-label");f.loaded=!0,fo()}function po(){document.getElementById("top-felt")?.toggleAttribute("hidden",!o.top_felt)}function Te(e){let t=f.keys[e];if(t){let n=e-o.transpose,i=M.has_note(e)||A.isKeyPressed(n)||Y.isNotePressed(n),r=i||A.isNoteOn(n,o.pedals?"both":"none")||Y.isNoteSustained(n);t.classList.toggle("active",r),t.classList.toggle("pressed",i),t.classList.toggle("dim",o.pedal_dim&&r&&!i);let g=i?"d1":"d0";for(let m of t.children)m.hasAttribute(g)&&m.setAttribute("d",m.getAttribute(g));an(e,r,i)}}function J(e=Ve(0,128)){for(let t of e)Te(t)}function an(e,t,n){let s=f.keys[e],i=f.marking_groups[e],r=f.labels[e];function g(){let m=e%12,R=Math.trunc(e/12),B=Xe(m),D="";switch(o.labels.type){case"pc":D=`${m}`;break;case"english":let G=o.labels.octave?nn[R]:"";D=B?`${ro[m]}${G}`:`${rn[m]}
${ro[m]}
${G}`;break;case"german":if(R>=4){let te=o.labels.octave?"\u2019".repeat(R-4):"";D=B?`${mt[m].toLowerCase()}${te}`:`${co[m].toLowerCase()}
${mt[m].toLowerCase()}`}else{let te=o.labels.octave?",".repeat(Math.abs(R-3)):"";D=B?`${mt[m]}${te}`:`${co[m]}
${mt[m]}`}break;case"italian":let V=o.labels.octave?B?sn[R-1]:ln[R-1]:"";D=B?`${ao[m]}${V}`:`${cn[m]}
${ao[m]}
${V}`;break;case"freq":let ee=Ft(M.enabled?e+o.transpose:e);D=`${ee.toFixed(ee<1e3?1:0)}`;break;default:D=`${e}`}let y=D.split(`
`);for(let[G,V]of Array.from(r.children).entries())V.textContent=y[G]??""}if(s){let m=o.labels.keys.has(e),R=m||o.labels.played&&t,B=o.labels.played&&!m;R&&g(),s.classList.toggle("label-visible",R),s.classList.toggle("has-fixed-label",m),s.classList.toggle("has-temporary-label",B),r.classList.toggle("rotated",o.labels.type=="freq");let D=o.stickers.keys.has(e),y=D?o.stickers.keys.get(e):null;s.classList.toggle("has-sticker",D),s.classList.toggle("has-sticker-red",y=="red"),s.classList.toggle("has-sticker-yellow",y=="yellow"),s.classList.toggle("has-sticker-green",y=="green"),s.classList.toggle("has-sticker-blue",y=="blue"),s.classList.toggle("has-sticker-violet",y=="violet"),n&&i.hasAttribute("press_transform")?i.style.setProperty("transform",i.getAttribute("press_transform")):i.style.removeProperty("transform")}}function $e(){f.svg.classList.toggle("touch-input",M.enabled),f.svg.classList.toggle("grabbing",Q.state),f.svg.classList.toggle("marking-mode",W)}function fo(){J(),po(),ze(),$e()}function et(){Ce("pedr",Y.isSustainActive()||A.sustain_pedal_value/127),Ce("pedm",A.sostenuto_pedal_value/127),Ce("pedl",A.soft_pedal_value/127)}function U(){Ce("connection-power-icon",o.pc_keyboard_connected||M.enabled||o.device_name&&A.getConnectedPort()),Ce("transpose-power-icon",o.transpose!=0),Ce("sound-power-icon",_.led,_.led==1?"red":null),Ce("labels-power-icon",W=="label"),Ce("stickers-power-icon",W=="sticker",{red:"red",yellow:"yellow",green:"#0b0",blue:"blue",violet:"violet"}[o.stickers.color]),l.self.toggleAttribute("hidden",!o.toolbar),l.buttons.show_toolbar.toggleAttribute("hidden",o.toolbar),l.dropdowns.pedals.toggleAttribute("hidden",M.enabled),et()}function mo(){for(let e of lo)e.action=="hide-elm"?e.elm.classList.toggle("condensed-toolbar-hidden-elm",!1):e.action=="hide-label"&&e.elm.classList.toggle("condensed-toolbar-hidden-label",!1);for(let e of lo){if(l.self.scrollWidth<=l.self.clientWidth)break;e.action=="hide-elm"?e.elm.classList.toggle("condensed-toolbar-hidden-elm",!0):e.action=="hide-label"&&e.elm.classList.toggle("condensed-toolbar-hidden-label",!0)}}function _o(){if(_.type&&!_.loaded)for(let e of l.menus.sound.querySelectorAll(".menu-sound-item"))e.toggleAttribute("disabled",!e.hasAttribute("loading")),e.checked=!1;else for(let e of l.menus.sound.querySelectorAll(".menu-sound-item"))e.toggleAttribute("disabled",!1),e.checked=e.value==_.type&&!e.hasAttribute("loading")}function Ht(){for(let e of l.dropdowns.size.querySelectorAll(".btn-number-of-keys")){let t=parseInt(e.value)==o.number_of_keys;e.variant=t?"neutral":null}for(let e of l.dropdowns.size.querySelectorAll(".btn-key-depth")){let t=parseFloat(e.value)==o.height_factor;e.variant=t?"neutral":null}}function go(){l.menus.colors.picker_color_white.value=o.color_white,l.menus.colors.picker_color_black.value=o.color_black,l.menus.colors.picker_color_pressed.value=o.color_highlight,l.menus.colors.item_perspective.checked=o.perspective,l.menus.colors.item_perspective.hidden=o.lowperf,l.menus.colors.item_top_felt.checked=o.top_felt;for(let e of l.menus.colors.highlight_opacity.children)e.checked=e.value==o.highlight_opacity.toString()}function Kt(){l.menus.pedals.item_follow.checked=o.pedals,l.menus.pedals.item_dim.checked=o.pedal_dim,l.menus.pedals.item_dim.toggleAttribute("disabled",!o.pedals)}function tt(){l.menus.labels.labeling_mode.checked=W=="label",l.menus.labels.played.checked=o.labels.played;let e=ho();for(let t of l.menus.labels.presets.children)t.checked=t.value===e;l.menus.labels.presets.nextElementSibling.innerText={none:"None",mc:"Middle-C",cs:"C's",white:"White",all:"All",custom:"Custom"}[e];for(let t of l.menus.labels.type.children)t.value!="octave"&&(t.checked=t.value===o.labels.type);l.menus.labels.type.nextElementSibling.innerText=o.labels.type_badge,l.menus.labels.octave.disabled=["pc","midi","freq"].includes(o.labels.type),l.menus.labels.octave.checked=o.labels.octave}function Nt(){let e=W=="sticker";for(let t of l.menus.stickers.top.children)if(t.getAttribute("type")=="checkbox"){let n=t.value==o.stickers.color;t.checked=e&&n,t.querySelector(".menu-keyboard-shortcut").classList.toggle("invisible",!n)}l.menus.stickers.clear.disabled=o.stickers.keys.size==0}function bo(){l.menus.transpose.semitones.input.value=o.semitones,l.menus.transpose.octaves.input.value=o.octaves,l.menus.transpose.item_reset.toggleAttribute("disabled",o.transpose==0),Ce("transpose-power-icon",o.transpose!=0)}function ze(){let e=f.container.clientHeight/f.svg.clientHeight;o.zoom>1?(o.zoom>e&&(o.zoom=e),f.svg.style.transform=`scale(${o.zoom}, ${o.zoom})`):f.svg.style.removeProperty("transform");let t=f.svg.getBoundingClientRect(),n=f.container.getBoundingClientRect(),s=(n.height-t.height)*o.offset.y;f.svg.style.top=`${s}px`;let i=Math.round((t.width-n.width)*o.offset.x);f.container.scroll(i,0),ge.container.toggleAttribute("position-top",o.offset.y>.5)}function Tt(e){let t=e+o.transpose;t>=0&&t<128&&Te(t)}function bt(){o.toolbar=!o.toolbar,U(),ze(),P()}function Dt(){_.stopAll(!0),A.reset(),M.reset(),Y.resetState(),rt(),et(),l.buttons.panic.setAttribute("variant","danger"),setTimeout(()=>{l.buttons.panic.removeAttribute("variant")},1e3)}function ie(e={}){let t=o.transpose;e.reset&&(o.semitones=0,o.octaves=0),e.set?(Object.hasOwn(e,"semitones")&&(o.semitones=e.semitones),Object.hasOwn(e,"octaves")&&(o.octaves=e.octaves)):(Object.hasOwn(e,"semitones")&&(o.semitones=Ne(o.semitones+e.semitones,-11,11)),Object.hasOwn(e,"octaves")&&(o.octaves=Ne(o.octaves+e.octaves,-2,2))),t!=o.transpose&&_.stopAll(!0),bo(),J(),P()}function Qe(e){o.number_of_keys=e,o.zoom=1,Ht(),rt(),P()}function yo(e){o.height_factor=e,Ht(),rt(),P()}function dn(){yo(Rt(o.height_factor,[1,.75,.5]))}function Ye(e){o.labels.keys=uo(e),tt(),J(),P()}function De(e){o.labels.type=e,tt(),J(),P()}function Ot(e){W=e||null,$e(),U()}function yt(e=void 0){e===void 0&&(e=W!="label"),Ot(e?"label":null),tt()}function Pe(e=void 0,t=o.stickers.color){e===void 0&&(e=W!="sticker"||t!=o.stickers.color),o.stickers.color=t,Ot(e?"sticker":null),Nt()}function ko(){o.stickers.keys.clear(),J(),Nt(),P()}function wo(e=void 0){o.labels.played=e===void 0?!o.labels.played:e,tt(),J(),P()}function vo(e=void 0){o.labels.octave=e===void 0?!o.labels.octave:e,tt(),J(),P()}function un(e=void 0){o.pedals=e===void 0?!o.pedals:e,Kt(),J(),P()}function hn(e=void 0){o.pedal_dim=e===void 0?!o.pedal_dim:e,Kt(),J(),P()}function P(){w.writeBool("first-time",!1),w.writeNumber("height-factor",o.height_factor),w.writeNumber("number-of-keys",o.number_of_keys),w.writeString("color-pressed",o.color_highlight),w.writeString("color-white",o.color_white),w.writeString("color-black",o.color_black),w.writeString("labels-type",o.labels.type),w.writeBool("labels-octave",o.labels.octave),w.writeBool("labels-played",o.labels.played),w.writeString("labels-keys",o.labels.keysToStr()),w.writeString("sticker-color",o.stickers.color),w.writeString("stickers-keys",o.stickers.keysToStr()),w.writeBool("perspective",o.perspective),w.writeBool("top-felt",o.top_felt),w.writeString("highlight-opacity",o.highlight_opacity),w.writeBool("pedals",o.pedals),w.writeBool("pedal-dim",o.pedal_dim),w.writeNumber("offset-y",o.offset.y),o.device_name?w.writeString("device",o.device_name):w.remove("device"),w.writeString("sound",_.type),Ue.writeNumber("semitones",o.semitones),Ue.writeNumber("octaves",o.octaves),Ue.writeBool("toolbar",o.toolbar)}function pn(){o.first_time=w.readBool("first-time",!0),o.lowperf=w.readBool("lowperf",o.lowperf),o.height_factor=w.readNumber("height-factor",X()?.75:o.height_factor),o.number_of_keys=w.readNumber("number-of-keys",X()?20:o.number_of_keys),o.color_white=w.readString("color-white",o.color_white),o.color_black=w.readString("color-black",o.color_black),o.color_highlight=w.readString("color-pressed",o.color_highlight),o.labels.type=w.readString("labels-type",o.labels.type),o.labels.octave=w.readBool("labels-octave",o.labels.octave),o.labels.played=w.readBool("labels-played",o.labels.played),o.labels.strToKeys(w.readString("labels-keys","")),o.stickers.color=w.readString("sticker-color",o.stickers.color),o.stickers.strToKeys(w.readString("stickers-keys","")),o.perspective=w.readBool("perspective",o.perspective),o.top_felt=w.readBool("top-felt",o.top_felt),o.highlight_opacity=w.readString("highlight-opacity",o.highlight_opacity),o.pedals=w.readBool("pedals",o.pedals),o.pedal_dim=w.readBool("pedal-dim",o.pedal_dim),o.offset.y=w.readNumber("offset-y",o.offset.y),o.device_name=w.readString("device",null),o.sound=w.readString("sound",""),o.semitones=Ue.readNumber("semitones",0),o.octaves=Ue.readNumber("octaves",0),o.toolbar=Ue.readBool("toolbar",o.toolbar)}function fn(){let e=Gt("mode").toLowerCase();["lp","lowperf"].includes(e)?(o.lowperf=!0,w.writeBool("lowperf",!0)):["hp","highperf"].includes(e)&&(o.lowperf=!1,w.writeBool("lowperf",!1))}function Ce(e,t,n=null){let s=document.getElementById(e);s.classList.toggle("active",t),t&&n?s.style.color=n:s.style.removeProperty("color"),s.style.setProperty("--led-intensity",`${t*100}%`)}function mn(e=null){e===null&&(e=!o.pc_keyboard_connected),e?Je("pckbd"):$t()}function _n(e=null){e===null&&(e=!M.enabled),e?Je("touch"):$t()}function Je(e,t=!1){switch(A.disconnect(),_.stopAll(),e){case"pckbd":Y.enable(),M.disable(),o.device_name="pckbd",U(),fo(),t&&P();break;case"touch":Y.disable(),M.enable(),o.device_name="touch",U(),J(),t&&P();break;default:Y.disable(),M.disable(),o.device_name=null,U(),J(),A.connectByPortName(e,()=>{o.device_name=e,U(),ge.visible&&ge.replaceStructure(ct()),t&&P()})}}function $t(e=!1){A.disconnect(),Y.disable(),M.disable(),o.device_name=null,U(),J(),e&&P()}function gt(e,t=!1){e&&o.device_name!=e?Je(o.device_name==e?"":e,t):$t(t)}function Oe(){let e=l.menus.connect.querySelector("sl-divider");if(document.getElementById("menu-connect-item-midi-denied").toggleAttribute("hidden",N.access!="denied"),document.getElementById("menu-connect-item-midi-unavailable").toggleAttribute("hidden",X()||N.access!="unavailable"),document.getElementById("menu-connect-item-midi-prompt").toggleAttribute("hidden",N.access!="prompt"),e.toggleAttribute("hidden",N.access=="granted"&&!N.ports?.length||X()&&N.access=="unavailable"),document.getElementById("menu-connect-item-computer-keyboard").toggleAttribute("checked",o.pc_keyboard_connected),document.getElementById("menu-connect-item-touch").toggleAttribute("checked",M.enabled),N.access!="granted"){N.clearMenuItems();return}let t=document.getElementById("menu-connect-item-midi-port-template");for(let n of N.ports??[])if(!N.menu_items.some(s=>n.name==s.value)){let s=jt(t,{value:n.name},n.name);s.addEventListener("click",i=>{gt(i.currentTarget.value,!0)}),l.menus.connect.insertBefore(s,e)}for(let n of N.menu_items??[])N.ports.some(s=>n.value==s.name)?n.toggleAttribute("checked",n.value==N.connected_port?.name):n.remove()}l.dropdowns.connect.addEventListener("sl-show",()=>{Oe(),N.setWatchdog(500),N.queryAccess(e=>{e!="granted"&&Oe(),["granted","prompt"].includes(e)&&N.requestAccess(t=>{Oe(),t&&N.requestPorts(Oe)})})});l.dropdowns.connect.addEventListener("sl-hide",()=>{N.setWatchdog(2e3),U()});l.dropdowns.sound.addEventListener("sl-show",_o);l.dropdowns.size.addEventListener("sl-show",Ht);l.dropdowns.colors.addEventListener("sl-show",go);l.dropdowns.pedals.addEventListener("sl-show",Kt);l.dropdowns.labels.addEventListener("sl-show",tt);l.dropdowns.stickers.addEventListener("sl-show",Nt);l.dropdowns.transpose.addEventListener("sl-show",bo);for(let e of l.dropdowns.all)e.addEventListener("sl-show",t=>{t.currentTarget.querySelector("sl-button").setAttribute("variant","neutral")}),e.addEventListener("sl-hide",t=>{let n=t.currentTarget.querySelector("sl-button");n.setAttribute("variant","default"),n.blur()});document.getElementById("menu-connect-item-computer-keyboard").addEventListener("click",()=>{mn(),P()});document.getElementById("menu-connect-item-touch").addEventListener("click",()=>{_n(),P()});function xo(e=null,t=null){if(_.stopAll(!0),!e)_.player&&(_.player=null),_.loaded=!1,_.led=0,_.type="",U();else if(_.type!=e){t||(t=l.dropdowns.sound.querySelector(`.menu-sound-item[value="${e}"]`)),_.audio_ctx||(_.audio_ctx=new AudioContext);let n={apiano:{loader:_.apiano,options:{volume:90}},epiano1:{loader:_.epiano,options:{instrument:"TX81Z",volume:127}},epiano2:{loader:_.epiano,options:{instrument:"WurlitzerEP200",volume:70}},epiano3:{loader:_.epiano,options:{instrument:"CP80",volume:70}},harpsi:{loader:_.versilian,options:{instrument:"Chordophones/Zithers/Harpsichord, Unk",volume:100}}}[e];n.storage=_.cache,_.player=new n.loader(_.audio_ctx,n.options),_.loaded=!1,_.led=1,t.toggleAttribute("loading",!0),_.type=e,U();let s=setInterval(()=>{_.led=_.led==0?1:0,U()},400),i=r=>{clearInterval(s),_.loaded=r,_.led=r?2:0,t.toggleAttribute("loading",!1),U(),_o()};_.player.load.then(()=>{i(!0),_.audio_ctx.resume(),P()},r=>{_.player=null,_.type="",i(!1),_.fail_alert.children[1].innerText=`Reason: ${r}`,_.fail_alert.toast()})}}l.menus.sound.addEventListener("sl-select",e=>{xo(e.detail.item.value,e.detail.item),P()});l.dropdowns.size.querySelectorAll(".btn-number-of-keys").forEach(e=>{e.addEventListener("click",t=>{Qe(parseInt(t.currentTarget.value)),X()&&l.dropdowns.size.hide()})});l.dropdowns.size.querySelectorAll(".btn-key-depth").forEach(e=>{e.addEventListener("click",t=>{yo(parseFloat(t.currentTarget.value)),X()&&l.dropdowns.size.hide()})});l.menus.colors.highlight_opacity.addEventListener("sl-select",e=>{o.highlight_opacity=e.detail.item.value,P(),go()});l.menus.colors.item_perspective.addEventListener("click",()=>{o.perspective=!o.perspective,rt(),P(),X()&&l.dropdowns.colors.hide()});l.menus.colors.item_top_felt.addEventListener("click",()=>{o.top_felt=!o.top_felt,po(),P(),X()&&l.dropdowns.colors.hide()});l.menus.colors.picker_color_white.addEventListener("sl-change",e=>{o.color_white=e.target.value,P()});l.menus.colors.picker_color_black.addEventListener("sl-change",e=>{o.color_black=e.target.value,P()});l.menus.colors.picker_color_pressed.addEventListener("sl-change",e=>{o.color_highlight=e.target.value,P()});l.menus.labels.presets.addEventListener("sl-select",e=>{Ye(e.detail.item.value),X()&&l.dropdowns.labels.hide()});l.menus.labels.type.addEventListener("sl-select",e=>{e.detail.item.value==l.menus.labels.octave.value?vo(e.detail.item.checked):De(e.detail.item.value),X()&&l.dropdowns.labels.hide()});l.menus.labels.top.addEventListener("sl-select",e=>{e.detail.item.id==l.menus.labels.labeling_mode.id?(yt(e.detail.item.checked),l.dropdowns.labels.hide()):e.detail.item.id==l.menus.labels.played.id&&(wo(e.detail.item.checked),X()&&l.dropdowns.labels.hide())});l.buttons.labels_left.addEventListener("click",()=>{yt()});l.menus.stickers.top.addEventListener("sl-select",e=>{e.detail.item.getAttribute("type")=="checkbox"&&(Pe(void 0,e.detail.item.value),l.dropdowns.stickers.hide()),P()});l.buttons.stickers_left.addEventListener("click",()=>{Pe()});l.menus.stickers.clear.addEventListener("click",e=>{ko()});l.menus.pedals.top.addEventListener("sl-select",e=>{let t=e.detail.item;switch(t.id){case"menu-pedal-follow":o.pedals=t.checked;break;case"menu-pedal-dim":o.pedal_dim=t.checked;break}l.menus.pedals.item_dim.toggleAttribute("disabled",!o.pedals),et(),J(),P(),X()&&l.dropdowns.pedals.hide()});l.menus.transpose.semitones.btn_plus.onclick=()=>{ie({semitones:1})};l.menus.transpose.semitones.btn_minus.onclick=()=>{ie({semitones:-1})};l.menus.transpose.octaves.btn_plus.onclick=()=>{ie({octaves:1})};l.menus.transpose.octaves.btn_minus.onclick=()=>{ie({octaves:-1})};l.menus.transpose.item_reset.onclick=()=>{ie({reset:!0}),X()&&l.dropdowns.transpose.hide()};l.buttons.panic.onclick=Dt;l.buttons.hide_toolbar.onclick=bt;l.buttons.show_toolbar.onclick=bt;l.title.onclick=()=>{document.getElementById("dialog-about").show()};window.addEventListener("keydown",Ln);function ct(){function e(){let i=N.ports.map((r,g)=>[r.name,()=>gt(r.name,!0),{checked:o.device_name==r.name}]);return i.push(["Computer keyboard",()=>gt("pckbd",!0),{checked:o.pc_keyboard_connected}]),i.push(["Touch or mouse",()=>gt("touch",!0),{checked:M.enabled}]),i}function t(){if(!o.transpose)return"not transposed";let i=`${o.semitones} semitone${o.semitones!=1?"s":""}`,r=`${o.octaves} octave${o.octaves!=1?"s":""}`;return`${i}, ${r}`}function n(){return o.height_factor==1?"Full":o.height_factor==.5?"1/2":"3/4"}let s=ho();return[["",[["&Control",e()],["&Transpose",[["[\u2191] Semitone up",()=>ie({semitones:1}),{noindex:!0,key:"arrowup"}],["[\u2193] Semitone down",()=>ie({semitones:-1}),{noindex:!0,key:"arrowdown"}],["[\u2192] Octave up",()=>ie({octaves:1}),{noindex:!0,key:"arrowright"}],["[\u2190] Octave down",()=>ie({octaves:-1}),{noindex:!0,key:"arrowleft"}],["&Reset",()=>ie({reset:!0}),{noindex:!0}],[`State: ${t()}`,null]]],["&Size",[["&88 keys",()=>Qe(88),{noindex:!0,checked:o.number_of_keys==88}],["&61 keys",()=>Qe(61),{noindex:!0,checked:o.number_of_keys==61}],["&49 keys",()=>Qe(49),{noindex:!0,checked:o.number_of_keys==49}],["&37 keys",()=>Qe(37),{noindex:!0,checked:o.number_of_keys==37}],["&25 keys",()=>Qe(25),{noindex:!0,checked:o.number_of_keys==25}],[`Change key &depth (current: ${n()})`,()=>dn(),{noindex:!0}]]],["&Pedals",[["&Follow pedals",()=>un(),{checked:o.pedals}],["&Dim pedalized notes",()=>hn(),{checked:o.pedal_dim}]]],["&Labels",[["&Toggle Labeling mode (F2)",()=>yt(),{checked:W=="label"}],["&Show on played keys",()=>wo(),{checked:o.labels.played}],["&Presets",[["&None",()=>Ye("none"),{checked:s=="none"}],["&Middle-C",()=>Ye("mc"),{checked:s=="mc"}],["&C-keys",()=>Ye("cs"),{checked:s=="cs"}],["&White keys",()=>Ye("white"),{checked:s=="white"}],["&All keys",()=>Ye("all"),{checked:s=="all"}]]],["&Format",[["&English",()=>De("english"),{checked:o.labels.type=="english"}],["&German",()=>De("german"),{checked:o.labels.type=="german"}],["&Italian",()=>De("italian"),{checked:o.labels.type=="italian"}],["&Pitch-class",()=>De("pc"),{checked:o.labels.type=="pc"}],["&MIDI value",()=>De("midi"),{checked:o.labels.type=="midi"}],["&Frequency",()=>De("freq"),{checked:o.labels.type=="freq"}],["Show &octave",()=>vo(),{checked:o.labels.octave}]]]]],["Stic&kers",[["&Red",()=>Pe(void 0,"red"),{checked:W=="sticker"&&o.stickers.color=="red"}],["&Yellow",()=>Pe(void 0,"yellow"),{checked:W=="sticker"&&o.stickers.color=="yellow"}],["&Green",()=>Pe(void 0,"green"),{checked:W=="sticker"&&o.stickers.color=="green"}],["&Blue",()=>Pe(void 0,"blue"),{checked:W=="sticker"&&o.stickers.color=="blue"}],["&Violet",()=>Pe(void 0,"violet"),{checked:W=="sticker"&&o.stickers.color=="violet"}],["&Clear",()=>ko()]]],["Panic!",Dt],[`${o.toolbar?"Hide":"Show"} toolbar [<u>F9</u>]`,bt,{key:"f9"}]]]]}var ge=new io(document.getElementById("keyboard-navigator"),ct());ge.onmenuenter=e=>{N.setWatchdog(e=="Control"?500:2e3),ge.replaceStructure(ct())};ge.onoptionenter=()=>ge.replaceStructure(ct());ge.onshow=()=>N.setWatchdog(2e3);ge.onhide=()=>N.setWatchdog(2e3);f.svg.oncontextmenu=e=>{Q.state>0&&e.preventDefault(),Q.state=0};f.svg.addEventListener("pointerdown",e=>{l.dropdowns.closeAll(),(e.pointerType!="touch"&&e.button!=0||!M.enabled)&&(!W||e.button!=0)&&(Q.state=1,Q.origin.x=e.screenX,Q.origin.y=e.screenY,Q.previous_offset.x=o.offset.x,Q.previous_offset.y=o.offset.y,f.svg.setPointerCapture(e.pointerId),$e())},{capture:!0,passive:!1});f.svg.addEventListener("pointerup",e=>{e.pointerType!="touch"&&Q.state&&(Q.state=Q.state==2&&e.button==2?3:0,f.svg.releasePointerCapture(e.pointerId),ze(),$e(),P())},{capture:!0,passive:!1});f.svg.addEventListener("pointermove",e=>{if(e.pointerType!="touch"&&Q.state){let n=f.svg.getBoundingClientRect(),s=f.container.getBoundingClientRect();Q.state=2;let r=(e.screenX-Q.origin.x)/(n.width-s.width);o.offset.x=Ne(Q.previous_offset.x-r,0,1);let g=f.container.clientHeight/f.svg.clientHeight;if(o.zoom<g-(g-1)/10){let R=(e.screenY-Q.origin.y)/(s.height-n.height);o.offset.y=Ne(Q.previous_offset.y+R,0,1),e.ctrlKey||(o.offset.y<.06&&(o.offset.y=0),o.offset.y>1-.06&&(o.offset.y=1),Math.abs(.5-o.offset.y)<.06&&(o.offset.y=.5))}ze(),$e()}},{capture:!1,passive:!0});f.container.addEventListener("wheel",e=>{if(e.preventDefault(),!Q.state&&!M.started()&&!e.ctrlKey){let t=-e.deltaY/(e.deltaY<=0?1e3:500),n=f.container.clientHeight/f.svg.clientHeight,s=Ne(o.zoom+t,1,n);if(o.zoom!=s){let r=f.svg.getBoundingClientRect(),g=f.container.getBoundingClientRect(),m=Math.round(g.width*s);o.offset.x=(e.clientX-(e.clientX-r.left)/r.width*m-g.left)/(g.width-m),o.zoom=s}let i=e.deltaX/1e3;i&&(o.offset.x=Ne(o.offset.x-i,0,1)),ze()}},{capture:!1,passive:!1});X()||(_t=null,f.container.addEventListener("pointermove",e=>{e.pointerType!="touch"&&(_t&&clearTimeout(_t),l.buttons.show_toolbar.toggleAttribute("visible",!0),f.container.toggleAttribute("cursor-hidden",!1),f.svg.toggleAttribute("cursor-hidden",!1),_t=setTimeout(()=>{l.buttons.show_toolbar.toggleAttribute("visible",!1),M.enabled||(f.container.toggleAttribute("cursor-hidden",!0),f.svg.toggleAttribute("cursor-hidden",!0))},4e3))},{capture:!1,passive:!0}));var _t;function Be(e,t){let n=document.elementFromPoint(e,t)?.parentElement;return n?.classList.contains("key")?parseInt(n.getAttribute("value")):null}function Eo(e,t,n,s,i){let r=Vt(i),g=Math.sin(r),m=Math.cos(r);At()&&(n/=10,s/=10);let[R,B]=n>=s?[e+n*m,t+n*g]:[e-s*g,t+s*m],[D,y]=n>=s?[e-n*m,t-n*g]:[e+s*g,t-s*m],[G,V]=n>=s?[e-s*g,t+s*m]:[e+n*m,t+n*g],[ee,te]=n>=s?[e+s*g,t-s*m]:[e-n*m,t-n*g],me=Be(R,B),ue=Be(D,y),we=Be(G,V),be=Be(ee,te),Ie=new Set([me,ue,we,be]),ve=Math.min(me,ue,we,be),he=Math.max(me,ue,we,be),xe=he-ve;if(xe>1){let[ye,j]=ve==me?[R,B]:ve==ue?[D,y]:ve==we?[G,V]:[ee,te],[Ee,d]=he==me?[R,B]:he==ue?[D,y]:he==we?[G,V]:[ee,te],Me=(Ee-ye)/xe,qe=(d-j)/xe;for(let Le=.5;Le<xe;Le+=.5){let[ot,at]=[ye+Me*Le,j+qe*Le],He=Be(ot,at);Ie.add(He)}}return Ie.delete(null),Ie}function gn(e){if(l.dropdowns.closeAll(),e.pointerType!="touch"&&M.enabled&&!W&&e.button===0&&!M.started(e.pointerId)){let t=Be(e.clientX,e.clientY);t&&(e.preventDefault(),M.add(e.pointerId,new Set([t])))}}function Lo(e){e.pointerType!="touch"&&M.started(e.pointerId)&&e.button===0&&(M.remove(e.pointerId),e.preventDefault())}function bn(e){if(e.pointerType!="touch"&&M.started(e.pointerId)){e.preventDefault();let t=Be(e.clientX,e.clientY);M.change(e.pointerId,new Set([t]))}}function yn(e){if(M.enabled&&!W){for(let t of e.changedTouches)if(!M.started(t.identifier)){let n=Eo(t.clientX,t.clientY,t.radiusX,t.radiusY,t.rotationAngle);n.size&&(M.add(t.identifier,n),navigator.vibrate(40),e.preventDefault())}}}function Ao(e){for(let t of e.changedTouches)M.started(t.identifier)&&(M.remove(t.identifier),e.preventDefault())}function kn(e){for(let t of e.changedTouches)if(M.started(t.identifier)){e.preventDefault();let n=Eo(t.clientX,t.clientY,t.radiusX,t.radiusY,t.rotationAngle);M.change(t.identifier,n)==1&&navigator.vibrate(40)}}f.svg.addEventListener("pointerdown",gn,{capture:!0,passive:!1});f.svg.addEventListener("touchstart",yn,{capture:!0,passive:!1});window.addEventListener("pointerup",Lo,{capture:!1,passive:!1});window.addEventListener("pointercancel",Lo,{capture:!1,passive:!1});window.addEventListener("touchend",Ao,{capture:!1,passive:!1});window.addEventListener("touchcancel",Ao,{capture:!1,passive:!1});window.addEventListener("pointermove",bn,{capture:!1,passive:!1});window.addEventListener("touchmove",kn,{capture:!1,passive:!1});function wn(e){if(e.button===0){let t=Be(e.clientX,e.clientY);if(t){let n=e.ctrlKey?Array.from(Ve(t%12,128,12)):[t];if(W=="label"){let s=!o.labels.keys.has(t);for(let i of n)o.labels.toggle(i,s)}else if(W=="sticker"){let s=!o.stickers.keys.has(t);for(let i of n)o.stickers.toggle(i,s)}}}}f.svg.addEventListener("click",wn,{capture:!1,passive:!0});function So(e,t){Tt(e),_.play(e,t)}function Co(e,t,n){n&&n<100?setTimeout(()=>Tt(e),100-n):Tt(e),_.stop(e,!1)}function vn(){J(),_.stopAll(!1),et()}function xn(e){e>63&&e<68&&(J(),_.stopAll(!1),et())}function En(){J(),_.stopAll(!0),et()}A.onConnectionChange=()=>{J(),U()};A.onKeyPress=So;A.onKeyRelease=Co;A.onControlChange=xn;Y.onKeyPress=So;Y.onKeyRelease=Co;Y.onSustain=vn;Y.onReset=En;function Io(){let e=l.dropdowns.connect.open;N.queryAccess(t=>{t=="granted"?(ge.visible&&ge.replaceStructure(ct()),N.requestPorts(n=>{if(N.ports=n,o.device_name&&o.device_name!="pckbd"&&o.device_name!="touch"){if(!A.getConnectedPort()){let i=n.find(r=>r.name==o.device_name);i&&A.connect(i,()=>{U(),e&&Oe()})}U()}e&&Oe()})):(A.disconnect(),U(),e&&Oe())})}function Ln(e){if(e.repeat)return;if(e.key=="Alt"){let i=l.dropdowns.getOpen();i&&(i.hide(),i.querySelector("sl-button[slot=trigger]").blur())}let t=new Map([["f2",yt],["f3",Pe],["f9",bt],["escape",()=>{let i=l.dropdowns.getOpen();i?(i.hide(),i.querySelector("sl-button[slot=trigger]").blur()):W?Ot(null):Dt()}],["pageup",()=>ie({semitones:1})],["pagedown",()=>ie({semitones:-1})],["shift+pageup",()=>ie({octaves:1})],["shift+pagedown",()=>ie({octaves:-1})]]),n=[];e.ctrlKey&&n.push("ctrl"),e.altKey&&n.push("alt"),e.shiftKey&&n.push("shift"),n.push(e.key.toLowerCase());let s=n.join("+");t.has(s)&&(e.preventDefault(),t.get(s)())}function An(){l.resize.timeout&&clearTimeout(l.resize.timeout),l.resize_timeout=setTimeout(()=>{mo(),l.resize.timeout=null},o.lowperf?50:5)}function Sn(){f.resize.timeout&&clearTimeout(f.resize.timeout),f.resize_timeout=setTimeout(()=>{ze(),f.resize.timeout=null},o.lowperf?50:5)}function Cn(){if(pn(),fn(),X()&&(document.documentElement.classList.add("mobile"),l.buttons.show_toolbar.classList.add("mobile"),l.buttons.panic.parentElement.toggleAttribute("disabled",!0),l.buttons.hide_toolbar.parentElement.toggleAttribute("disabled",!0),l.buttons.show_toolbar.parentElement.toggleAttribute("disabled",!0),l.menus.size.querySelector('.btn-number-of-keys[value="20"]').toggleAttribute("hidden",!1)),At()?l.dropdowns.sound.toggleAttribute("hidden",!0):import("https://unpkg.com/smplr@0.16.1/dist/index.mjs").then(t=>{_.cache=new t.CacheStorage("sound_v1"),_.apiano=t.SplendidGrandPiano,_.epiano=t.ElectricPiano,_.versilian=t.Versilian,document.getElementById("menu-sound-item-unavailable").hidden=!0,l.menus.sound.querySelectorAll(".menu-sound-item").forEach(n=>{n.hidden=!1}),X()&&o.sound&&xo(o.sound)}),U(),rt(),o.device_name)["pckbd","touch"].includes(o.device_name)?Je(o.device_name):N.queryAccess(t=>{t=="granted"&&Je(o.device_name)});else{let t=document.getElementById("dropdown-connect-tooltip");X()?(Je("touch",!0),t.setAttribute("content","Play your keyboard using your fingers! Or change the input method by tapping this button.")):t.setAttribute("content","Click on this button to select an input method."),t.open=!0,window.addEventListener("click",()=>{t.open=!1},{once:!0})}function e(){mo(),l.resize.observer=new ResizeObserver(An),l.resize.observer.observe(l.self),ze(),f.resize.observer=new ResizeObserver(Sn),f.resize.observer.observe(f.container)}document.readyState!="complete"?window.addEventListener("load",e,{once:!0}):e(),Io(),N.setWatchdog(2e3)}Promise.allSettled([customElements.whenDefined("sl-dropdown"),customElements.whenDefined("sl-button"),customElements.whenDefined("sl-button-group"),customElements.whenDefined("sl-icon"),customElements.whenDefined("sl-menu"),customElements.whenDefined("sl-menu-item")]).finally(Cn);})();
